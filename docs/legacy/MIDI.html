<!doctype html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />

  
  <title>tegridymidi.legacy.MIDI API documentation</title>
  <meta name="description" content="This module offers functions:  concatenate_scores(), grep(),
merge_scores(), mix_scores(), midi2opus..." />


  <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300' rel='stylesheet' type='text/css'>
  
  <style type="text/css">
* {
  box-sizing: border-box;
}
/*! normalize.css v1.1.1 | MIT License | git.io/normalize */

/* ==========================================================================
   HTML5 display definitions
   ========================================================================== */

/**
 * Correct `block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

article,
aside,
details,
figcaption,
figure,
footer,
header,
hgroup,
main,
nav,
section,
summary {
    display: block;
}

/**
 * Correct `inline-block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

audio,
canvas,
video {
    display: inline-block;
    *display: inline;
    *zoom: 1;
}

/**
 * Prevent modern browsers from displaying `audio` without controls.
 * Remove excess height in iOS 5 devices.
 */

audio:not([controls]) {
    display: none;
    height: 0;
}

/**
 * Address styling not present in IE 7/8/9, Firefox 3, and Safari 4.
 * Known issue: no IE 6 support.
 */

[hidden] {
    display: none;
}

/* ==========================================================================
   Base
   ========================================================================== */

/**
 * 1. Prevent system color scheme's background color being used in Firefox, IE,
 *    and Opera.
 * 2. Prevent system color scheme's text color being used in Firefox, IE, and
 *    Opera.
 * 3. Correct text resizing oddly in IE 6/7 when body `font-size` is set using
 *    `em` units.
 * 4. Prevent iOS text size adjust after orientation change, without disabling
 *    user zoom.
 */

html {
    background: #fff; /* 1 */
    color: #000; /* 2 */
    font-size: 100%; /* 3 */
    -webkit-text-size-adjust: 100%; /* 4 */
    -ms-text-size-adjust: 100%; /* 4 */
}

/**
 * Address `font-family` inconsistency between `textarea` and other form
 * elements.
 */

html,
button,
input,
select,
textarea {
    font-family: sans-serif;
}

/**
 * Address margins handled incorrectly in IE 6/7.
 */

body {
    margin: 0;
}

/* ==========================================================================
   Links
   ========================================================================== */

/**
 * Address `outline` inconsistency between Chrome and other browsers.
 */

a:focus {
    outline: thin dotted;
}

/**
 * Improve readability when focused and also mouse hovered in all browsers.
 */

a:active,
a:hover {
    outline: 0;
}

/* ==========================================================================
   Typography
   ========================================================================== */

/**
 * Address font sizes and margins set differently in IE 6/7.
 * Address font sizes within `section` and `article` in Firefox 4+, Safari 5,
 * and Chrome.
 */

h1 {
    font-size: 2em;
    margin: 0.67em 0;
}

h2 {
    font-size: 1.5em;
    margin: 0.83em 0;
}

h3 {
    font-size: 1.17em;
    margin: 1em 0;
}

h4 {
    font-size: 1em;
    margin: 1.33em 0;
}

h5 {
    font-size: 0.83em;
    margin: 1.67em 0;
}

h6 {
    font-size: 0.67em;
    margin: 2.33em 0;
}

/**
 * Address styling not present in IE 7/8/9, Safari 5, and Chrome.
 */

abbr[title] {
    border-bottom: 1px dotted;
}

/**
 * Address style set to `bolder` in Firefox 3+, Safari 4/5, and Chrome.
 */

b,
strong {
    font-weight: bold;
}

blockquote {
    margin: 1em 40px;
}

/**
 * Address styling not present in Safari 5 and Chrome.
 */

dfn {
    font-style: italic;
}

/**
 * Address differences between Firefox and other browsers.
 * Known issue: no IE 6/7 normalization.
 */

hr {
    -moz-box-sizing: content-box;
    box-sizing: content-box;
    height: 0;
}

/**
 * Address styling not present in IE 6/7/8/9.
 */

mark {
    background: #ff0;
    color: #000;
}

/**
 * Address margins set differently in IE 6/7.
 */

p,
pre {
    margin: 1em 0;
}

/**
 * Correct font family set oddly in IE 6, Safari 4/5, and Chrome.
 */

code,
kbd,
pre,
samp {
    font-family: monospace, serif;
    _font-family: 'courier new', monospace;
    font-size: 1em;
}

/**
 * Improve readability of pre-formatted text in all browsers.
 */

pre {
    white-space: pre;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/**
 * Address CSS quotes not supported in IE 6/7.
 */

q {
    quotes: none;
}

/**
 * Address `quotes` property not supported in Safari 4.
 */

q:before,
q:after {
    content: '';
    content: none;
}

/**
 * Address inconsistent and variable font size in all browsers.
 */

small {
    font-size: 80%;
}

/**
 * Prevent `sub` and `sup` affecting `line-height` in all browsers.
 */

sub,
sup {
    font-size: 75%;
    line-height: 0;
    position: relative;
    vertical-align: baseline;
}

sup {
    top: -0.5em;
}

sub {
    bottom: -0.25em;
}

/* ==========================================================================
   Lists
   ========================================================================== */

/**
 * Address margins set differently in IE 6/7.
 */

dl,
menu,
ol,
ul {
    margin: 1em 0;
}

dd {
    margin: 0 0 0 40px;
}

/**
 * Address paddings set differently in IE 6/7.
 */

menu,
ol,
ul {
    padding: 0 0 0 40px;
}

/**
 * Correct list images handled incorrectly in IE 7.
 */

nav ul,
nav ol {
    list-style: none;
    list-style-image: none;
}

/* ==========================================================================
   Embedded content
   ========================================================================== */

/**
 * 1. Remove border when inside `a` element in IE 6/7/8/9 and Firefox 3.
 * 2. Improve image quality when scaled in IE 7.
 */

img {
    border: 0; /* 1 */
    -ms-interpolation-mode: bicubic; /* 2 */
}

/**
 * Correct overflow displayed oddly in IE 9.
 */

svg:not(:root) {
    overflow: hidden;
}

/* ==========================================================================
   Figures
   ========================================================================== */

/**
 * Address margin not present in IE 6/7/8/9, Safari 5, and Opera 11.
 */

figure {
    margin: 0;
}

/* ==========================================================================
   Forms
   ========================================================================== */

/**
 * Correct margin displayed oddly in IE 6/7.
 */

form {
    margin: 0;
}

/**
 * Define consistent border, margin, and padding.
 */

fieldset {
    border: 1px solid #c0c0c0;
    margin: 0 2px;
    padding: 0.35em 0.625em 0.75em;
}

/**
 * 1. Correct color not being inherited in IE 6/7/8/9.
 * 2. Correct text not wrapping in Firefox 3.
 * 3. Correct alignment displayed oddly in IE 6/7.
 */

legend {
    border: 0; /* 1 */
    padding: 0;
    white-space: normal; /* 2 */
    *margin-left: -7px; /* 3 */
}

/**
 * 1. Correct font size not being inherited in all browsers.
 * 2. Address margins set differently in IE 6/7, Firefox 3+, Safari 5,
 *    and Chrome.
 * 3. Improve appearance and consistency in all browsers.
 */

button,
input,
select,
textarea {
    font-size: 100%; /* 1 */
    margin: 0; /* 2 */
    vertical-align: baseline; /* 3 */
    *vertical-align: middle; /* 3 */
}

/**
 * Address Firefox 3+ setting `line-height` on `input` using `!important` in
 * the UA stylesheet.
 */

button,
input {
    line-height: normal;
}

/**
 * Address inconsistent `text-transform` inheritance for `button` and `select`.
 * All other form control elements do not inherit `text-transform` values.
 * Correct `button` style inheritance in Chrome, Safari 5+, and IE 6+.
 * Correct `select` style inheritance in Firefox 4+ and Opera.
 */

button,
select {
    text-transform: none;
}

/**
 * 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio`
 *    and `video` controls.
 * 2. Correct inability to style clickable `input` types in iOS.
 * 3. Improve usability and consistency of cursor style between image-type
 *    `input` and others.
 * 4. Remove inner spacing in IE 7 without affecting normal text inputs.
 *    Known issue: inner spacing remains in IE 6.
 */

button,
html input[type="button"], /* 1 */
input[type="reset"],
input[type="submit"] {
    -webkit-appearance: button; /* 2 */
    cursor: pointer; /* 3 */
    *overflow: visible;  /* 4 */
}

/**
 * Re-set default cursor for disabled elements.
 */

button[disabled],
html input[disabled] {
    cursor: default;
}

/**
 * 1. Address box sizing set to content-box in IE 8/9.
 * 2. Remove excess padding in IE 8/9.
 * 3. Remove excess padding in IE 7.
 *    Known issue: excess padding remains in IE 6.
 */

input[type="checkbox"],
input[type="radio"] {
    box-sizing: border-box; /* 1 */
    padding: 0; /* 2 */
    *height: 13px; /* 3 */
    *width: 13px; /* 3 */
}

/**
 * 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome.
 * 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome
 *    (include `-moz` to future-proof).
 */

input[type="search"] {
    -webkit-appearance: textfield; /* 1 */
    -moz-box-sizing: content-box;
    -webkit-box-sizing: content-box; /* 2 */
    box-sizing: content-box;
}

/**
 * Remove inner padding and search cancel button in Safari 5 and Chrome
 * on OS X.
 */

input[type="search"]::-webkit-search-cancel-button,
input[type="search"]::-webkit-search-decoration {
    -webkit-appearance: none;
}

/**
 * Remove inner padding and border in Firefox 3+.
 */

button::-moz-focus-inner,
input::-moz-focus-inner {
    border: 0;
    padding: 0;
}

/**
 * 1. Remove default vertical scrollbar in IE 6/7/8/9.
 * 2. Improve readability and alignment in all browsers.
 */

textarea {
    overflow: auto; /* 1 */
    vertical-align: top; /* 2 */
}

/* ==========================================================================
   Tables
   ========================================================================== */

/**
 * Remove most spacing between table cells.
 */

table {
    border-collapse: collapse;
    border-spacing: 0;
}
</style>
  <style type="text/css">
  html, body {
    margin: 0;
    padding: 0;
    min-height: 100%;
  }
  body {
    background: #fff;
    font-family: "Source Sans Pro", "Helvetica Neueue", Helvetica, sans;
    font-weight: 300;
    font-size: 16px;
    line-height: 1.6em;
  }
  #content {
    width: 70%;
    max-width: 850px;
    float: left;
    padding: 30px 60px;
    border-left: 1px solid #ddd;
  }
  #sidebar {
    width: 25%;
    float: left;
    padding: 30px;
    overflow: hidden;
  }
  #nav {
    font-size: 130%;
    margin: 0 0 15px 0;
  }

  #top {
    display: block;
    position: fixed;
    bottom: 5px;
    left: 5px;
    font-size: .85em;
    text-transform: uppercase;
  }

  #footer {
    font-size: .75em;
    padding: 5px 30px;
    border-top: 1px solid #ddd;
    text-align: right;
  }
    #footer p {
      margin: 0 0 0 30px;
      display: inline-block;
    }

  h1, h2, h3, h4, h5 {
    font-weight: 300;
  }
  h1 {
    font-size: 2.5em;
    line-height: 1.1em;
    margin: 0 0 .50em 0;
  }

  h2 {
    font-size: 1.75em;
    margin: 1em 0 .50em 0;
  }

  h3 {
    margin: 25px 0 10px 0;
  }

  h4 {
    margin: 0;
    font-size: 105%;
  }

  a {
    color: #058;
    text-decoration: none;
    transition: color .3s ease-in-out;
  }

  a:hover {
    color: #e08524;
    transition: color .3s ease-in-out;
  }

  pre, code, .mono, .name {
    font-family: "Ubuntu Mono", "Cousine", "DejaVu Sans Mono", monospace;
  }

  .title .name {
    font-weight: bold;
  }
  .section-title {
    margin-top: 2em;
  }
  .ident {
    color: #900;
  }

  code {
    background: #f9f9f9;
  } 

  pre {
    background: #fefefe;
    border: 1px solid #ddd;
    box-shadow: 2px 2px 0 #f3f3f3;
    margin: 0 30px;
    padding: 15px 30px;
  }

  .codehilite {
    margin: 0 30px 10px 30px;
  }

    .codehilite pre {
      margin: 0;
    }
    .codehilite .err { background: #ff3300; color: #fff !important; } 

  table#module-list {
    font-size: 110%;
  }

    table#module-list tr td:first-child {
      padding-right: 10px;
      white-space: nowrap;
    }

    table#module-list td {
      vertical-align: top;
      padding-bottom: 8px;
    }

      table#module-list td p {
        margin: 0 0 7px 0;
      }

  .def {
    display: table;
  }

    .def p {
      display: table-cell;
      vertical-align: top;
      text-align: left;
    }

    .def p:first-child {
      white-space: nowrap;
    }

    .def p:last-child {
      width: 100%;
    }


  #index {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }
    ul#index .class_name {
      /* font-size: 110%; */
      font-weight: bold;
    }
    #index ul {
      margin: 0;
    }

  .item {
    margin: 0 0 15px 0;
  }

    .item .class {
      margin: 0 0 25px 30px;
    }

      .item .class ul.class_list {
        margin: 0 0 20px 0;
      }

    .item .name {
      background: #fafafa;
      margin: 0;
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 3px;
      display: inline-block;
      min-width: 40%;
    }
      .item .name:hover {
        background: #f6f6f6;
      }

    .item .empty_desc {
      margin: 0 0 5px 0;
      padding: 0;
    }

    .item .inheritance {
      margin: 3px 0 0 30px;
    }

    .item .inherited {
      color: #666;
    }

    .item .desc {
      padding: 0 8px;
      margin: 0;
    }

      .item .desc p {
        margin: 0 0 10px 0;
      }

    .source_cont {
      margin: 0;
      padding: 0;
    }

    .source_link a {
      background: #ffc300;
      font-weight: 400;
      font-size: .75em;
      text-transform: uppercase;
      color: #fff;
      text-shadow: 1px 1px 0 #f4b700;
      
      padding: 3px 8px;
      border-radius: 2px;
      transition: background .3s ease-in-out;
    }
      .source_link a:hover {
        background: #FF7200;
        text-shadow: none;
        transition: background .3s ease-in-out;
      }

    .source {
      display: none;
      max-height: 600px;
      overflow-y: scroll;
      margin-bottom: 15px;
    }

      .source .codehilite {
        margin: 0;
      }

  .desc h1, .desc h2, .desc h3 {
    font-size: 100% !important;
  }
  .clear {
    clear: both;
  }

  @media all and (max-width: 950px) {
    #sidebar {
      width: 35%;
    }
    #content {
      width: 65%;
    }
  }
  @media all and (max-width: 650px) {
    #top {
      display: none;
    }
    #sidebar {
      float: none;
      width: auto;
    }
    #content {
      float: none;
      width: auto;
      padding: 30px;
    }

    #index ul {
      padding: 0;
      margin-bottom: 15px;
    }
    #index ul li {
      display: inline-block;
      margin-right: 30px;
    }
    #footer {
      text-align: left;
    }
    #footer p {
      display: block;
      margin: inherit;
    }
  }

  /*****************************/
</style>
  <style type="text/css">
  pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.codehilite .hll { background-color: #ffffcc }
.codehilite { background: #f8f8f8; }
.codehilite .c { color: #3D7B7B; font-style: italic } /* Comment */
.codehilite .err { border: 1px solid #FF0000 } /* Error */
.codehilite .k { color: #008000; font-weight: bold } /* Keyword */
.codehilite .o { color: #666666 } /* Operator */
.codehilite .ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
.codehilite .cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
.codehilite .cp { color: #9C6500 } /* Comment.Preproc */
.codehilite .cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
.codehilite .c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
.codehilite .cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
.codehilite .gd { color: #A00000 } /* Generic.Deleted */
.codehilite .ge { font-style: italic } /* Generic.Emph */
.codehilite .ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
.codehilite .gr { color: #E40000 } /* Generic.Error */
.codehilite .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.codehilite .gi { color: #008400 } /* Generic.Inserted */
.codehilite .go { color: #717171 } /* Generic.Output */
.codehilite .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.codehilite .gs { font-weight: bold } /* Generic.Strong */
.codehilite .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.codehilite .gt { color: #0044DD } /* Generic.Traceback */
.codehilite .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.codehilite .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.codehilite .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.codehilite .kp { color: #008000 } /* Keyword.Pseudo */
.codehilite .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.codehilite .kt { color: #B00040 } /* Keyword.Type */
.codehilite .m { color: #666666 } /* Literal.Number */
.codehilite .s { color: #BA2121 } /* Literal.String */
.codehilite .na { color: #687822 } /* Name.Attribute */
.codehilite .nb { color: #008000 } /* Name.Builtin */
.codehilite .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.codehilite .no { color: #880000 } /* Name.Constant */
.codehilite .nd { color: #AA22FF } /* Name.Decorator */
.codehilite .ni { color: #717171; font-weight: bold } /* Name.Entity */
.codehilite .ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
.codehilite .nf { color: #0000FF } /* Name.Function */
.codehilite .nl { color: #767600 } /* Name.Label */
.codehilite .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.codehilite .nt { color: #008000; font-weight: bold } /* Name.Tag */
.codehilite .nv { color: #19177C } /* Name.Variable */
.codehilite .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.codehilite .w { color: #bbbbbb } /* Text.Whitespace */
.codehilite .mb { color: #666666 } /* Literal.Number.Bin */
.codehilite .mf { color: #666666 } /* Literal.Number.Float */
.codehilite .mh { color: #666666 } /* Literal.Number.Hex */
.codehilite .mi { color: #666666 } /* Literal.Number.Integer */
.codehilite .mo { color: #666666 } /* Literal.Number.Oct */
.codehilite .sa { color: #BA2121 } /* Literal.String.Affix */
.codehilite .sb { color: #BA2121 } /* Literal.String.Backtick */
.codehilite .sc { color: #BA2121 } /* Literal.String.Char */
.codehilite .dl { color: #BA2121 } /* Literal.String.Delimiter */
.codehilite .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.codehilite .s2 { color: #BA2121 } /* Literal.String.Double */
.codehilite .se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
.codehilite .sh { color: #BA2121 } /* Literal.String.Heredoc */
.codehilite .si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
.codehilite .sx { color: #008000 } /* Literal.String.Other */
.codehilite .sr { color: #A45A77 } /* Literal.String.Regex */
.codehilite .s1 { color: #BA2121 } /* Literal.String.Single */
.codehilite .ss { color: #19177C } /* Literal.String.Symbol */
.codehilite .bp { color: #008000 } /* Name.Builtin.Pseudo */
.codehilite .fm { color: #0000FF } /* Name.Function.Magic */
.codehilite .vc { color: #19177C } /* Name.Variable.Class */
.codehilite .vg { color: #19177C } /* Name.Variable.Global */
.codehilite .vi { color: #19177C } /* Name.Variable.Instance */
.codehilite .vm { color: #19177C } /* Name.Variable.Magic */
.codehilite .il { color: #666666 } /* Literal.Number.Integer.Long */
  </style>
  <style type="text/css">
/* ==========================================================================
   EXAMPLE Media Queries for Responsive Design.
   These examples override the primary ('mobile first') styles.
   Modify as content requires.
   ========================================================================== */

@media only screen and (min-width: 35em) {
    /* Style adjustments for viewports that meet the condition */
}

@media print,
       (-o-min-device-pixel-ratio: 5/4),
       (-webkit-min-device-pixel-ratio: 1.25),
       (min-resolution: 120dpi) {
    /* Style adjustments for high resolution devices */
}

/* ==========================================================================
   Print styles.
   Inlined to avoid required HTTP connection: h5bp.com/r
   ========================================================================== */

@media print {
    * {
        background: transparent !important;
        color: #000 !important; /* Black prints faster: h5bp.com/s */
        box-shadow: none !important;
        text-shadow: none !important;
    }

    a,
    a:visited {
        text-decoration: underline;
    }

    a[href]:after {
        content: " (" attr(href) ")";
    }

    abbr[title]:after {
        content: " (" attr(title) ")";
    }

    /*
     * Don't show links for images, or javascript/internal links
     */

    .ir a:after,
    a[href^="javascript:"]:after,
    a[href^="#"]:after {
        content: "";
    }

    pre,
    blockquote {
        border: 1px solid #999;
        page-break-inside: avoid;
    }

    thead {
        display: table-header-group; /* h5bp.com/t */
    }

    tr,
    img {
        page-break-inside: avoid;
    }

    img {
        max-width: 100% !important;
    }

    @page {
        margin: 0.5cm;
    }

    p,
    h2,
    h3 {
        orphans: 3;
        widows: 3;
    }

    h2,
    h3 {
        page-break-after: avoid;
    }
}
</style>

  <script type="text/javascript">
  function toggle(id, $link) {
    $node = document.getElementById(id);
    if (!$node)
    return;
    if (!$node.style.display || $node.style.display == 'none') {
    $node.style.display = 'block';
    $link.innerHTML = 'Hide source &nequiv;';
    } else {
    $node.style.display = 'none';
    $link.innerHTML = 'Show source &equiv;';
    }
  }
  </script>
</head>
<body>
<a href="#" id="top">Top</a>
<div id="container">
  


















  
  <div id="sidebar">
    <h1>Index</h1>
    <ul id="index">
    <li class="set"><h3>Super-module</h3>
      <ul>
        <li class="mono"><a href="index.html">tegridymidi.legacy</a></li>
      </ul>
    </li>
    <li class="set"><h3><a href="#header-variables">Module variables</a></h3>
      
  <ul>
    <li class="mono"><a href="#tegridymidi.legacy.MIDI.All_events">All_events</a></li>
    <li class="mono"><a href="#tegridymidi.legacy.MIDI.Event2channelindex">Event2channelindex</a></li>
    <li class="mono"><a href="#tegridymidi.legacy.MIDI.MIDI_events">MIDI_events</a></li>
    <li class="mono"><a href="#tegridymidi.legacy.MIDI.Meta_events">Meta_events</a></li>
    <li class="mono"><a href="#tegridymidi.legacy.MIDI.Nontext_meta_events">Nontext_meta_events</a></li>
    <li class="mono"><a href="#tegridymidi.legacy.MIDI.Notenum2percussion">Notenum2percussion</a></li>
    <li class="mono"><a href="#tegridymidi.legacy.MIDI.Number2patch">Number2patch</a></li>
    <li class="mono"><a href="#tegridymidi.legacy.MIDI.Text_events">Text_events</a></li>
    <li class="mono"><a href="#tegridymidi.legacy.MIDI.Version">Version</a></li>
    <li class="mono"><a href="#tegridymidi.legacy.MIDI.VersionDate">VersionDate</a></li>
    <li class="mono"><a href="#tegridymidi.legacy.MIDI.copy">copy</a></li>
    <li class="mono"><a href="#tegridymidi.legacy.MIDI.struct">struct</a></li>
    <li class="mono"><a href="#tegridymidi.legacy.MIDI.sys">sys</a></li>
  </ul>

    </li>

    <li class="set"><h3><a href="#header-functions">Functions</a></h3>
      
  <ul>
    <li class="mono"><a href="#tegridymidi.legacy.MIDI.concatenate_scores">concatenate_scores</a></li>
    <li class="mono"><a href="#tegridymidi.legacy.MIDI.event2alsaseq">event2alsaseq</a></li>
    <li class="mono"><a href="#tegridymidi.legacy.MIDI.grep">grep</a></li>
    <li class="mono"><a href="#tegridymidi.legacy.MIDI.merge_scores">merge_scores</a></li>
    <li class="mono"><a href="#tegridymidi.legacy.MIDI.midi2ms_score">midi2ms_score</a></li>
    <li class="mono"><a href="#tegridymidi.legacy.MIDI.midi2opus">midi2opus</a></li>
    <li class="mono"><a href="#tegridymidi.legacy.MIDI.midi2score">midi2score</a></li>
    <li class="mono"><a href="#tegridymidi.legacy.MIDI.mix_opus_tracks">mix_opus_tracks</a></li>
    <li class="mono"><a href="#tegridymidi.legacy.MIDI.mix_scores">mix_scores</a></li>
    <li class="mono"><a href="#tegridymidi.legacy.MIDI.opus2midi">opus2midi</a></li>
    <li class="mono"><a href="#tegridymidi.legacy.MIDI.opus2score">opus2score</a></li>
    <li class="mono"><a href="#tegridymidi.legacy.MIDI.play_score">play_score</a></li>
    <li class="mono"><a href="#tegridymidi.legacy.MIDI.score2midi">score2midi</a></li>
    <li class="mono"><a href="#tegridymidi.legacy.MIDI.score2opus">score2opus</a></li>
    <li class="mono"><a href="#tegridymidi.legacy.MIDI.score2stats">score2stats</a></li>
    <li class="mono"><a href="#tegridymidi.legacy.MIDI.score_type">score_type</a></li>
    <li class="mono"><a href="#tegridymidi.legacy.MIDI.segment">segment</a></li>
    <li class="mono"><a href="#tegridymidi.legacy.MIDI.timeshift">timeshift</a></li>
    <li class="mono"><a href="#tegridymidi.legacy.MIDI.to_millisecs">to_millisecs</a></li>
  </ul>

    </li>


    </ul>
  </div>

<article id="content">
  

  


  <header id="section-intro">
  <h1 class="title"><span class="name">tegridymidi.legacy.MIDI</span> module</h1>
  <p>This module offers functions:  concatenate_scores(), grep(),
merge_scores(), mix_scores(), midi2opus(), midi2score(), opus2midi(),
opus2score(), play_score(), score2midi(), score2opus(), score2stats(),
score_type(), segment(), timeshift() and to_millisecs(),
where "midi" means the MIDI-file bytes (as can be put in a .mid file,
or piped into aplaymidi), and "opus" and "score" are list-structures
as inspired by Sean Burke's MIDI-Perl CPAN module.</p>
<p>Warning: Version 6.4 is not necessarily backward-compatible with
previous versions, in that text-data is now bytes, not strings.
This reflects the fact that many MIDI files have text data in
encodings other that ISO-8859-1, for example in Shift-JIS.</p>
<p>Download MIDI.py from   http://www.pjb.com.au/midi/free/MIDI.py
and put it in your PYTHONPATH.  MIDI.py depends on Python3.</p>
<p>There is also a call-compatible translation into Lua of this
module: see http://www.pjb.com.au/comp/lua/MIDI.html</p>
<p>Backup web site: https://peterbillam.gitlab.io/miditools/</p>
<p>The "opus" is a direct translation of the midi-file-events, where
the times are delta-times, in ticks, since the previous event.</p>
<p>The "score" is more human-centric; it uses absolute times, and
combines the separate note_on and note_off events into one "note"
event, with a duration:
 ['note', start_time, duration, channel, note, velocity] # in a "score"</p>
<p>EVENTS (in an "opus" structure)
     ['note_off', dtime, channel, note, velocity]       # in an "opus"
     ['note_on', dtime, channel, note, velocity]        # in an "opus"
     ['key_after_touch', dtime, channel, note, velocity]
     ['control_change', dtime, channel, controller(0-127), value(0-127)]
     ['patch_change', dtime, channel, patch]
     ['channel_after_touch', dtime, channel, velocity]
     ['pitch_wheel_change', dtime, channel, pitch_wheel]
     ['text_event', dtime, text]
     ['copyright_text_event', dtime, text]
     ['track_name', dtime, text]
     ['instrument_name', dtime, text]
     ['lyric', dtime, text]
     ['marker', dtime, text]
     ['cue_point', dtime, text]
     ['text_event_08', dtime, text]
     ['text_event_09', dtime, text]
     ['text_event_0a', dtime, text]
     ['text_event_0b', dtime, text]
     ['text_event_0c', dtime, text]
     ['text_event_0d', dtime, text]
     ['text_event_0e', dtime, text]
     ['text_event_0f', dtime, text]
     ['end_track', dtime]
     ['set_tempo', dtime, tempo]
     ['smpte_offset', dtime, hr, mn, se, fr, ff]
     ['time_signature', dtime, nn, dd, cc, bb]
     ['key_signature', dtime, sf, mi]
     ['sequencer_specific', dtime, raw]
     ['raw_meta_event', dtime, command(0-255), raw]
     ['sysex_f0', dtime, raw]
     ['sysex_f7', dtime, raw]
     ['song_position', dtime, song_pos]
     ['song_select', dtime, song_number]
     ['tune_request', dtime]</p>
<p>DATA TYPES
     channel = a value 0 to 15
     controller = 0 to 127 (see http://www.pjb.com.au/muscript/gm.html#cc )
     dtime = time measured in "ticks", 0 to 268435455
     velocity = a value 0 (soft) to 127 (loud)
     note = a value 0 to 127  (middle-C is 60)
     patch = 0 to 127 (see http://www.pjb.com.au/muscript/gm.html )
     pitch_wheel = a value -8192 to 8191 (0x1FFF)
     raw = bytes, of length 0 or more  (for sysex events see below)
     sequence_number = a value 0 to 65,535 (0xFFFF)
     song_pos = a value 0 to 16,383 (0x3FFF)
     song_number = a value 0 to 127
     tempo = microseconds per crochet (quarter-note), 0 to 16777215
     text = bytes, of length 0 or more
     ticks = the number of ticks per crochet (quarter-note)</p>
<p>In sysex_f0 events, the raw data must not start with a \xF0 byte,
   since this gets added automatically;
   but it must end with an explicit \xF7 byte!
   In the very unlikely case that you ever need to split sysex data
   into one sysex_f0 followed by one or more sysex_f7s, then only the
   last of those sysex_f7 events must end with the explicit \xF7 byte
   (again, the raw data of individual sysex_f7 events must not start
   with any \xF7 byte, since this gets added automatically).</p>
<p>Since version 6.4, text data is in bytes, not in a ISO-8859-1 string.</p>
<p>GOING THROUGH A SCORE WITHIN A PYTHON PROGRAM
    channels = {2,3,5,8,13}
    itrack = 1   # skip 1st element which is ticks
    while itrack &lt; len(score):
        for event in score[itrack]:
            if event[0] == 'note':   # for example,
                pass  # do something to all notes
            # or, to work on events in only particular channels&hellip;
            channel_index = MIDI.Event2channelindex.get(event[0], False)
            if channel_index and (event[channel_index] in channels):
                pass  # do something to channels 2,3,5,8 and 13
        itrack += 1</p>
  
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-tegridymidi.legacy.MIDI', this);">Show source &equiv;</a></p>
  <div id="source-tegridymidi.legacy.MIDI" class="source">
    <div class="codehilite"><pre><span></span><span class="ch">#! /usr/bin/python3</span>
<span class="c1"># unsupported 20091104 ...</span>
<span class="c1">#     [&#39;set_sequence_number&#39;, dtime, sequence]</span>
<span class="c1">#     [&#39;raw_data&#39;, dtime, raw]</span>

<span class="c1"># 20150914   jimbo1qaz   MIDI.py str/bytes bug report</span>
<span class="c1"># I found a MIDI file which had Shift-JIS titles. When midi.py decodes it as</span>
<span class="c1"># latin-1, it produces a string which cannot even be accessed without raising</span>
<span class="c1"># a UnicodeDecodeError.  Maybe, when converting raw byte strings from MIDI,</span>
<span class="c1"># you should keep them as bytes, not improperly decode them.  However, this</span>
<span class="c1"># would change the API.  (ie: text = a &quot;string&quot; ? of 0 or more bytes).  It</span>
<span class="c1"># could break compatiblity, but there&#39;s not much else you can do to fix the bug</span>
<span class="c1"># https://en.wikipedia.org/wiki/Shift_JIS</span>

<span class="sa">r</span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">This module offers functions:  concatenate_scores(), grep(),</span>
<span class="sd">merge_scores(), mix_scores(), midi2opus(), midi2score(), opus2midi(),</span>
<span class="sd">opus2score(), play_score(), score2midi(), score2opus(), score2stats(),</span>
<span class="sd">score_type(), segment(), timeshift() and to_millisecs(),</span>
<span class="sd">where &quot;midi&quot; means the MIDI-file bytes (as can be put in a .mid file,</span>
<span class="sd">or piped into aplaymidi), and &quot;opus&quot; and &quot;score&quot; are list-structures</span>
<span class="sd">as inspired by Sean Burke&#39;s MIDI-Perl CPAN module.</span>

<span class="sd">Warning: Version 6.4 is not necessarily backward-compatible with</span>
<span class="sd">previous versions, in that text-data is now bytes, not strings.</span>
<span class="sd">This reflects the fact that many MIDI files have text data in</span>
<span class="sd">encodings other that ISO-8859-1, for example in Shift-JIS.</span>

<span class="sd">Download MIDI.py from   http://www.pjb.com.au/midi/free/MIDI.py</span>
<span class="sd">and put it in your PYTHONPATH.  MIDI.py depends on Python3.</span>

<span class="sd">There is also a call-compatible translation into Lua of this</span>
<span class="sd">module: see http://www.pjb.com.au/comp/lua/MIDI.html</span>

<span class="sd">Backup web site: https://peterbillam.gitlab.io/miditools/</span>

<span class="sd">The &quot;opus&quot; is a direct translation of the midi-file-events, where</span>
<span class="sd">the times are delta-times, in ticks, since the previous event.</span>

<span class="sd">The &quot;score&quot; is more human-centric; it uses absolute times, and</span>
<span class="sd">combines the separate note_on and note_off events into one &quot;note&quot;</span>
<span class="sd">event, with a duration:</span>
<span class="sd"> [&#39;note&#39;, start_time, duration, channel, note, velocity] # in a &quot;score&quot;</span>

<span class="sd">  EVENTS (in an &quot;opus&quot; structure)</span>
<span class="sd">     [&#39;note_off&#39;, dtime, channel, note, velocity]       # in an &quot;opus&quot;</span>
<span class="sd">     [&#39;note_on&#39;, dtime, channel, note, velocity]        # in an &quot;opus&quot;</span>
<span class="sd">     [&#39;key_after_touch&#39;, dtime, channel, note, velocity]</span>
<span class="sd">     [&#39;control_change&#39;, dtime, channel, controller(0-127), value(0-127)]</span>
<span class="sd">     [&#39;patch_change&#39;, dtime, channel, patch]</span>
<span class="sd">     [&#39;channel_after_touch&#39;, dtime, channel, velocity]</span>
<span class="sd">     [&#39;pitch_wheel_change&#39;, dtime, channel, pitch_wheel]</span>
<span class="sd">     [&#39;text_event&#39;, dtime, text]</span>
<span class="sd">     [&#39;copyright_text_event&#39;, dtime, text]</span>
<span class="sd">     [&#39;track_name&#39;, dtime, text]</span>
<span class="sd">     [&#39;instrument_name&#39;, dtime, text]</span>
<span class="sd">     [&#39;lyric&#39;, dtime, text]</span>
<span class="sd">     [&#39;marker&#39;, dtime, text]</span>
<span class="sd">     [&#39;cue_point&#39;, dtime, text]</span>
<span class="sd">     [&#39;text_event_08&#39;, dtime, text]</span>
<span class="sd">     [&#39;text_event_09&#39;, dtime, text]</span>
<span class="sd">     [&#39;text_event_0a&#39;, dtime, text]</span>
<span class="sd">     [&#39;text_event_0b&#39;, dtime, text]</span>
<span class="sd">     [&#39;text_event_0c&#39;, dtime, text]</span>
<span class="sd">     [&#39;text_event_0d&#39;, dtime, text]</span>
<span class="sd">     [&#39;text_event_0e&#39;, dtime, text]</span>
<span class="sd">     [&#39;text_event_0f&#39;, dtime, text]</span>
<span class="sd">     [&#39;end_track&#39;, dtime]</span>
<span class="sd">     [&#39;set_tempo&#39;, dtime, tempo]</span>
<span class="sd">     [&#39;smpte_offset&#39;, dtime, hr, mn, se, fr, ff]</span>
<span class="sd">     [&#39;time_signature&#39;, dtime, nn, dd, cc, bb]</span>
<span class="sd">     [&#39;key_signature&#39;, dtime, sf, mi]</span>
<span class="sd">     [&#39;sequencer_specific&#39;, dtime, raw]</span>
<span class="sd">     [&#39;raw_meta_event&#39;, dtime, command(0-255), raw]</span>
<span class="sd">     [&#39;sysex_f0&#39;, dtime, raw]</span>
<span class="sd">     [&#39;sysex_f7&#39;, dtime, raw]</span>
<span class="sd">     [&#39;song_position&#39;, dtime, song_pos]</span>
<span class="sd">     [&#39;song_select&#39;, dtime, song_number]</span>
<span class="sd">     [&#39;tune_request&#39;, dtime]</span>

<span class="sd">  DATA TYPES</span>
<span class="sd">     channel = a value 0 to 15</span>
<span class="sd">     controller = 0 to 127 (see http://www.pjb.com.au/muscript/gm.html#cc )</span>
<span class="sd">     dtime = time measured in &quot;ticks&quot;, 0 to 268435455</span>
<span class="sd">     velocity = a value 0 (soft) to 127 (loud)</span>
<span class="sd">     note = a value 0 to 127  (middle-C is 60)</span>
<span class="sd">     patch = 0 to 127 (see http://www.pjb.com.au/muscript/gm.html )</span>
<span class="sd">     pitch_wheel = a value -8192 to 8191 (0x1FFF)</span>
<span class="sd">     raw = bytes, of length 0 or more  (for sysex events see below)</span>
<span class="sd">     sequence_number = a value 0 to 65,535 (0xFFFF)</span>
<span class="sd">     song_pos = a value 0 to 16,383 (0x3FFF)</span>
<span class="sd">     song_number = a value 0 to 127</span>
<span class="sd">     tempo = microseconds per crochet (quarter-note), 0 to 16777215</span>
<span class="sd">     text = bytes, of length 0 or more</span>
<span class="sd">     ticks = the number of ticks per crochet (quarter-note)</span>

<span class="sd">   In sysex_f0 events, the raw data must not start with a \xF0 byte,</span>
<span class="sd">   since this gets added automatically;</span>
<span class="sd">   but it must end with an explicit \xF7 byte!</span>
<span class="sd">   In the very unlikely case that you ever need to split sysex data</span>
<span class="sd">   into one sysex_f0 followed by one or more sysex_f7s, then only the</span>
<span class="sd">   last of those sysex_f7 events must end with the explicit \xF7 byte</span>
<span class="sd">   (again, the raw data of individual sysex_f7 events must not start</span>
<span class="sd">   with any \xF7 byte, since this gets added automatically).</span>

<span class="sd">   Since version 6.4, text data is in bytes, not in a ISO-8859-1 string.</span>


<span class="sd">  GOING THROUGH A SCORE WITHIN A PYTHON PROGRAM</span>
<span class="sd">    channels = {2,3,5,8,13}</span>
<span class="sd">    itrack = 1   # skip 1st element which is ticks</span>
<span class="sd">    while itrack &lt; len(score):</span>
<span class="sd">        for event in score[itrack]:</span>
<span class="sd">            if event[0] == &#39;note&#39;:   # for example,</span>
<span class="sd">                pass  # do something to all notes</span>
<span class="sd">            # or, to work on events in only particular channels...</span>
<span class="sd">            channel_index = MIDI.Event2channelindex.get(event[0], False)</span>
<span class="sd">            if channel_index and (event[channel_index] in channels):</span>
<span class="sd">                pass  # do something to channels 2,3,5,8 and 13</span>
<span class="sd">        itrack += 1</span>

<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">struct</span><span class="o">,</span> <span class="nn">copy</span>
<span class="c1"># sys.stdout = os.fdopen(sys.stdout.fileno(), &#39;wb&#39;)</span>
<span class="n">Version</span> <span class="o">=</span> <span class="s1">&#39;6.7&#39;</span>
<span class="n">VersionDate</span> <span class="o">=</span> <span class="s1">&#39;20201120&#39;</span>
<span class="c1"># 20201120 6.7 call to bytest() removed, and protect _unshift_ber_int</span>
<span class="c1"># 20160702 6.6 to_millisecs() now handles set_tempo across multiple Tracks</span>
<span class="c1"># 20150921 6.5 segment restores controllers as well as patch and tempo</span>
<span class="c1"># 20150914 6.4 text data is bytes or bytearray, not ISO-8859-1 strings</span>
<span class="c1"># 20150628 6.3 absent any set_tempo, default is 120bpm (see MIDI file spec 1.1)</span>
<span class="c1"># 20150101 6.2 all text events can be 8-bit; let user get the right encoding</span>
<span class="c1"># 20141231 6.1 fix _some_text_event; sequencer_specific data can be 8-bit</span>
<span class="c1"># 20141230 6.0 synth_specific data can be 8-bit</span>
<span class="c1"># 20120504 5.9 add the contents of mid_opus_tracks()</span>
<span class="c1"># 20120208 5.8 fix num_notes_by_channel() ; should be a dict</span>
<span class="c1"># 20120129 5.7 _encode handles empty tracks; score2stats num_notes_by_channel</span>
<span class="c1"># 20111111 5.6 fix patch 45 and 46 in Number2patch, should be Harp</span>
<span class="c1"># 20110129 5.5 add mix_opus_tracks() and event2alsaseq()</span>
<span class="c1"># 20110126 5.4 &quot;previous message repeated N times&quot; to save space on stderr</span>
<span class="c1"># 20110125 5.2 opus2score terminates unended notes at the end of the track</span>
<span class="c1"># 20110124 5.1 the warnings in midi2opus display track_num</span>
<span class="c1"># 21110122 5.0 if garbage, midi2opus returns the opus so far</span>
<span class="c1"># 21110119 4.9 non-ascii chars stripped out of the text_events</span>
<span class="c1"># 21110110 4.8 note_on with velocity=0 treated as a note-off</span>
<span class="c1"># 21110108 4.6 unknown F-series event correctly eats just one byte</span>
<span class="c1"># 21011010 4.2 segment() uses start_time, end_time named params</span>
<span class="c1"># 21011005 4.1 timeshift() must not pad the set_tempo command</span>
<span class="c1"># 21011003 4.0 pitch2note_event must be chapitch2note_event</span>
<span class="c1"># 21010918 3.9 set_sequence_number supported, FWIW</span>
<span class="c1"># 20100913 3.7 many small bugfixes; passes all tests</span>
<span class="c1"># 20100910 3.6 concatenate_scores enforce ticks=1000, just like merge_scores</span>
<span class="c1"># 20100908 3.5 minor bugs fixed in score2stats</span>
<span class="c1"># 20091104 3.4 tune_request now supported</span>
<span class="c1"># 20091104 3.3 fixed bug in decoding song_position and song_select</span>
<span class="c1"># 20091104 3.2 unsupported: set_sequence_number tune_request raw_data</span>
<span class="c1"># 20091101 3.1 document how to traverse a score within Python</span>
<span class="c1"># 20091021 3.0 fixed bug in score2stats detecting GM-mode = 0</span>
<span class="c1"># 20091020 2.9 score2stats reports GM-mode and bank msb,lsb events</span>
<span class="c1"># 20091019 2.8 in merge_scores, channel 9 must remain channel 9 (in GM)</span>
<span class="c1"># 20091018 2.7 handles empty tracks gracefully</span>
<span class="c1"># 20091015 2.6 grep() selects channels</span>
<span class="c1"># 20091010 2.5 merge_scores reassigns channels to avoid conflicts</span>
<span class="c1"># 20091010 2.4 fixed bug in to_millisecs which now only does opusses</span>
<span class="c1"># 20091010 2.3 score2stats returns channels &amp; patch_changes, by_track &amp; total</span>
<span class="c1"># 20091010 2.2 score2stats() returns also pitches and percussion dicts</span>
<span class="c1"># 20091010 2.1 bugs: &gt;= not &gt; in segment, to notice patch_change at time 0</span>
<span class="c1"># 20091010 2.0 bugs: spurious pop(0) ( in _decode sysex</span>
<span class="c1"># 20091008 1.9 bugs: ISO decoding in sysex; str( not int( in note-off warning</span>
<span class="c1"># 20091008 1.8 add concatenate_scores()</span>
<span class="c1"># 20091006 1.7 score2stats() measures nticks and ticks_per_quarter</span>
<span class="c1"># 20091004 1.6 first mix_scores() and merge_scores()</span>
<span class="c1"># 20090424 1.5 timeshift() bugfix: earliest only sees events after from_time</span>
<span class="c1"># 20090330 1.4 timeshift() has also a from_time argument</span>
<span class="c1"># 20090322 1.3 timeshift() has also a start_time argument</span>
<span class="c1"># 20090319 1.2 add segment() and timeshift()</span>
<span class="c1"># 20090301 1.1 add to_millisecs()</span>

<span class="n">_previous_warning</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># 5.4</span>
<span class="n">_previous_times</span> <span class="o">=</span> <span class="mi">0</span>     <span class="c1"># 5.4</span>
<span class="c1">#------------------------------- Encoding stuff --------------------------</span>

<span class="k">def</span> <span class="nf">opus2midi</span><span class="p">(</span><span class="n">opus</span><span class="o">=</span><span class="p">[]):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;The argument is a list: the first item in the list is the &quot;ticks&quot;</span>
<span class="sd">parameter, the others are the tracks. Each track is a list</span>
<span class="sd">of midi-events, and each event is itself a list; see above.</span>
<span class="sd">opus2midi() returns a bytestring of the MIDI, which can then be</span>
<span class="sd">written either to a file opened in binary mode (mode=&#39;wb&#39;),</span>
<span class="sd">or to stdout by means of:   sys.stdout.buffer.write()</span>

<span class="sd">my_opus = [</span>
<span class="sd">    96, </span>
<span class="sd">    [   # track 0:</span>
<span class="sd">        [&#39;patch_change&#39;, 0, 1, 8],   # and these are the events...</span>
<span class="sd">        [&#39;note_on&#39;,   5, 1, 25, 96],</span>
<span class="sd">        [&#39;note_off&#39;, 96, 1, 25, 0],</span>
<span class="sd">        [&#39;note_on&#39;,   0, 1, 29, 96],</span>
<span class="sd">        [&#39;note_off&#39;, 96, 1, 29, 0],</span>
<span class="sd">    ],   # end of track 0</span>
<span class="sd">]</span>
<span class="sd">my_midi = opus2midi(my_opus)</span>
<span class="sd">sys.stdout.buffer.write(my_midi)</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">opus</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">opus</span><span class="o">=</span><span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="p">[],]</span>
    <span class="n">tracks</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">opus</span><span class="p">)</span>
    <span class="n">ticks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tracks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">ntracks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tracks</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ntracks</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">format</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">format</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">my_midi</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;MThd</span><span class="se">\x00\x00\x00\x06</span><span class="s2">&quot;</span><span class="o">+</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;HHH&#39;</span><span class="p">,</span><span class="nb">format</span><span class="p">,</span><span class="n">ntracks</span><span class="p">,</span><span class="n">ticks</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">tracks</span><span class="p">:</span>
        <span class="n">events</span> <span class="o">=</span> <span class="n">_encode</span><span class="p">(</span><span class="n">track</span><span class="p">)</span>
        <span class="n">my_midi</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;MTrk&#39;</span> <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;I&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">))</span> <span class="o">+</span> <span class="n">events</span>
    <span class="n">_clean_up_warnings</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">my_midi</span>


<span class="k">def</span> <span class="nf">score2opus</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">The argument is a list: the first item in the list is the &quot;ticks&quot;</span>
<span class="sd">parameter, the others are the tracks. Each track is a list</span>
<span class="sd">of score-events, and each event is itself a list.  A score-event</span>
<span class="sd">is similar to an opus-event (see above), except that in a score:</span>
<span class="sd"> 1) the times are expressed as an absolute number of ticks</span>
<span class="sd">    from the track&#39;s start time</span>
<span class="sd"> 2) the pairs of &#39;note_on&#39; and &#39;note_off&#39; events in an &quot;opus&quot;</span>
<span class="sd">    are abstracted into a single &#39;note&#39; event in a &quot;score&quot;:</span>
<span class="sd">    [&#39;note&#39;, start_time, duration, channel, pitch, velocity]</span>
<span class="sd">score2opus() returns a list specifying the equivalent &quot;opus&quot;.</span>

<span class="sd">my_score = [</span>
<span class="sd">    96,</span>
<span class="sd">    [   # track 0:</span>
<span class="sd">        [&#39;patch_change&#39;, 0, 1, 8],</span>
<span class="sd">        [&#39;note&#39;, 5, 96, 1, 25, 96],</span>
<span class="sd">        [&#39;note&#39;, 101, 96, 1, 29, 96]</span>
<span class="sd">    ],   # end of track 0</span>
<span class="sd">]</span>
<span class="sd">my_opus = score2opus(my_score)</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">score</span><span class="o">=</span><span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="p">[],]</span>
    <span class="n">tracks</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
    <span class="n">ticks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tracks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">opus_tracks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">scoretrack</span> <span class="ow">in</span> <span class="n">tracks</span><span class="p">:</span>
        <span class="n">time2events</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">scoreevent</span> <span class="ow">in</span> <span class="n">scoretrack</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scoreevent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note&#39;</span><span class="p">:</span>
                <span class="n">note_on_event</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;note_on&#39;</span><span class="p">,</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                 <span class="n">scoreevent</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span>
                <span class="n">note_off_event</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;note_off&#39;</span><span class="p">,</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                 <span class="n">scoreevent</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">time2events</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">note_on_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                   <span class="n">time2events</span><span class="p">[</span><span class="n">note_on_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">note_on_event</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                   <span class="n">time2events</span><span class="p">[</span><span class="n">note_on_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">note_on_event</span><span class="p">,]</span>
                <span class="k">if</span> <span class="n">time2events</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">note_off_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                   <span class="n">time2events</span><span class="p">[</span><span class="n">note_off_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">note_off_event</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                   <span class="n">time2events</span><span class="p">[</span><span class="n">note_off_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">note_off_event</span><span class="p">,]</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">time2events</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
               <span class="n">time2events</span><span class="p">[</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scoreevent</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">time2events</span><span class="p">[</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">scoreevent</span><span class="p">,]</span>

        <span class="n">sorted_times</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of keys</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">time2events</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">sorted_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">sorted_times</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="n">sorted_events</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># once-flattened list of values sorted by key</span>
        <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">sorted_times</span><span class="p">:</span>
            <span class="n">sorted_events</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">time2events</span><span class="p">[</span><span class="n">time</span><span class="p">])</span>

        <span class="n">abs_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">sorted_events</span><span class="p">:</span>  <span class="c1"># convert abs times =&gt; delta times</span>
            <span class="n">delta_time</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">abs_time</span>
            <span class="n">abs_time</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">delta_time</span>
        <span class="n">opus_tracks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sorted_events</span><span class="p">)</span>
    <span class="n">opus_tracks</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ticks</span><span class="p">)</span>
    <span class="n">_clean_up_warnings</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">opus_tracks</span>

<span class="k">def</span> <span class="nf">score2midi</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Translates a &quot;score&quot; into MIDI, using score2opus() then opus2midi()</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">opus2midi</span><span class="p">(</span><span class="n">score2opus</span><span class="p">(</span><span class="n">score</span><span class="p">))</span>

<span class="c1">#--------------------------- Decoding stuff ------------------------</span>

<span class="k">def</span> <span class="nf">midi2opus</span><span class="p">(</span><span class="n">midi</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Translates MIDI into a &quot;opus&quot;.  For a description of the</span>
<span class="sd">&quot;opus&quot; format, see opus2midi()</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="n">my_midi</span><span class="o">=</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">midi</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">my_midi</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">_clean_up_warnings</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,[],]</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">my_midi</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">id</span> <span class="o">!=</span> <span class="sa">b</span><span class="s1">&#39;MThd&#39;</span><span class="p">:</span>
        <span class="n">_warn</span><span class="p">(</span><span class="s2">&quot;midi2opus: midi starts with &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; instead of &#39;MThd&#39;&quot;</span><span class="p">)</span>
        <span class="n">_clean_up_warnings</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,[],]</span>
    <span class="p">[</span><span class="n">length</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="n">tracks_expected</span><span class="p">,</span> <span class="n">ticks</span><span class="p">]</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span>
     <span class="s1">&#39;&gt;IHHH&#39;</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">my_midi</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">14</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">length</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">:</span>
        <span class="n">_warn</span><span class="p">(</span><span class="s2">&quot;midi2opus: midi header length was &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">length</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; instead of 6&quot;</span><span class="p">)</span>
        <span class="n">_clean_up_warnings</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,[],]</span>
    <span class="n">my_opus</span> <span class="o">=</span> <span class="p">[</span><span class="n">ticks</span><span class="p">,]</span>
    <span class="n">my_midi</span> <span class="o">=</span> <span class="n">my_midi</span><span class="p">[</span><span class="mi">14</span><span class="p">:]</span>
    <span class="n">track_num</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># 5.1</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">my_midi</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">track_type</span>   <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">my_midi</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">track_type</span> <span class="o">!=</span> <span class="sa">b</span><span class="s1">&#39;MTrk&#39;</span><span class="p">:</span>
            <span class="n">_warn</span><span class="p">(</span><span class="s1">&#39;midi2opus: Warning: track #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">track_num</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; type is &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">track_type</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; instead of b&#39;MTrk&#39;&quot;</span><span class="p">)</span>
        <span class="p">[</span><span class="n">track_length</span><span class="p">]</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&gt;I&#39;</span><span class="p">,</span> <span class="n">my_midi</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span>
        <span class="n">my_midi</span> <span class="o">=</span> <span class="n">my_midi</span><span class="p">[</span><span class="mi">8</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">track_length</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">my_midi</span><span class="p">):</span>
            <span class="n">_warn</span><span class="p">(</span><span class="s1">&#39;midi2opus: track #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">track_num</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; length &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">track_length</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; is too large&#39;</span><span class="p">)</span>
            <span class="n">_clean_up_warnings</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">my_opus</span>   <span class="c1"># 5.0</span>
        <span class="n">my_midi_track</span> <span class="o">=</span> <span class="n">my_midi</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">track_length</span><span class="p">]</span>
        <span class="n">my_track</span> <span class="o">=</span> <span class="n">_decode</span><span class="p">(</span><span class="n">my_midi_track</span><span class="p">)</span>
        <span class="n">my_opus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">my_track</span><span class="p">)</span>
        <span class="n">my_midi</span> <span class="o">=</span> <span class="n">my_midi</span><span class="p">[</span><span class="n">track_length</span><span class="p">:]</span>
        <span class="n">track_num</span> <span class="o">+=</span> <span class="mi">1</span>   <span class="c1"># 5.1</span>
    <span class="n">_clean_up_warnings</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">my_opus</span>

<span class="k">def</span> <span class="nf">opus2score</span><span class="p">(</span><span class="n">opus</span><span class="o">=</span><span class="p">[]):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;For a description of the &quot;opus&quot; and &quot;score&quot; formats,</span>
<span class="sd">see opus2midi() and score2opus().</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">opus</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">_clean_up_warnings</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,[],]</span>
    <span class="n">tracks</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">opus</span><span class="p">)</span>  <span class="c1"># couple of slices probably quicker...</span>
    <span class="n">ticks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tracks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">score</span> <span class="o">=</span> <span class="p">[</span><span class="n">ticks</span><span class="p">,]</span>
    <span class="k">for</span> <span class="n">opus_track</span> <span class="ow">in</span> <span class="n">tracks</span><span class="p">:</span>
        <span class="n">ticks_so_far</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">score_track</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">chapitch2note_on_events</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([])</span>   <span class="c1"># 4.0</span>
        <span class="k">for</span> <span class="n">opus_event</span> <span class="ow">in</span> <span class="n">opus_track</span><span class="p">:</span>
            <span class="n">ticks_so_far</span> <span class="o">+=</span> <span class="n">opus_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">opus_event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note_off&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">opus_event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note_on&#39;</span> <span class="ow">and</span> <span class="n">opus_event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>  <span class="c1"># 4.8</span>
                <span class="n">cha</span> <span class="o">=</span> <span class="n">opus_event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">pitch</span> <span class="o">=</span> <span class="n">opus_event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">cha</span><span class="o">*</span><span class="mi">128</span> <span class="o">+</span> <span class="n">pitch</span>
                <span class="k">if</span> <span class="n">chapitch2note_on_events</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                    <span class="n">new_event</span> <span class="o">=</span> <span class="n">chapitch2note_on_events</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">new_event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ticks_so_far</span> <span class="o">-</span> <span class="n">new_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">score_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_event</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">pitch</span> <span class="o">&gt;</span> <span class="mi">127</span><span class="p">:</span>
                    <span class="k">pass</span> <span class="c1">#_warn(&#39;opus2score: note_off with no note_on, bad pitch=&#39;+str(pitch))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span> <span class="c1">#_warn(&#39;opus2score: note_off with no note_on cha=&#39;+str(cha)+&#39; pitch=&#39;+str(pitch))</span>
            <span class="k">elif</span> <span class="n">opus_event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note_on&#39;</span><span class="p">:</span>
                <span class="n">cha</span> <span class="o">=</span> <span class="n">opus_event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">pitch</span> <span class="o">=</span> <span class="n">opus_event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">cha</span><span class="o">*</span><span class="mi">128</span> <span class="o">+</span> <span class="n">pitch</span>
                <span class="n">new_event</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;note&#39;</span><span class="p">,</span><span class="n">ticks_so_far</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cha</span><span class="p">,</span><span class="n">pitch</span><span class="p">,</span> <span class="n">opus_event</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">chapitch2note_on_events</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                    <span class="n">chapitch2note_on_events</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_event</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">chapitch2note_on_events</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_event</span><span class="p">,]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">opus_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ticks_so_far</span>
                <span class="n">score_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opus_event</span><span class="p">)</span>
        <span class="c1"># check for unterminated notes (Oisn) -- 5.2</span>
        <span class="k">for</span> <span class="n">chapitch</span> <span class="ow">in</span> <span class="n">chapitch2note_on_events</span><span class="p">:</span>
            <span class="n">note_on_events</span> <span class="o">=</span> <span class="n">chapitch2note_on_events</span><span class="p">[</span><span class="n">chapitch</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">new_e</span> <span class="ow">in</span> <span class="n">note_on_events</span><span class="p">:</span>
                <span class="n">new_e</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ticks_so_far</span> <span class="o">-</span> <span class="n">new_e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">score_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_e</span><span class="p">)</span>
                <span class="k">pass</span> <span class="c1">#_warn(&quot;opus2score: note_on with no note_off cha=&quot;+str(new_e[3])+&#39; pitch=&#39;+str(new_e[4])+&#39;; adding note_off at end&#39;)</span>
        <span class="n">score</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score_track</span><span class="p">)</span>
    <span class="n">_clean_up_warnings</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">score</span>

<span class="k">def</span> <span class="nf">midi2score</span><span class="p">(</span><span class="n">midi</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Translates MIDI into a &quot;score&quot;, using midi2opus() then opus2score()</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">opus2score</span><span class="p">(</span><span class="n">midi2opus</span><span class="p">(</span><span class="n">midi</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">midi2ms_score</span><span class="p">(</span><span class="n">midi</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Translates MIDI into a &quot;score&quot; with one beat per second and one</span>
<span class="sd">tick per millisecond, using midi2opus() then to_millisecs()</span>
<span class="sd">then opus2score()</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">opus2score</span><span class="p">(</span><span class="n">to_millisecs</span><span class="p">(</span><span class="n">midi2opus</span><span class="p">(</span><span class="n">midi</span><span class="p">)))</span>

<span class="c1">#------------------------ Other Transformations ---------------------</span>

<span class="k">def</span> <span class="nf">to_millisecs</span><span class="p">(</span><span class="n">old_opus</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Recallibrates all the times in an &quot;opus&quot; to use one beat</span>
<span class="sd">per second and one tick per millisecond.  This makes it</span>
<span class="sd">hard to retrieve any information about beats or barlines,</span>
<span class="sd">but it does make it easy to mix different scores together.</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">old_opus</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,[],]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">old_tpq</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">old_opus</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>   <span class="c1"># 5.0</span>
        <span class="n">_warn</span><span class="p">(</span><span class="s1">&#39;to_millisecs: the opus &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">old_opus</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; has no elements&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,[],]</span>
    <span class="n">new_opus</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,]</span>
    <span class="c1"># 6.7 first go through building a table of set_tempos by absolute-tick</span>
    <span class="n">ticks2tempo</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">itrack</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">itrack</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_opus</span><span class="p">):</span>
        <span class="n">ticks_so_far</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">old_event</span> <span class="ow">in</span> <span class="n">old_opus</span><span class="p">[</span><span class="n">itrack</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">old_event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;to_millisecs needs an opus, not a score&#39;</span><span class="p">)</span>
            <span class="n">ticks_so_far</span> <span class="o">+=</span> <span class="n">old_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">old_event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;set_tempo&#39;</span><span class="p">:</span>
                <span class="n">ticks2tempo</span><span class="p">[</span><span class="n">ticks_so_far</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">itrack</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1"># then get the sorted-array of their keys</span>
    <span class="n">tempo_ticks</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of keys</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ticks2tempo</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">tempo_ticks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="n">tempo_ticks</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="c1"># then go through converting to millisec, testing if the next</span>
    <span class="c1"># set_tempo lies before the next track-event, and using it if so.</span>
    <span class="n">itrack</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">itrack</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_opus</span><span class="p">):</span>
        <span class="n">ms_per_old_tick</span> <span class="o">=</span> <span class="mf">500.0</span> <span class="o">/</span> <span class="n">old_tpq</span>  <span class="c1"># float: will round later 6.3</span>
        <span class="n">i_tempo_ticks</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ticks_so_far</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ms_so_far</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">previous_ms_so_far</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">new_track</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;set_tempo&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1000000</span><span class="p">],]</span>  <span class="c1"># new &quot;crochet&quot; is 1 sec</span>
        <span class="k">for</span> <span class="n">old_event</span> <span class="ow">in</span> <span class="n">old_opus</span><span class="p">[</span><span class="n">itrack</span><span class="p">]:</span>
            <span class="c1"># detect if ticks2tempo has something before this event</span>
            <span class="c1"># 20160702 if ticks2tempo is at the same time, leave it</span>
            <span class="n">event_delta_ticks</span> <span class="o">=</span> <span class="n">old_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i_tempo_ticks</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tempo_ticks</span><span class="p">)</span> <span class="ow">and</span>
              <span class="n">tempo_ticks</span><span class="p">[</span><span class="n">i_tempo_ticks</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ticks_so_far</span> <span class="o">+</span> <span class="n">old_event</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
                <span class="n">delta_ticks</span> <span class="o">=</span> <span class="n">tempo_ticks</span><span class="p">[</span><span class="n">i_tempo_ticks</span><span class="p">]</span> <span class="o">-</span> <span class="n">ticks_so_far</span>
                <span class="n">ms_so_far</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ms_per_old_tick</span> <span class="o">*</span> <span class="n">delta_ticks</span><span class="p">)</span>
                <span class="n">ticks_so_far</span> <span class="o">=</span> <span class="n">tempo_ticks</span><span class="p">[</span><span class="n">i_tempo_ticks</span><span class="p">]</span>
                <span class="n">ms_per_old_tick</span> <span class="o">=</span> <span class="n">ticks2tempo</span><span class="p">[</span><span class="n">ticks_so_far</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1000.0</span><span class="o">*</span><span class="n">old_tpq</span><span class="p">)</span>
                <span class="n">i_tempo_ticks</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">event_delta_ticks</span> <span class="o">-=</span> <span class="n">delta_ticks</span>
            <span class="n">new_event</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">old_event</span><span class="p">)</span>  <span class="c1"># now handle the new event</span>
            <span class="n">ms_so_far</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ms_per_old_tick</span> <span class="o">*</span> <span class="n">old_event</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">new_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">ms_so_far</span> <span class="o">-</span> <span class="n">previous_ms_so_far</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">old_event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;set_tempo&#39;</span><span class="p">:</span>
                <span class="n">previous_ms_so_far</span> <span class="o">=</span> <span class="n">ms_so_far</span>
                <span class="n">new_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_event</span><span class="p">)</span>
            <span class="n">ticks_so_far</span> <span class="o">+=</span> <span class="n">event_delta_ticks</span>
        <span class="n">new_opus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_track</span><span class="p">)</span>
        <span class="n">itrack</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">_clean_up_warnings</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">new_opus</span>

<span class="k">def</span> <span class="nf">event2alsaseq</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>   <span class="c1"># 5.5</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Converts an event into the format needed by the alsaseq module,</span>
<span class="sd">http://pp.com.mx/python/alsaseq</span>
<span class="sd">The type of track (opus or score) is autodetected.</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">grep</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Returns a &quot;score&quot; containing only the channels specified</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">score</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,[],]</span>
    <span class="n">ticks</span> <span class="o">=</span> <span class="n">score</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">new_score</span> <span class="o">=</span> <span class="p">[</span><span class="n">ticks</span><span class="p">,]</span>
    <span class="k">if</span> <span class="n">channels</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">new_score</span>
    <span class="n">channels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
    <span class="k">global</span> <span class="n">Event2channelindex</span>
    <span class="n">itrack</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">itrack</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">):</span>
        <span class="n">new_score</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">score</span><span class="p">[</span><span class="n">itrack</span><span class="p">]:</span>
            <span class="n">channel_index</span> <span class="o">=</span> <span class="n">Event2channelindex</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">channel_index</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="n">channel_index</span><span class="p">]</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
                    <span class="n">new_score</span><span class="p">[</span><span class="n">itrack</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_score</span><span class="p">[</span><span class="n">itrack</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">itrack</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">new_score</span>

<span class="k">def</span> <span class="nf">play_score</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Converts the &quot;score&quot; to midi, and feeds it into &#39;aplaymidi -&#39;</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">score</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="kn">import</span> <span class="nn">subprocess</span>
    <span class="n">pipe</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;aplaymidi&#39;</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">],</span> <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">score_type</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;opus&#39;</span><span class="p">:</span>
        <span class="n">pipe</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">opus2midi</span><span class="p">(</span><span class="n">score</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pipe</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">score2midi</span><span class="p">(</span><span class="n">score</span><span class="p">))</span>
    <span class="n">pipe</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">timeshift</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">from_time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tracks</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">}):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Returns a &quot;score&quot; shifted in time by &quot;shift&quot; ticks, or shifted</span>
<span class="sd">so that the first event starts at &quot;start_time&quot; ticks.</span>

<span class="sd">If &quot;from_time&quot; is specified, only those events in the score</span>
<span class="sd">that begin after it are shifted. If &quot;start_time&quot; is less than</span>
<span class="sd">&quot;from_time&quot; (or &quot;shift&quot; is negative), then the intermediate</span>
<span class="sd">notes are deleted, though patch-change events are preserved.</span>

<span class="sd">If &quot;tracks&quot; are specified, then only those tracks get shifted.</span>
<span class="sd">&quot;tracks&quot; can be a list, tuple or set; it gets converted to set</span>
<span class="sd">internally.</span>

<span class="sd">It is deprecated to specify both &quot;shift&quot; and &quot;start_time&quot;.</span>
<span class="sd">If this does happen, timeshift() will print a warning to</span>
<span class="sd">stderr and ignore the &quot;shift&quot; argument.</span>

<span class="sd">If &quot;shift&quot; is negative and sufficiently large that it would</span>
<span class="sd">leave some event with a negative tick-value, then the score</span>
<span class="sd">is shifted so that the first event occurs at time 0. This</span>
<span class="sd">also occurs if &quot;start_time&quot; is negative, and is also the</span>
<span class="sd">default if neither &quot;shift&quot; nor &quot;start_time&quot; are specified.</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="c1">#_warn(&#39;tracks=&#39;+str(tracks))</span>
    <span class="k">if</span> <span class="n">score</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="p">[],]</span>
    <span class="n">new_score</span> <span class="o">=</span> <span class="p">[</span><span class="n">score</span><span class="p">[</span><span class="mi">0</span><span class="p">],]</span>
    <span class="n">my_type</span> <span class="o">=</span> <span class="n">score_type</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">my_type</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">new_score</span>
    <span class="k">if</span> <span class="n">my_type</span> <span class="o">==</span> <span class="s1">&#39;opus&#39;</span><span class="p">:</span>
        <span class="n">_warn</span><span class="p">(</span><span class="s2">&quot;timeshift: opus format is not supported</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># _clean_up_scores()  6.2; doesn&#39;t exist! what was it supposed to do?</span>
        <span class="k">return</span> <span class="n">new_score</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">shift</span> <span class="o">==</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">start_time</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">_warn</span><span class="p">(</span><span class="s2">&quot;timeshift: shift and start_time specified: ignoring shift</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">shift</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">start_time</span> <span class="o">==</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">start_time</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># shift = start_time - from_time</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># ignore first element (ticks)</span>
    <span class="n">tracks</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">tracks</span><span class="p">)</span>  <span class="c1"># defend against tuples and lists</span>
    <span class="n">earliest</span> <span class="o">=</span> <span class="mi">1000000000</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">start_time</span> <span class="o">==</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">shift</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># first find the earliest event</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tracks</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tracks</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                 <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">from_time</span><span class="p">:</span>
                     <span class="k">continue</span>  <span class="c1"># just inspect the to_be_shifted events</span>
                 <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">earliest</span><span class="p">:</span>
                     <span class="n">earliest</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">earliest</span> <span class="o">&gt;</span> <span class="mi">999999999</span><span class="p">:</span>
        <span class="n">earliest</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">shift</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">start_time</span> <span class="o">-</span> <span class="n">earliest</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">earliest</span> <span class="o">+</span> <span class="n">shift</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">-</span> <span class="n">earliest</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># ignore first element (ticks)</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tracks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tracks</span><span class="p">):</span>  <span class="c1"># 3.8</span>
            <span class="n">new_score</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="n">new_track</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">new_event</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="c1">#if new_event[1] == 0 and shift &gt; 0 and new_event[0] != &#39;note&#39;:</span>
            <span class="c1">#    pass</span>
            <span class="c1">#elif new_event[1] &gt;= from_time:</span>
            <span class="k">if</span> <span class="n">new_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">from_time</span><span class="p">:</span>
                <span class="c1"># 4.1 must not rightshift set_tempo</span>
                <span class="k">if</span> <span class="n">new_event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;set_tempo&#39;</span> <span class="ow">or</span> <span class="n">shift</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">new_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">shift</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">shift</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">new_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">from_time</span><span class="o">+</span><span class="n">shift</span><span class="p">)):</span>
                <span class="k">continue</span>
            <span class="n">new_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_event</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_track</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">new_score</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_track</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">_clean_up_warnings</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">new_score</span>

<span class="k">def</span> <span class="nf">segment</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="mi">100000000</span><span class="p">,</span>
 <span class="n">tracks</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">}):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Returns a &quot;score&quot; which is a segment of the one supplied</span>
<span class="sd">as the argument, beginning at &quot;start_time&quot; ticks and ending</span>
<span class="sd">at &quot;end_time&quot; ticks (or at the end if &quot;end_time&quot; is not supplied).</span>
<span class="sd">If the set &quot;tracks&quot; is specified, only those tracks will</span>
<span class="sd">be returned.</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">score</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="p">[],]</span>
    <span class="k">if</span> <span class="n">start_time</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># as of 4.2 start_time is recommended</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">start</span>  <span class="c1"># start is legacy usage</span>
    <span class="k">if</span> <span class="n">end_time</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>    <span class="c1"># likewise</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">end</span>
    <span class="n">new_score</span> <span class="o">=</span> <span class="p">[</span><span class="n">score</span><span class="p">[</span><span class="mi">0</span><span class="p">],]</span>
    <span class="n">my_type</span> <span class="o">=</span> <span class="n">score_type</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">my_type</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">new_score</span>
    <span class="k">if</span> <span class="n">my_type</span> <span class="o">==</span> <span class="s1">&#39;opus&#39;</span><span class="p">:</span>
        <span class="c1"># more difficult (disconnecting note_on&#39;s from their note_off&#39;s)...</span>
        <span class="n">_warn</span><span class="p">(</span><span class="s2">&quot;segment: opus format is not supported</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">_clean_up_warnings</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">new_score</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># ignore first element (ticks); we count in ticks anyway</span>
    <span class="n">tracks</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">tracks</span><span class="p">)</span>  <span class="c1"># defend against tuples and lists</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tracks</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tracks</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="n">new_track</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">channel2cc_num</span>  <span class="o">=</span> <span class="p">{}</span>     <span class="c1"># most recent controller change before start</span>
        <span class="n">channel2cc_val</span>  <span class="o">=</span> <span class="p">{}</span>
        <span class="n">channel2cc_time</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">channel2patch_num</span>  <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># keep most recent patch change before start</span>
        <span class="n">channel2patch_time</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">set_tempo_num</span>  <span class="o">=</span> <span class="mi">500000</span> <span class="c1"># most recent tempo change before start 6.3</span>
        <span class="n">set_tempo_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">earliest_note_time</span> <span class="o">=</span> <span class="n">end_time</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control_change&#39;</span><span class="p">:</span>  <span class="c1"># 6.5</span>
                <span class="n">cc_time</span> <span class="o">=</span> <span class="n">channel2cc_time</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">start_time</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">cc_time</span><span class="p">):</span>
                    <span class="n">channel2cc_num</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>  <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">channel2cc_val</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>  <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                    <span class="n">channel2cc_time</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;patch_change&#39;</span><span class="p">:</span>
                <span class="n">patch_time</span> <span class="o">=</span> <span class="n">channel2patch_time</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">start_time</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">patch_time</span><span class="p">):</span>  <span class="c1"># 2.0</span>
                    <span class="n">channel2patch_num</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>  <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">channel2patch_time</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;set_tempo&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">start_time</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">set_tempo_time</span><span class="p">):</span> <span class="c1">#6.4</span>
                    <span class="n">set_tempo_num</span>  <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">set_tempo_time</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">start_time</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">end_time</span><span class="p">):</span>
                <span class="n">new_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">earliest_note_time</span><span class="p">):</span>
                    <span class="n">earliest_note_time</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_track</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">new_track</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;set_tempo&#39;</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">set_tempo_num</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">channel2patch_num</span><span class="p">:</span>
                <span class="n">new_track</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span><span class="n">start_time</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">channel2patch_num</span><span class="p">[</span><span class="n">c</span><span class="p">]],)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">channel2cc_num</span><span class="p">:</span>   <span class="c1"># 6.5</span>
                <span class="n">new_track</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;control_change&#39;</span><span class="p">,</span><span class="n">start_time</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">channel2cc_num</span><span class="p">[</span><span class="n">c</span><span class="p">],</span><span class="n">channel2cc_val</span><span class="p">[</span><span class="n">c</span><span class="p">]])</span>
            <span class="n">new_score</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_track</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">_clean_up_warnings</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">new_score</span>

<span class="k">def</span> <span class="nf">score_type</span><span class="p">(</span><span class="n">opus_or_score</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Returns a string, either &#39;opus&#39; or &#39;score&#39; or &#39;&#39;</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">opus_or_score</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">opus_or_score</span><span class="p">))</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">opus_or_score</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># ignore first element</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">opus_or_score</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">opus_or_score</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;score&#39;</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note_on&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;opus&#39;</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span>

<span class="k">def</span> <span class="nf">concatenate_scores</span><span class="p">(</span><span class="n">scores</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Concatenates a list of scores into one score.</span>
<span class="sd">If the scores differ in their &quot;ticks&quot; parameter,</span>
<span class="sd">they will all get converted to millisecond-tick format.</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="c1"># the deepcopys are needed if the input_score&#39;s are refs to the same obj</span>
    <span class="c1"># e.g. if invoked by midisox&#39;s repeat()</span>
    <span class="n">input_scores</span> <span class="o">=</span> <span class="n">_consistentise_ticks</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>  <span class="c1"># 3.7</span>
    <span class="n">output_score</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">input_scores</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">input_score</span> <span class="ow">in</span> <span class="n">input_scores</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">output_stats</span> <span class="o">=</span> <span class="n">score2stats</span><span class="p">(</span><span class="n">output_score</span><span class="p">)</span>
        <span class="n">delta_ticks</span> <span class="o">=</span> <span class="n">output_stats</span><span class="p">[</span><span class="s1">&#39;nticks&#39;</span><span class="p">]</span>
        <span class="n">itrack</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">itrack</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_score</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">itrack</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_score</span><span class="p">):</span> <span class="c1"># new output track if doesn&#39;t exist</span>
                <span class="n">output_score</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">input_score</span><span class="p">[</span><span class="n">itrack</span><span class="p">]:</span>
                <span class="n">output_score</span><span class="p">[</span><span class="n">itrack</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
                <span class="n">output_score</span><span class="p">[</span><span class="n">itrack</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">delta_ticks</span>
            <span class="n">itrack</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">output_score</span>

<span class="k">def</span> <span class="nf">merge_scores</span><span class="p">(</span><span class="n">scores</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Merges a list of scores into one score.  A merged score comprises</span>
<span class="sd">all of the tracks from all of the input scores; un-merging is possible</span>
<span class="sd">by selecting just some of the tracks.  If the scores differ in their</span>
<span class="sd">&quot;ticks&quot; parameter, they will all get converted to millisecond-tick</span>
<span class="sd">format.  merge_scores attempts to resolve channel-conflicts,</span>
<span class="sd">but there are of course only 15 available channels...</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="n">input_scores</span> <span class="o">=</span> <span class="n">_consistentise_ticks</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>  <span class="c1"># 3.6</span>
    <span class="n">output_score</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span><span class="p">]</span>
    <span class="n">channels_so_far</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">all_channels</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">}</span>
    <span class="k">global</span> <span class="n">Event2channelindex</span>
    <span class="k">for</span> <span class="n">input_score</span> <span class="ow">in</span> <span class="n">input_scores</span><span class="p">:</span>
        <span class="n">new_channels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">score2stats</span><span class="p">(</span><span class="n">input_score</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;channels_total&#39;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">new_channels</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>  <span class="c1"># 2.8 cha9 must remain cha9 (in GM)</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channels_so_far</span> <span class="o">&amp;</span> <span class="n">new_channels</span><span class="p">:</span>
            <span class="c1"># consistently choose lowest avaiable, to ease testing</span>
            <span class="n">free_channels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">all_channels</span> <span class="o">-</span> <span class="p">(</span><span class="n">channels_so_far</span><span class="o">|</span><span class="n">new_channels</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">free_channels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">free_channels</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="n">free_channel</span> <span class="o">=</span> <span class="n">free_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">free_channel</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">break</span>
            <span class="n">itrack</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="n">itrack</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_score</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">input_event</span> <span class="ow">in</span> <span class="n">input_score</span><span class="p">[</span><span class="n">itrack</span><span class="p">]:</span>
                    <span class="n">channel_index</span><span class="o">=</span><span class="n">Event2channelindex</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">input_event</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">channel_index</span> <span class="ow">and</span> <span class="n">input_event</span><span class="p">[</span><span class="n">channel_index</span><span class="p">]</span><span class="o">==</span><span class="n">channel</span><span class="p">:</span>
                        <span class="n">input_event</span><span class="p">[</span><span class="n">channel_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">free_channel</span>
                <span class="n">itrack</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">channels_so_far</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">free_channel</span><span class="p">)</span>

        <span class="n">channels_so_far</span> <span class="o">|=</span> <span class="n">new_channels</span>
        <span class="n">output_score</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">input_score</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">return</span> <span class="n">output_score</span>

<span class="k">def</span> <span class="nf">_ticks</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">mix_opus_tracks</span><span class="p">(</span><span class="n">input_tracks</span><span class="p">):</span>   <span class="c1"># 5.5</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Mixes an array of tracks into one track.  A mixed track</span>
<span class="sd">cannot be un-mixed.  It is assumed that the tracks share the same</span>
<span class="sd">ticks parameter and the same tempo.</span>
<span class="sd">Mixing score-tracks is trivial (just insert all events into one array).</span>
<span class="sd">Mixing opus-tracks is only slightly harder, but it&#39;s common enough</span>
<span class="sd">that a dedicated function is useful.</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="n">output_score</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="p">[]]</span>
    <span class="k">for</span> <span class="n">input_track</span> <span class="ow">in</span> <span class="n">input_tracks</span><span class="p">:</span>   <span class="c1"># 5.8</span>
        <span class="n">input_score</span> <span class="o">=</span> <span class="n">opus2score</span><span class="p">([</span><span class="mi">1000</span><span class="p">,</span> <span class="n">input_track</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">input_score</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">output_score</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="n">output_score</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">_ticks</span><span class="p">)</span> 
    <span class="n">output_opus</span> <span class="o">=</span> <span class="n">score2opus</span><span class="p">(</span><span class="n">output_score</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_opus</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">mix_scores</span><span class="p">(</span><span class="n">scores</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Mixes a list of scores into one one-track score.</span>
<span class="sd">A mixed score cannot be un-mixed.  Hopefully the scores</span>
<span class="sd">have no undesirable channel-conflicts between them.</span>
<span class="sd">If the scores differ in their &quot;ticks&quot; parameter,</span>
<span class="sd">they will all get converted to millisecond-tick format.</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="n">input_scores</span> <span class="o">=</span> <span class="n">_consistentise_ticks</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>  <span class="c1"># 3.6</span>
    <span class="n">output_score</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="p">[]]</span>
    <span class="k">for</span> <span class="n">input_score</span> <span class="ow">in</span> <span class="n">input_scores</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">input_track</span> <span class="ow">in</span> <span class="n">input_score</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">output_score</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">input_track</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_score</span>

<span class="k">def</span> <span class="nf">score2stats</span><span class="p">(</span><span class="n">opus_or_score</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Returns a dict of some basic stats about the score, like</span>
<span class="sd">bank_select (list of tuples (msb,lsb)),</span>
<span class="sd">channels_by_track (list of lists), channels_total (set),</span>
<span class="sd">general_midi_mode (list),</span>
<span class="sd">ntracks, nticks, patch_changes_by_track (list of dicts),</span>
<span class="sd">num_notes_by_channel (list of numbers),</span>
<span class="sd">patch_changes_total (set),</span>
<span class="sd">percussion (dict histogram of channel 9 events),</span>
<span class="sd">pitches (dict histogram of pitches on channels other than 9),</span>
<span class="sd">pitch_range_by_track (list, by track, of two-member-tuples),</span>
<span class="sd">pitch_range_sum (sum over tracks of the pitch_ranges),</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="n">bank_select_msb</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">bank_select_lsb</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">bank_select</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">channels_by_track</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">channels_total</span>    <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
    <span class="n">general_midi_mode</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">num_notes_by_channel</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([])</span>
    <span class="n">patches_used_by_track</span>  <span class="o">=</span> <span class="p">[]</span>
    <span class="n">patches_used_total</span>     <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
    <span class="n">patch_changes_by_track</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">patch_changes_total</span>    <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
    <span class="n">percussion</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([])</span> <span class="c1"># histogram of channel 9 &quot;pitches&quot;</span>
    <span class="n">pitches</span>    <span class="o">=</span> <span class="nb">dict</span><span class="p">([])</span> <span class="c1"># histogram of pitch-occurrences channels 0-8,10-15</span>
    <span class="n">pitch_range_sum</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># u pitch-ranges of each track</span>
    <span class="n">pitch_range_by_track</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">is_a_score</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">opus_or_score</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;bank_select&#39;</span><span class="p">:[],</span> <span class="s1">&#39;channels_by_track&#39;</span><span class="p">:[],</span> <span class="s1">&#39;channels_total&#39;</span><span class="p">:[],</span>
         <span class="s1">&#39;general_midi_mode&#39;</span><span class="p">:[],</span> <span class="s1">&#39;ntracks&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;nticks&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
         <span class="s1">&#39;num_notes_by_channel&#39;</span><span class="p">:</span><span class="nb">dict</span><span class="p">([]),</span>
         <span class="s1">&#39;patch_changes_by_track&#39;</span><span class="p">:[],</span> <span class="s1">&#39;patch_changes_total&#39;</span><span class="p">:[],</span>
         <span class="s1">&#39;percussion&#39;</span><span class="p">:{},</span> <span class="s1">&#39;pitches&#39;</span><span class="p">:{},</span> <span class="s1">&#39;pitch_range_by_track&#39;</span><span class="p">:[],</span>
         <span class="s1">&#39;ticks_per_quarter&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;pitch_range_sum&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
    <span class="n">ticks_per_quarter</span> <span class="o">=</span> <span class="n">opus_or_score</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># ignore first element, which is ticks</span>
    <span class="n">nticks</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">opus_or_score</span><span class="p">):</span>
        <span class="n">highest_pitch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">lowest_pitch</span> <span class="o">=</span> <span class="mi">128</span>
        <span class="n">channels_this_track</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="n">patch_changes_this_track</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({})</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">opus_or_score</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note&#39;</span><span class="p">:</span>
                <span class="n">num_notes_by_channel</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="n">num_notes_by_channel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
                    <span class="n">percussion</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> <span class="o">=</span> <span class="n">percussion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pitches</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span>    <span class="o">=</span> <span class="n">pitches</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">highest_pitch</span><span class="p">:</span>
                        <span class="n">highest_pitch</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lowest_pitch</span><span class="p">:</span>
                        <span class="n">lowest_pitch</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">channels_this_track</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">channels_total</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">finish_time</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">finish_time</span> <span class="o">&gt;</span> <span class="n">nticks</span><span class="p">:</span>
                    <span class="n">nticks</span> <span class="o">=</span> <span class="n">finish_time</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note_off&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note_on&#39;</span> <span class="ow">and</span> <span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>  <span class="c1"># 4.8</span>
                <span class="n">finish_time</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">finish_time</span> <span class="o">&gt;</span> <span class="n">nticks</span><span class="p">:</span>
                    <span class="n">nticks</span> <span class="o">=</span> <span class="n">finish_time</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note_on&#39;</span><span class="p">:</span>
                <span class="n">is_a_score</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">num_notes_by_channel</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">num_notes_by_channel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
                    <span class="n">percussion</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="n">percussion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pitches</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>    <span class="o">=</span> <span class="n">pitches</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">highest_pitch</span><span class="p">:</span>
                        <span class="n">highest_pitch</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lowest_pitch</span><span class="p">:</span>
                        <span class="n">lowest_pitch</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">channels_this_track</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">channels_total</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;patch_change&#39;</span><span class="p">:</span>
                <span class="n">patch_changes_this_track</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">patch_changes_total</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control_change&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># bank select MSB</span>
                    <span class="n">bank_select_msb</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">32</span><span class="p">:</span>  <span class="c1"># bank select LSB</span>
                    <span class="n">bank_select_lsb</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">bank_select_msb</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">bank_select_lsb</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">bank_select</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">bank_select_msb</span><span class="p">,</span><span class="n">bank_select_lsb</span><span class="p">))</span>
                    <span class="n">bank_select_msb</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">bank_select_lsb</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;sysex_f0&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_sysex2midimode</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">general_midi_mode</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_sysex2midimode</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">is_a_score</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">nticks</span><span class="p">:</span>
                    <span class="n">nticks</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nticks</span> <span class="o">+=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">lowest_pitch</span> <span class="o">==</span> <span class="mi">128</span><span class="p">:</span>
            <span class="n">lowest_pitch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">channels_by_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">channels_this_track</span><span class="p">)</span>
        <span class="n">patch_changes_by_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">patch_changes_this_track</span><span class="p">)</span>
        <span class="n">pitch_range_by_track</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">lowest_pitch</span><span class="p">,</span><span class="n">highest_pitch</span><span class="p">))</span>
        <span class="n">pitch_range_sum</span> <span class="o">+=</span> <span class="p">(</span><span class="n">highest_pitch</span><span class="o">-</span><span class="n">lowest_pitch</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;bank_select&#39;</span><span class="p">:</span><span class="n">bank_select</span><span class="p">,</span>
            <span class="s1">&#39;channels_by_track&#39;</span><span class="p">:</span><span class="n">channels_by_track</span><span class="p">,</span>
            <span class="s1">&#39;channels_total&#39;</span><span class="p">:</span><span class="n">channels_total</span><span class="p">,</span>
            <span class="s1">&#39;general_midi_mode&#39;</span><span class="p">:</span><span class="n">general_midi_mode</span><span class="p">,</span>
            <span class="s1">&#39;ntracks&#39;</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">opus_or_score</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;nticks&#39;</span><span class="p">:</span><span class="n">nticks</span><span class="p">,</span>
            <span class="s1">&#39;num_notes_by_channel&#39;</span><span class="p">:</span><span class="n">num_notes_by_channel</span><span class="p">,</span>
            <span class="s1">&#39;patch_changes_by_track&#39;</span><span class="p">:</span><span class="n">patch_changes_by_track</span><span class="p">,</span>
            <span class="s1">&#39;patch_changes_total&#39;</span><span class="p">:</span><span class="n">patch_changes_total</span><span class="p">,</span>
            <span class="s1">&#39;percussion&#39;</span><span class="p">:</span><span class="n">percussion</span><span class="p">,</span>
            <span class="s1">&#39;pitches&#39;</span><span class="p">:</span><span class="n">pitches</span><span class="p">,</span>
            <span class="s1">&#39;pitch_range_by_track&#39;</span><span class="p">:</span><span class="n">pitch_range_by_track</span><span class="p">,</span>
            <span class="s1">&#39;pitch_range_sum&#39;</span><span class="p">:</span><span class="n">pitch_range_sum</span><span class="p">,</span>
            <span class="s1">&#39;ticks_per_quarter&#39;</span><span class="p">:</span><span class="n">ticks_per_quarter</span><span class="p">}</span>

<span class="c1">#----------------------------- Event stuff --------------------------</span>

<span class="n">_sysex2midimode</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;</span><span class="se">\x7E\x7F\x09\x01\xF7</span><span class="s2">&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;</span><span class="se">\x7E\x7F\x09\x02\xF7</span><span class="s2">&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;</span><span class="se">\x7E\x7F\x09\x03\xF7</span><span class="s2">&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># Some public-access tuples:</span>
<span class="n">MIDI_events</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;note_off note_on key_after_touch</span>
<span class="s1">control_change patch_change channel_after_touch</span>
<span class="s1">pitch_wheel_change&#39;&#39;&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

<span class="n">Text_events</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;text_event copyright_text_event</span>
<span class="s1">track_name instrument_name lyric marker cue_point text_event_08</span>
<span class="s1">text_event_09 text_event_0a text_event_0b text_event_0c</span>
<span class="s1">text_event_0d text_event_0e text_event_0f&#39;&#39;&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

<span class="n">Nontext_meta_events</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;end_track set_tempo</span>
<span class="s1">smpte_offset time_signature key_signature sequencer_specific</span>
<span class="s1">raw_meta_event sysex_f0 sysex_f7 song_position song_select</span>
<span class="s1">tune_request&#39;&#39;&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
<span class="c1"># unsupported: raw_data</span>

<span class="c1"># Actually, &#39;tune_request&#39; is is F-series event, not strictly a meta-event...</span>
<span class="n">Meta_events</span> <span class="o">=</span> <span class="n">Text_events</span> <span class="o">+</span> <span class="n">Nontext_meta_events</span>
<span class="n">All_events</span>  <span class="o">=</span> <span class="n">MIDI_events</span> <span class="o">+</span> <span class="n">Meta_events</span>

<span class="c1"># And three dictionaries:</span>
<span class="n">Number2patch</span> <span class="o">=</span> <span class="p">{</span>   <span class="c1"># General MIDI patch numbers:</span>
<span class="mi">0</span><span class="p">:</span><span class="s1">&#39;Acoustic Grand&#39;</span><span class="p">,</span>
<span class="mi">1</span><span class="p">:</span><span class="s1">&#39;Bright Acoustic&#39;</span><span class="p">,</span>
<span class="mi">2</span><span class="p">:</span><span class="s1">&#39;Electric Grand&#39;</span><span class="p">,</span>
<span class="mi">3</span><span class="p">:</span><span class="s1">&#39;Honky-Tonk&#39;</span><span class="p">,</span>
<span class="mi">4</span><span class="p">:</span><span class="s1">&#39;Electric Piano 1&#39;</span><span class="p">,</span>
<span class="mi">5</span><span class="p">:</span><span class="s1">&#39;Electric Piano 2&#39;</span><span class="p">,</span>
<span class="mi">6</span><span class="p">:</span><span class="s1">&#39;Harpsichord&#39;</span><span class="p">,</span>
<span class="mi">7</span><span class="p">:</span><span class="s1">&#39;Clav&#39;</span><span class="p">,</span>
<span class="mi">8</span><span class="p">:</span><span class="s1">&#39;Celesta&#39;</span><span class="p">,</span>
<span class="mi">9</span><span class="p">:</span><span class="s1">&#39;Glockenspiel&#39;</span><span class="p">,</span>
<span class="mi">10</span><span class="p">:</span><span class="s1">&#39;Music Box&#39;</span><span class="p">,</span>
<span class="mi">11</span><span class="p">:</span><span class="s1">&#39;Vibraphone&#39;</span><span class="p">,</span>
<span class="mi">12</span><span class="p">:</span><span class="s1">&#39;Marimba&#39;</span><span class="p">,</span>
<span class="mi">13</span><span class="p">:</span><span class="s1">&#39;Xylophone&#39;</span><span class="p">,</span>
<span class="mi">14</span><span class="p">:</span><span class="s1">&#39;Tubular Bells&#39;</span><span class="p">,</span>
<span class="mi">15</span><span class="p">:</span><span class="s1">&#39;Dulcimer&#39;</span><span class="p">,</span>
<span class="mi">16</span><span class="p">:</span><span class="s1">&#39;Drawbar Organ&#39;</span><span class="p">,</span>
<span class="mi">17</span><span class="p">:</span><span class="s1">&#39;Percussive Organ&#39;</span><span class="p">,</span>
<span class="mi">18</span><span class="p">:</span><span class="s1">&#39;Rock Organ&#39;</span><span class="p">,</span>
<span class="mi">19</span><span class="p">:</span><span class="s1">&#39;Church Organ&#39;</span><span class="p">,</span>
<span class="mi">20</span><span class="p">:</span><span class="s1">&#39;Reed Organ&#39;</span><span class="p">,</span>
<span class="mi">21</span><span class="p">:</span><span class="s1">&#39;Accordion&#39;</span><span class="p">,</span>
<span class="mi">22</span><span class="p">:</span><span class="s1">&#39;Harmonica&#39;</span><span class="p">,</span>
<span class="mi">23</span><span class="p">:</span><span class="s1">&#39;Tango Accordion&#39;</span><span class="p">,</span>
<span class="mi">24</span><span class="p">:</span><span class="s1">&#39;Acoustic Guitar(nylon)&#39;</span><span class="p">,</span>
<span class="mi">25</span><span class="p">:</span><span class="s1">&#39;Acoustic Guitar(steel)&#39;</span><span class="p">,</span>
<span class="mi">26</span><span class="p">:</span><span class="s1">&#39;Electric Guitar(jazz)&#39;</span><span class="p">,</span>
<span class="mi">27</span><span class="p">:</span><span class="s1">&#39;Electric Guitar(clean)&#39;</span><span class="p">,</span>
<span class="mi">28</span><span class="p">:</span><span class="s1">&#39;Electric Guitar(muted)&#39;</span><span class="p">,</span>
<span class="mi">29</span><span class="p">:</span><span class="s1">&#39;Overdriven Guitar&#39;</span><span class="p">,</span>
<span class="mi">30</span><span class="p">:</span><span class="s1">&#39;Distortion Guitar&#39;</span><span class="p">,</span>
<span class="mi">31</span><span class="p">:</span><span class="s1">&#39;Guitar Harmonics&#39;</span><span class="p">,</span>
<span class="mi">32</span><span class="p">:</span><span class="s1">&#39;Acoustic Bass&#39;</span><span class="p">,</span>
<span class="mi">33</span><span class="p">:</span><span class="s1">&#39;Electric Bass(finger)&#39;</span><span class="p">,</span>
<span class="mi">34</span><span class="p">:</span><span class="s1">&#39;Electric Bass(pick)&#39;</span><span class="p">,</span>
<span class="mi">35</span><span class="p">:</span><span class="s1">&#39;Fretless Bass&#39;</span><span class="p">,</span>
<span class="mi">36</span><span class="p">:</span><span class="s1">&#39;Slap Bass 1&#39;</span><span class="p">,</span>
<span class="mi">37</span><span class="p">:</span><span class="s1">&#39;Slap Bass 2&#39;</span><span class="p">,</span>
<span class="mi">38</span><span class="p">:</span><span class="s1">&#39;Synth Bass 1&#39;</span><span class="p">,</span>
<span class="mi">39</span><span class="p">:</span><span class="s1">&#39;Synth Bass 2&#39;</span><span class="p">,</span>
<span class="mi">40</span><span class="p">:</span><span class="s1">&#39;Violin&#39;</span><span class="p">,</span>
<span class="mi">41</span><span class="p">:</span><span class="s1">&#39;Viola&#39;</span><span class="p">,</span>
<span class="mi">42</span><span class="p">:</span><span class="s1">&#39;Cello&#39;</span><span class="p">,</span>
<span class="mi">43</span><span class="p">:</span><span class="s1">&#39;Contrabass&#39;</span><span class="p">,</span>
<span class="mi">44</span><span class="p">:</span><span class="s1">&#39;Tremolo Strings&#39;</span><span class="p">,</span>
<span class="mi">45</span><span class="p">:</span><span class="s1">&#39;Pizzicato Strings&#39;</span><span class="p">,</span>
<span class="mi">46</span><span class="p">:</span><span class="s1">&#39;Orchestral Harp&#39;</span><span class="p">,</span>
<span class="mi">47</span><span class="p">:</span><span class="s1">&#39;Timpani&#39;</span><span class="p">,</span>
<span class="mi">48</span><span class="p">:</span><span class="s1">&#39;String Ensemble 1&#39;</span><span class="p">,</span>
<span class="mi">49</span><span class="p">:</span><span class="s1">&#39;String Ensemble 2&#39;</span><span class="p">,</span>
<span class="mi">50</span><span class="p">:</span><span class="s1">&#39;SynthStrings 1&#39;</span><span class="p">,</span>
<span class="mi">51</span><span class="p">:</span><span class="s1">&#39;SynthStrings 2&#39;</span><span class="p">,</span>
<span class="mi">52</span><span class="p">:</span><span class="s1">&#39;Choir Aahs&#39;</span><span class="p">,</span>
<span class="mi">53</span><span class="p">:</span><span class="s1">&#39;Voice Oohs&#39;</span><span class="p">,</span>
<span class="mi">54</span><span class="p">:</span><span class="s1">&#39;Synth Voice&#39;</span><span class="p">,</span>
<span class="mi">55</span><span class="p">:</span><span class="s1">&#39;Orchestra Hit&#39;</span><span class="p">,</span>
<span class="mi">56</span><span class="p">:</span><span class="s1">&#39;Trumpet&#39;</span><span class="p">,</span>
<span class="mi">57</span><span class="p">:</span><span class="s1">&#39;Trombone&#39;</span><span class="p">,</span>
<span class="mi">58</span><span class="p">:</span><span class="s1">&#39;Tuba&#39;</span><span class="p">,</span>
<span class="mi">59</span><span class="p">:</span><span class="s1">&#39;Muted Trumpet&#39;</span><span class="p">,</span>
<span class="mi">60</span><span class="p">:</span><span class="s1">&#39;French Horn&#39;</span><span class="p">,</span>
<span class="mi">61</span><span class="p">:</span><span class="s1">&#39;Brass Section&#39;</span><span class="p">,</span>
<span class="mi">62</span><span class="p">:</span><span class="s1">&#39;SynthBrass 1&#39;</span><span class="p">,</span>
<span class="mi">63</span><span class="p">:</span><span class="s1">&#39;SynthBrass 2&#39;</span><span class="p">,</span>
<span class="mi">64</span><span class="p">:</span><span class="s1">&#39;Soprano Sax&#39;</span><span class="p">,</span>
<span class="mi">65</span><span class="p">:</span><span class="s1">&#39;Alto Sax&#39;</span><span class="p">,</span>
<span class="mi">66</span><span class="p">:</span><span class="s1">&#39;Tenor Sax&#39;</span><span class="p">,</span>
<span class="mi">67</span><span class="p">:</span><span class="s1">&#39;Baritone Sax&#39;</span><span class="p">,</span>
<span class="mi">68</span><span class="p">:</span><span class="s1">&#39;Oboe&#39;</span><span class="p">,</span>
<span class="mi">69</span><span class="p">:</span><span class="s1">&#39;English Horn&#39;</span><span class="p">,</span>
<span class="mi">70</span><span class="p">:</span><span class="s1">&#39;Bassoon&#39;</span><span class="p">,</span>
<span class="mi">71</span><span class="p">:</span><span class="s1">&#39;Clarinet&#39;</span><span class="p">,</span>
<span class="mi">72</span><span class="p">:</span><span class="s1">&#39;Piccolo&#39;</span><span class="p">,</span>
<span class="mi">73</span><span class="p">:</span><span class="s1">&#39;Flute&#39;</span><span class="p">,</span>
<span class="mi">74</span><span class="p">:</span><span class="s1">&#39;Recorder&#39;</span><span class="p">,</span>
<span class="mi">75</span><span class="p">:</span><span class="s1">&#39;Pan Flute&#39;</span><span class="p">,</span>
<span class="mi">76</span><span class="p">:</span><span class="s1">&#39;Blown Bottle&#39;</span><span class="p">,</span>
<span class="mi">77</span><span class="p">:</span><span class="s1">&#39;Skakuhachi&#39;</span><span class="p">,</span>
<span class="mi">78</span><span class="p">:</span><span class="s1">&#39;Whistle&#39;</span><span class="p">,</span>
<span class="mi">79</span><span class="p">:</span><span class="s1">&#39;Ocarina&#39;</span><span class="p">,</span>
<span class="mi">80</span><span class="p">:</span><span class="s1">&#39;Lead 1 (square)&#39;</span><span class="p">,</span>
<span class="mi">81</span><span class="p">:</span><span class="s1">&#39;Lead 2 (sawtooth)&#39;</span><span class="p">,</span>
<span class="mi">82</span><span class="p">:</span><span class="s1">&#39;Lead 3 (calliope)&#39;</span><span class="p">,</span>
<span class="mi">83</span><span class="p">:</span><span class="s1">&#39;Lead 4 (chiff)&#39;</span><span class="p">,</span>
<span class="mi">84</span><span class="p">:</span><span class="s1">&#39;Lead 5 (charang)&#39;</span><span class="p">,</span>
<span class="mi">85</span><span class="p">:</span><span class="s1">&#39;Lead 6 (voice)&#39;</span><span class="p">,</span>
<span class="mi">86</span><span class="p">:</span><span class="s1">&#39;Lead 7 (fifths)&#39;</span><span class="p">,</span>
<span class="mi">87</span><span class="p">:</span><span class="s1">&#39;Lead 8 (bass+lead)&#39;</span><span class="p">,</span>
<span class="mi">88</span><span class="p">:</span><span class="s1">&#39;Pad 1 (new age)&#39;</span><span class="p">,</span>
<span class="mi">89</span><span class="p">:</span><span class="s1">&#39;Pad 2 (warm)&#39;</span><span class="p">,</span>
<span class="mi">90</span><span class="p">:</span><span class="s1">&#39;Pad 3 (polysynth)&#39;</span><span class="p">,</span>
<span class="mi">91</span><span class="p">:</span><span class="s1">&#39;Pad 4 (choir)&#39;</span><span class="p">,</span>
<span class="mi">92</span><span class="p">:</span><span class="s1">&#39;Pad 5 (bowed)&#39;</span><span class="p">,</span>
<span class="mi">93</span><span class="p">:</span><span class="s1">&#39;Pad 6 (metallic)&#39;</span><span class="p">,</span>
<span class="mi">94</span><span class="p">:</span><span class="s1">&#39;Pad 7 (halo)&#39;</span><span class="p">,</span>
<span class="mi">95</span><span class="p">:</span><span class="s1">&#39;Pad 8 (sweep)&#39;</span><span class="p">,</span>
<span class="mi">96</span><span class="p">:</span><span class="s1">&#39;FX 1 (rain)&#39;</span><span class="p">,</span>
<span class="mi">97</span><span class="p">:</span><span class="s1">&#39;FX 2 (soundtrack)&#39;</span><span class="p">,</span>
<span class="mi">98</span><span class="p">:</span><span class="s1">&#39;FX 3 (crystal)&#39;</span><span class="p">,</span>
<span class="mi">99</span><span class="p">:</span><span class="s1">&#39;FX 4 (atmosphere)&#39;</span><span class="p">,</span>
<span class="mi">100</span><span class="p">:</span><span class="s1">&#39;FX 5 (brightness)&#39;</span><span class="p">,</span>
<span class="mi">101</span><span class="p">:</span><span class="s1">&#39;FX 6 (goblins)&#39;</span><span class="p">,</span>
<span class="mi">102</span><span class="p">:</span><span class="s1">&#39;FX 7 (echoes)&#39;</span><span class="p">,</span>
<span class="mi">103</span><span class="p">:</span><span class="s1">&#39;FX 8 (sci-fi)&#39;</span><span class="p">,</span>
<span class="mi">104</span><span class="p">:</span><span class="s1">&#39;Sitar&#39;</span><span class="p">,</span>
<span class="mi">105</span><span class="p">:</span><span class="s1">&#39;Banjo&#39;</span><span class="p">,</span>
<span class="mi">106</span><span class="p">:</span><span class="s1">&#39;Shamisen&#39;</span><span class="p">,</span>
<span class="mi">107</span><span class="p">:</span><span class="s1">&#39;Koto&#39;</span><span class="p">,</span>
<span class="mi">108</span><span class="p">:</span><span class="s1">&#39;Kalimba&#39;</span><span class="p">,</span>
<span class="mi">109</span><span class="p">:</span><span class="s1">&#39;Bagpipe&#39;</span><span class="p">,</span>
<span class="mi">110</span><span class="p">:</span><span class="s1">&#39;Fiddle&#39;</span><span class="p">,</span>
<span class="mi">111</span><span class="p">:</span><span class="s1">&#39;Shanai&#39;</span><span class="p">,</span>
<span class="mi">112</span><span class="p">:</span><span class="s1">&#39;Tinkle Bell&#39;</span><span class="p">,</span>
<span class="mi">113</span><span class="p">:</span><span class="s1">&#39;Agogo&#39;</span><span class="p">,</span>
<span class="mi">114</span><span class="p">:</span><span class="s1">&#39;Steel Drums&#39;</span><span class="p">,</span>
<span class="mi">115</span><span class="p">:</span><span class="s1">&#39;Woodblock&#39;</span><span class="p">,</span>
<span class="mi">116</span><span class="p">:</span><span class="s1">&#39;Taiko Drum&#39;</span><span class="p">,</span>
<span class="mi">117</span><span class="p">:</span><span class="s1">&#39;Melodic Tom&#39;</span><span class="p">,</span>
<span class="mi">118</span><span class="p">:</span><span class="s1">&#39;Synth Drum&#39;</span><span class="p">,</span>
<span class="mi">119</span><span class="p">:</span><span class="s1">&#39;Reverse Cymbal&#39;</span><span class="p">,</span>
<span class="mi">120</span><span class="p">:</span><span class="s1">&#39;Guitar Fret Noise&#39;</span><span class="p">,</span>
<span class="mi">121</span><span class="p">:</span><span class="s1">&#39;Breath Noise&#39;</span><span class="p">,</span>
<span class="mi">122</span><span class="p">:</span><span class="s1">&#39;Seashore&#39;</span><span class="p">,</span>
<span class="mi">123</span><span class="p">:</span><span class="s1">&#39;Bird Tweet&#39;</span><span class="p">,</span>
<span class="mi">124</span><span class="p">:</span><span class="s1">&#39;Telephone Ring&#39;</span><span class="p">,</span>
<span class="mi">125</span><span class="p">:</span><span class="s1">&#39;Helicopter&#39;</span><span class="p">,</span>
<span class="mi">126</span><span class="p">:</span><span class="s1">&#39;Applause&#39;</span><span class="p">,</span>
<span class="mi">127</span><span class="p">:</span><span class="s1">&#39;Gunshot&#39;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">Notenum2percussion</span> <span class="o">=</span> <span class="p">{</span>   <span class="c1"># General MIDI Percussion (on Channel 9):</span>
<span class="mi">35</span><span class="p">:</span><span class="s1">&#39;Acoustic Bass Drum&#39;</span><span class="p">,</span>
<span class="mi">36</span><span class="p">:</span><span class="s1">&#39;Bass Drum 1&#39;</span><span class="p">,</span>
<span class="mi">37</span><span class="p">:</span><span class="s1">&#39;Side Stick&#39;</span><span class="p">,</span>
<span class="mi">38</span><span class="p">:</span><span class="s1">&#39;Acoustic Snare&#39;</span><span class="p">,</span>
<span class="mi">39</span><span class="p">:</span><span class="s1">&#39;Hand Clap&#39;</span><span class="p">,</span>
<span class="mi">40</span><span class="p">:</span><span class="s1">&#39;Electric Snare&#39;</span><span class="p">,</span>
<span class="mi">41</span><span class="p">:</span><span class="s1">&#39;Low Floor Tom&#39;</span><span class="p">,</span>
<span class="mi">42</span><span class="p">:</span><span class="s1">&#39;Closed Hi-Hat&#39;</span><span class="p">,</span>
<span class="mi">43</span><span class="p">:</span><span class="s1">&#39;High Floor Tom&#39;</span><span class="p">,</span>
<span class="mi">44</span><span class="p">:</span><span class="s1">&#39;Pedal Hi-Hat&#39;</span><span class="p">,</span>
<span class="mi">45</span><span class="p">:</span><span class="s1">&#39;Low Tom&#39;</span><span class="p">,</span>
<span class="mi">46</span><span class="p">:</span><span class="s1">&#39;Open Hi-Hat&#39;</span><span class="p">,</span>
<span class="mi">47</span><span class="p">:</span><span class="s1">&#39;Low-Mid Tom&#39;</span><span class="p">,</span>
<span class="mi">48</span><span class="p">:</span><span class="s1">&#39;Hi-Mid Tom&#39;</span><span class="p">,</span>
<span class="mi">49</span><span class="p">:</span><span class="s1">&#39;Crash Cymbal 1&#39;</span><span class="p">,</span>
<span class="mi">50</span><span class="p">:</span><span class="s1">&#39;High Tom&#39;</span><span class="p">,</span>
<span class="mi">51</span><span class="p">:</span><span class="s1">&#39;Ride Cymbal 1&#39;</span><span class="p">,</span>
<span class="mi">52</span><span class="p">:</span><span class="s1">&#39;Chinese Cymbal&#39;</span><span class="p">,</span>
<span class="mi">53</span><span class="p">:</span><span class="s1">&#39;Ride Bell&#39;</span><span class="p">,</span>
<span class="mi">54</span><span class="p">:</span><span class="s1">&#39;Tambourine&#39;</span><span class="p">,</span>
<span class="mi">55</span><span class="p">:</span><span class="s1">&#39;Splash Cymbal&#39;</span><span class="p">,</span>
<span class="mi">56</span><span class="p">:</span><span class="s1">&#39;Cowbell&#39;</span><span class="p">,</span>
<span class="mi">57</span><span class="p">:</span><span class="s1">&#39;Crash Cymbal 2&#39;</span><span class="p">,</span>
<span class="mi">58</span><span class="p">:</span><span class="s1">&#39;Vibraslap&#39;</span><span class="p">,</span>
<span class="mi">59</span><span class="p">:</span><span class="s1">&#39;Ride Cymbal 2&#39;</span><span class="p">,</span>
<span class="mi">60</span><span class="p">:</span><span class="s1">&#39;Hi Bongo&#39;</span><span class="p">,</span>
<span class="mi">61</span><span class="p">:</span><span class="s1">&#39;Low Bongo&#39;</span><span class="p">,</span>
<span class="mi">62</span><span class="p">:</span><span class="s1">&#39;Mute Hi Conga&#39;</span><span class="p">,</span>
<span class="mi">63</span><span class="p">:</span><span class="s1">&#39;Open Hi Conga&#39;</span><span class="p">,</span>
<span class="mi">64</span><span class="p">:</span><span class="s1">&#39;Low Conga&#39;</span><span class="p">,</span>
<span class="mi">65</span><span class="p">:</span><span class="s1">&#39;High Timbale&#39;</span><span class="p">,</span>
<span class="mi">66</span><span class="p">:</span><span class="s1">&#39;Low Timbale&#39;</span><span class="p">,</span>
<span class="mi">67</span><span class="p">:</span><span class="s1">&#39;High Agogo&#39;</span><span class="p">,</span>
<span class="mi">68</span><span class="p">:</span><span class="s1">&#39;Low Agogo&#39;</span><span class="p">,</span>
<span class="mi">69</span><span class="p">:</span><span class="s1">&#39;Cabasa&#39;</span><span class="p">,</span>
<span class="mi">70</span><span class="p">:</span><span class="s1">&#39;Maracas&#39;</span><span class="p">,</span>
<span class="mi">71</span><span class="p">:</span><span class="s1">&#39;Short Whistle&#39;</span><span class="p">,</span>
<span class="mi">72</span><span class="p">:</span><span class="s1">&#39;Long Whistle&#39;</span><span class="p">,</span>
<span class="mi">73</span><span class="p">:</span><span class="s1">&#39;Short Guiro&#39;</span><span class="p">,</span>
<span class="mi">74</span><span class="p">:</span><span class="s1">&#39;Long Guiro&#39;</span><span class="p">,</span>
<span class="mi">75</span><span class="p">:</span><span class="s1">&#39;Claves&#39;</span><span class="p">,</span>
<span class="mi">76</span><span class="p">:</span><span class="s1">&#39;Hi Wood Block&#39;</span><span class="p">,</span>
<span class="mi">77</span><span class="p">:</span><span class="s1">&#39;Low Wood Block&#39;</span><span class="p">,</span>
<span class="mi">78</span><span class="p">:</span><span class="s1">&#39;Mute Cuica&#39;</span><span class="p">,</span>
<span class="mi">79</span><span class="p">:</span><span class="s1">&#39;Open Cuica&#39;</span><span class="p">,</span>
<span class="mi">80</span><span class="p">:</span><span class="s1">&#39;Mute Triangle&#39;</span><span class="p">,</span>
<span class="mi">81</span><span class="p">:</span><span class="s1">&#39;Open Triangle&#39;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">Event2channelindex</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;note&#39;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;note_off&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;note_on&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
 <span class="s1">&#39;key_after_touch&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;control_change&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;patch_change&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
 <span class="s1">&#39;channel_after_touch&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;pitch_wheel_change&#39;</span><span class="p">:</span><span class="mi">2</span>
<span class="p">}</span>

<span class="c1">################################################################</span>
<span class="c1"># The code below this line is full of frightening things, all to</span>
<span class="c1"># do with the actual encoding and decoding of binary MIDI data.</span>

<span class="k">def</span> <span class="nf">_twobytes2int</span><span class="p">(</span><span class="n">byte_a</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;decode a 16 bit quantity from two bytes,&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">byte_a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">byte_a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_int2twobytes</span><span class="p">(</span><span class="n">int_16bit</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;encode a 16 bit quantity into two bytes,&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="nb">bytes</span><span class="p">([(</span><span class="n">int_16bit</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">int_16bit</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">_read_14_bit</span><span class="p">(</span><span class="n">byte_a</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;decode a 14 bit quantity from two bytes,&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">byte_a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">byte_a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_write_14_bit</span><span class="p">(</span><span class="n">int_14bit</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;encode a 14 bit quantity into two bytes,&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">int_14bit</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">,</span> <span class="p">(</span><span class="n">int_14bit</span><span class="o">&gt;&gt;</span><span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">_ber_compressed_int</span><span class="p">(</span><span class="n">integer</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;BER compressed integer (not an ASN.1 BER, see perlpacktut for</span>
<span class="sd">details).  Its bytes represent an unsigned integer in base 128,</span>
<span class="sd">most significant digit first, with as few digits as possible.</span>
<span class="sd">Bit eight (the high bit) is set on each byte except the last.</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="n">ber</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">seven_bits</span> <span class="o">=</span> <span class="mh">0x7F</span> <span class="o">&amp;</span> <span class="n">integer</span>
    <span class="n">ber</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">seven_bits</span><span class="p">)</span>  <span class="c1"># XXX surely should convert to a char ?</span>
    <span class="n">integer</span> <span class="o">&gt;&gt;=</span> <span class="mi">7</span>
    <span class="k">while</span> <span class="n">integer</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">seven_bits</span> <span class="o">=</span> <span class="mh">0x7F</span> <span class="o">&amp;</span> <span class="n">integer</span>
        <span class="n">ber</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x80</span><span class="o">|</span><span class="n">seven_bits</span><span class="p">)</span>  <span class="c1"># XXX surely should convert to a char ?</span>
        <span class="n">integer</span> <span class="o">&gt;&gt;=</span> <span class="mi">7</span>
    <span class="k">return</span> <span class="n">ber</span>

<span class="k">def</span> <span class="nf">_unshift_ber_int</span><span class="p">(</span><span class="n">ba</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Given a bytearray, returns a tuple of (the ber-integer at the</span>
<span class="sd">start, and the remainder of the bytearray).</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">ba</span><span class="p">):</span>   <span class="c1"># 6.7</span>
        <span class="n">_warn</span><span class="p">(</span><span class="s1">&#39;_unshift_ber_int: no integer found&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">))</span>
    <span class="n">byte</span> <span class="o">=</span> <span class="n">ba</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">integer</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">integer</span> <span class="o">+=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">byte</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">((</span><span class="n">integer</span><span class="p">,</span> <span class="n">ba</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">ba</span><span class="p">):</span>
            <span class="n">_warn</span><span class="p">(</span><span class="s1">&#39;_unshift_ber_int: no end-of-integer found&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">ba</span><span class="p">))</span>
        <span class="n">byte</span> <span class="o">=</span> <span class="n">ba</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">integer</span> <span class="o">&lt;&lt;=</span> <span class="mi">7</span>

<span class="k">def</span> <span class="nf">_clean_up_warnings</span><span class="p">():</span>  <span class="c1"># 5.4</span>
    <span class="c1"># Call this before returning from any publicly callable function</span>
    <span class="c1"># whenever there&#39;s a possibility that a warning might have been printed</span>
    <span class="c1"># by the function, or by any private functions it might have called.</span>
    <span class="k">global</span> <span class="n">_previous_times</span>
    <span class="k">global</span> <span class="n">_previous_warning</span>
    <span class="k">if</span> <span class="n">_previous_times</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># E:1176, 0: invalid syntax (&lt;string&gt;, line 1176) (syntax-error) ???</span>
        <span class="c1"># print(&#39;  previous message repeated &#39;+str(_previous_times)+&#39; times&#39;, file=sys.stderr)</span>
        <span class="c1"># 6.7</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  previous message repeated </span><span class="si">{0}</span><span class="s1"> times</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_previous_times</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">_previous_times</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  previous message repeated</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">_previous_times</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">_previous_warning</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<span class="k">def</span> <span class="nf">_warn</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">_previous_times</span>
    <span class="k">global</span> <span class="n">_previous_warning</span>
    <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="n">_previous_warning</span><span class="p">:</span>  <span class="c1"># 5.4</span>
        <span class="n">_previous_times</span> <span class="o">=</span> <span class="n">_previous_times</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_clean_up_warnings</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">_previous_warning</span> <span class="o">=</span> <span class="n">s</span>

<span class="k">def</span> <span class="nf">_some_text_event</span><span class="p">(</span><span class="n">which_kind</span><span class="o">=</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;some_text&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">text</span><span class="p">))</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;&#39;str&#39;&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>   <span class="c1"># 6.4 test for back-compatibility</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xFF</span><span class="s1">&#39;</span><span class="o">+</span><span class="nb">bytes</span><span class="p">((</span><span class="n">which_kind</span><span class="p">,))</span><span class="o">+</span><span class="n">_ber_compressed_int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span><span class="o">+</span><span class="n">data</span>

<span class="k">def</span> <span class="nf">_consistentise_ticks</span><span class="p">(</span><span class="n">scores</span><span class="p">):</span>  <span class="c1"># 3.6</span>
    <span class="c1"># used by mix_scores, merge_scores, concatenate_scores</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
         <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
    <span class="n">are_consistent</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">ticks</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">iscore</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">iscore</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">scores</span><span class="p">[</span><span class="n">iscore</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ticks</span><span class="p">:</span>
            <span class="n">are_consistent</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">break</span>
        <span class="n">iscore</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">are_consistent</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
    <span class="n">new_scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">iscore</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">iscore</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">):</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">iscore</span><span class="p">]</span>
        <span class="n">new_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opus2score</span><span class="p">(</span><span class="n">to_millisecs</span><span class="p">(</span><span class="n">score2opus</span><span class="p">(</span><span class="n">score</span><span class="p">))))</span>
        <span class="n">iscore</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">new_scores</span>


<span class="c1">###########################################################################</span>

<span class="k">def</span> <span class="nf">_decode</span><span class="p">(</span><span class="n">trackdata</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
 <span class="n">event_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclusive_event_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">no_eot_magic</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Decodes MIDI track data into an opus-style list of events.</span>
<span class="sd">The options:</span>
<span class="sd">  &#39;exclude&#39; is a list of event types which will be ignored SHOULD BE A SET</span>
<span class="sd">  &#39;include&#39; (and no exclude), makes exclude a list</span>
<span class="sd">       of all possible events, /minus/ what include specifies</span>
<span class="sd">  &#39;event_callback&#39; is a coderef</span>
<span class="sd">  &#39;exclusive_event_callback&#39; is a coderef</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="n">trackdata</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">trackdata</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">exclude</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">include</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">include</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">include</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">exclude</span><span class="p">:</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="n">All_events</span>
    <span class="n">include</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">include</span><span class="p">)</span>
    <span class="n">exclude</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">exclude</span><span class="p">)</span>

    <span class="c1"># Pointer = 0;  not used here; we eat through the bytearray instead.</span>
    <span class="n">event_code</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="c1"># used for running status</span>
    <span class="n">event_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">while</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trackdata</span><span class="p">)):</span>
        <span class="c1"># loop while there&#39;s anything to analyze ...</span>
        <span class="n">eot</span> <span class="o">=</span> <span class="kc">False</span>   <span class="c1"># When True, the event registrar aborts this loop</span>
        <span class="n">event_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">E</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># E for events - we&#39;ll feed it to the event registrar at the end.</span>

        <span class="c1"># Slice off the delta time code, and analyze it</span>
        <span class="p">[</span><span class="n">time</span><span class="p">,</span> <span class="n">remainder</span><span class="p">]</span> <span class="o">=</span> <span class="n">_unshift_ber_int</span><span class="p">(</span><span class="n">trackdata</span><span class="p">)</span>

        <span class="c1"># Now let&#39;s see what we can make of the command</span>
        <span class="n">first_byte</span> <span class="o">=</span> <span class="n">trackdata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">first_byte</span> <span class="o">&lt;</span> <span class="mh">0xF0</span><span class="p">):</span>  <span class="c1"># It&#39;s a MIDI event</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">first_byte</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">):</span>
                <span class="n">event_code</span> <span class="o">=</span> <span class="n">first_byte</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># It wants running status; use last event_code value</span>
                <span class="n">trackdata</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">first_byte</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">event_code</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">_warn</span><span class="p">(</span><span class="s2">&quot;Running status not set; Aborting track.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="p">[]</span>

            <span class="n">command</span> <span class="o">=</span> <span class="n">event_code</span> <span class="o">&amp;</span> <span class="mh">0xF0</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="n">event_code</span> <span class="o">&amp;</span> <span class="mh">0x0F</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0xF6</span><span class="p">):</span>  <span class="c1">#  0-byte argument</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0xC0</span> <span class="ow">or</span> <span class="n">command</span> <span class="o">==</span> <span class="mh">0xD0</span><span class="p">):</span>  <span class="c1">#  1-byte argument</span>
                <span class="n">parameter</span> <span class="o">=</span> <span class="n">trackdata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># could be B</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># 2-byte argument could be BB or 14-bit</span>
                <span class="n">parameter</span> <span class="o">=</span> <span class="p">(</span><span class="n">trackdata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">trackdata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

            <span class="c1">#################################################################</span>
            <span class="c1"># MIDI events</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">command</span>      <span class="o">==</span> <span class="mh">0x80</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;note_off&#39;</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;note_off&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">parameter</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parameter</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x90</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;note_on&#39;</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;note_on&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">parameter</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parameter</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0xA0</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;key_after_touch&#39;</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;key_after_touch&#39;</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">channel</span><span class="p">,</span><span class="n">parameter</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">parameter</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0xB0</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;control_change&#39;</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;control_change&#39;</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">channel</span><span class="p">,</span><span class="n">parameter</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">parameter</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0xC0</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;patch_change&#39;</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">parameter</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0xD0</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;channel_after_touch&#39;</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;channel_after_touch&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">parameter</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0xE0</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;pitch_wheel_change&#39;</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pitch_wheel_change&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span>
                 <span class="n">_read_14_bit</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span><span class="o">-</span><span class="mh">0x2000</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_warn</span><span class="p">(</span><span class="s2">&quot;Shouldn&#39;t get here; command=&quot;</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>

        <span class="k">elif</span> <span class="p">(</span><span class="n">first_byte</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">):</span>  <span class="c1"># It&#39;s a Meta-Event! ##################</span>
            <span class="c1">#[command, length, remainder] =</span>
            <span class="c1">#    unpack(&quot;xCwa*&quot;, substr(trackdata, $Pointer, 6));</span>
            <span class="c1">#Pointer += 6 - len(remainder);</span>
            <span class="c1">#    # Move past JUST the length-encoded.</span>
            <span class="n">command</span> <span class="o">=</span> <span class="n">trackdata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
            <span class="p">[</span><span class="n">length</span><span class="p">,</span> <span class="n">trackdata</span><span class="p">]</span> <span class="o">=</span> <span class="n">_unshift_ber_int</span><span class="p">(</span><span class="n">trackdata</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">command</span>      <span class="o">==</span> <span class="mh">0x00</span><span class="p">):</span>
                 <span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
                     <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;set_sequence_number&#39;</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">_twobytes2int</span><span class="p">(</span><span class="n">trackdata</span><span class="p">)]</span>
                 <span class="k">else</span><span class="p">:</span>
                     <span class="n">_warn</span><span class="p">(</span><span class="s1">&#39;set_sequence_number: length must be 2, not &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>
                     <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;set_sequence_number&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

            <span class="k">elif</span> <span class="n">command</span> <span class="o">&gt;=</span> <span class="mh">0x01</span> <span class="ow">and</span> <span class="n">command</span> <span class="o">&lt;=</span> <span class="mh">0x0f</span><span class="p">:</span>   <span class="c1"># Text events</span>
                <span class="c1"># 6.2 take it in bytes; let the user get the right encoding.</span>
                <span class="c1"># text_str = trackdata[0:length].decode(&#39;ascii&#39;,&#39;ignore&#39;)</span>
                <span class="c1"># text_str = trackdata[0:length].decode(&#39;ISO-8859-1&#39;)</span>
                <span class="c1"># 6.4 take it in bytes; let the user get the right encoding.</span>
                <span class="n">text_data</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">trackdata</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">length</span><span class="p">])</span>   <span class="c1"># 6.4</span>
                <span class="c1"># Defined text events</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">):</span>
                     <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;text_event&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">text_data</span><span class="p">]</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x02</span><span class="p">):</span>
                     <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;copyright_text_event&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">text_data</span><span class="p">]</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x03</span><span class="p">):</span>
                     <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;track_name&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">text_data</span><span class="p">]</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">):</span>
                     <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;instrument_name&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">text_data</span><span class="p">]</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x05</span><span class="p">):</span>
                     <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lyric&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">text_data</span><span class="p">]</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x06</span><span class="p">):</span>
                     <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;marker&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">text_data</span><span class="p">]</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x07</span><span class="p">):</span>
                     <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cue_point&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">text_data</span><span class="p">]</span>
                <span class="c1"># Reserved but apparently unassigned text events</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x08</span><span class="p">):</span>
                     <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;text_event_08&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">text_data</span><span class="p">]</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x09</span><span class="p">):</span>
                     <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;text_event_09&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">text_data</span><span class="p">]</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x0a</span><span class="p">):</span>
                     <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;text_event_0a&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">text_data</span><span class="p">]</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x0b</span><span class="p">):</span>
                     <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;text_event_0b&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">text_data</span><span class="p">]</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x0c</span><span class="p">):</span>
                     <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;text_event_0c&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">text_data</span><span class="p">]</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x0d</span><span class="p">):</span>
                     <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;text_event_0d&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">text_data</span><span class="p">]</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x0e</span><span class="p">):</span>
                     <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;text_event_0e&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">text_data</span><span class="p">]</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x0f</span><span class="p">):</span>
                     <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;text_event_0f&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">text_data</span><span class="p">]</span>

            <span class="c1"># Now the sticky events -------------------------------------</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x2F</span><span class="p">):</span>
                 <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;end_track&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">]</span>
                     <span class="c1"># The code for handling this, oddly, comes LATER,</span>
                     <span class="c1"># in the event registrar.</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x51</span><span class="p">):</span> <span class="c1"># DTime, Microseconds/Crochet</span>
                 <span class="k">if</span> <span class="n">length</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                     <span class="n">_warn</span><span class="p">(</span><span class="s1">&#39;set_tempo event, but length=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>
                 <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;set_tempo&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span>
                      <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;I&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">trackdata</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x54</span><span class="p">):</span>
                 <span class="k">if</span> <span class="n">length</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">:</span>   <span class="c1"># DTime, HR, MN, SE, FR, FF</span>
                     <span class="n">_warn</span><span class="p">(</span><span class="s1">&#39;smpte_offset event, but length=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>
                 <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;smpte_offset&#39;</span><span class="p">,</span><span class="n">time</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;BBBBB&quot;</span><span class="p">,</span><span class="n">trackdata</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x58</span><span class="p">):</span>
                 <span class="k">if</span> <span class="n">length</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>   <span class="c1"># DTime, NN, DD, CC, BB</span>
                     <span class="n">_warn</span><span class="p">(</span><span class="s1">&#39;time_signature event, but length=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>
                 <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;time_signature&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">]</span><span class="o">+</span><span class="nb">list</span><span class="p">(</span><span class="n">trackdata</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x59</span><span class="p">):</span>
                 <span class="k">if</span> <span class="n">length</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>   <span class="c1"># DTime, SF(signed), MI</span>
                     <span class="n">_warn</span><span class="p">(</span><span class="s1">&#39;key_signature event, but length=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>
                 <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;key_signature&#39;</span><span class="p">,</span><span class="n">time</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;bB&quot;</span><span class="p">,</span><span class="n">trackdata</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="mh">0x7F</span><span class="p">):</span>   <span class="c1"># 6.4</span>
                 <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sequencer_specific&#39;</span><span class="p">,</span><span class="n">time</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">trackdata</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">length</span><span class="p">])]</span>
            <span class="k">else</span><span class="p">:</span>
                 <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;raw_meta_event&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span>
                   <span class="nb">bytes</span><span class="p">(</span><span class="n">trackdata</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">length</span><span class="p">])]</span>   <span class="c1"># 6.0</span>
                 <span class="c1">#&quot;[uninterpretable meta-event command of length length]&quot;</span>
                 <span class="c1"># DTime, Command, Binary Data</span>
                 <span class="c1"># It&#39;s uninterpretable; record it as raw_data.</span>

            <span class="c1"># Pointer += length; #  Now move Pointer</span>
            <span class="n">trackdata</span> <span class="o">=</span> <span class="n">trackdata</span><span class="p">[</span><span class="n">length</span><span class="p">:]</span>

        <span class="c1">######################################################################</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">first_byte</span> <span class="o">==</span> <span class="mh">0xF0</span> <span class="ow">or</span> <span class="n">first_byte</span> <span class="o">==</span> <span class="mh">0xF7</span><span class="p">):</span>
            <span class="c1"># Note that sysexes in MIDI /files/ are different than sysexes</span>
            <span class="c1"># in MIDI transmissions!! The vast majority of system exclusive</span>
            <span class="c1"># messages will just use the F0 format. For instance, the</span>
            <span class="c1"># transmitted message F0 43 12 00 07 F7 would be stored in a</span>
            <span class="c1"># MIDI file as F0 05 43 12 00 07 F7. As mentioned above, it is</span>
            <span class="c1"># required to include the F7 at the end so that the reader of the</span>
            <span class="c1"># MIDI file knows that it has read the entire message. (But the F7</span>
            <span class="c1"># is omitted if this is a non-final block in a multiblock sysex;</span>
            <span class="c1"># but the F7 (if there) is counted in the message&#39;s declared</span>
            <span class="c1"># length, so we don&#39;t have to think about it anyway.)</span>
            <span class="c1">#command = trackdata.pop(0)</span>
            <span class="p">[</span><span class="n">length</span><span class="p">,</span> <span class="n">trackdata</span><span class="p">]</span> <span class="o">=</span> <span class="n">_unshift_ber_int</span><span class="p">(</span><span class="n">trackdata</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">first_byte</span> <span class="o">==</span> <span class="mh">0xF0</span><span class="p">:</span>
                <span class="c1"># 20091008 added ISO-8859-1 to get an 8-bit str</span>
                <span class="c1"># 6.4 return bytes instead</span>
                <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sysex_f0&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">trackdata</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">length</span><span class="p">])]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sysex_f7&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">trackdata</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">length</span><span class="p">])]</span>
            <span class="n">trackdata</span> <span class="o">=</span> <span class="n">trackdata</span><span class="p">[</span><span class="n">length</span><span class="p">:]</span>

        <span class="c1">######################################################################</span>
        <span class="c1"># Now, the MIDI file spec says:</span>
        <span class="c1">#  &lt;track data&gt; = &lt;MTrk event&gt;+</span>
        <span class="c1">#  &lt;MTrk event&gt; = &lt;delta-time&gt; &lt;event&gt;</span>
        <span class="c1">#  &lt;event&gt; = &lt;MIDI event&gt; | &lt;sysex event&gt; | &lt;meta-event&gt;</span>
        <span class="c1"># I know that, on the wire, &lt;MIDI event&gt; can include note_on,</span>
        <span class="c1"># note_off, and all the other 8x to Ex events, AND Fx events</span>
        <span class="c1"># other than F0, F7, and FF -- namely, &lt;song position msg&gt;,</span>
        <span class="c1"># &lt;song select msg&gt;, and &lt;tune request&gt;.</span>
        <span class="c1">#</span>
        <span class="c1"># Whether these can occur in MIDI files is not clear specified</span>
        <span class="c1"># from the MIDI file spec.  So, I&#39;m going to assume that</span>
        <span class="c1"># they CAN, in practice, occur.  I don&#39;t know whether it&#39;s</span>
        <span class="c1"># proper for you to actually emit these into a MIDI file.</span>
        
        <span class="k">elif</span> <span class="p">(</span><span class="n">first_byte</span> <span class="o">==</span> <span class="mh">0xF2</span><span class="p">):</span>   <span class="c1"># DTime, Beats</span>
            <span class="c1">#  &lt;song position msg&gt; ::=     F2 &lt;data pair&gt;</span>
            <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;song_position&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">_read_14_bit</span><span class="p">(</span><span class="n">trackdata</span><span class="p">[:</span><span class="mi">2</span><span class="p">])]</span>
            <span class="n">trackdata</span> <span class="o">=</span> <span class="n">trackdata</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

        <span class="k">elif</span> <span class="p">(</span><span class="n">first_byte</span> <span class="o">==</span> <span class="mh">0xF3</span><span class="p">):</span>   <span class="c1"># &lt;song select msg&gt; ::= F3 &lt;data singlet&gt;</span>
            <span class="c1"># E = [&#39;song_select&#39;, time, struct.unpack(&#39;&gt;B&#39;,trackdata.pop(0))[0]]</span>
            <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;song_select&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">trackdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">trackdata</span> <span class="o">=</span> <span class="n">trackdata</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="c1"># DTime, Thing (what?! song number?  whatever ...)</span>

        <span class="k">elif</span> <span class="p">(</span><span class="n">first_byte</span> <span class="o">==</span> <span class="mh">0xF6</span><span class="p">):</span>   <span class="c1"># DTime</span>
            <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tune_request&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">]</span>
            <span class="c1"># What would a tune request be doing in a MIDI /file/?</span>

        <span class="c1">#########################################################</span>
        <span class="c1"># ADD MORE META-EVENTS HERE.  TODO:</span>
        <span class="c1"># f1 -- MTC Quarter Frame Message. One data byte follows</span>
        <span class="c1">#     the Status; it&#39;s the time code value, from 0 to 127.</span>
        <span class="c1"># f8 -- MIDI clock.    no data.</span>
        <span class="c1"># fa -- MIDI start.    no data.</span>
        <span class="c1"># fb -- MIDI continue. no data.</span>
        <span class="c1"># fc -- MIDI stop.     no data.</span>
        <span class="c1"># fe -- Active sense.  no data.</span>
        <span class="c1"># f4 f5 f9 fd -- unallocated</span>

<span class="w">            </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        elif (first_byte &gt; 0xF0) { # Some unknown kinda F-series event ####</span>
<span class="sd">            # Here we only produce a one-byte piece of raw data.</span>
<span class="sd">            # But the encoder for &#39;raw_data&#39; accepts any length of it.</span>
<span class="sd">            E = [ &#39;raw_data&#39;,</span>
<span class="sd">                         time, substr(trackdata,Pointer,1) ]</span>
<span class="sd">            # DTime and the Data (in this case, the one Event-byte)</span>
<span class="sd">            ++Pointer;  # itself</span>

<span class="sd">&#39;&#39;&#39;</span>
        <span class="k">elif</span> <span class="n">first_byte</span> <span class="o">&gt;</span> <span class="mh">0xF0</span><span class="p">:</span>  <span class="c1"># Some unknown F-series event</span>
            <span class="c1"># Here we only produce a one-byte piece of raw data.</span>
            <span class="c1"># E = [&#39;raw_data&#39;, time, bytest(trackdata[0])]   # 6.4</span>
            <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;raw_data&#39;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">trackdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>   <span class="c1"># 6.4 6.7</span>
            <span class="n">trackdata</span> <span class="o">=</span> <span class="n">trackdata</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Fallthru.</span>
            <span class="n">_warn</span><span class="p">(</span><span class="s2">&quot;Aborting track.  Command-byte first_byte=&quot;</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">first_byte</span><span class="p">))</span>
            <span class="k">break</span>
        <span class="c1"># End of the big if-group</span>


        <span class="c1">######################################################################</span>
        <span class="c1">#  THE EVENT REGISTRAR...</span>
        <span class="k">if</span> <span class="n">E</span> <span class="ow">and</span>  <span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;end_track&#39;</span><span class="p">):</span>
            <span class="c1"># This is the code for exceptional handling of the EOT event.</span>
            <span class="n">eot</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">no_eot_magic</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">E</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># a null text-event to carry the delta-time</span>
                    <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;text_event&#39;</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">E</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># EOT with a delta-time of 0; ignore it.</span>
        
        <span class="k">if</span> <span class="n">E</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">):</span>
            <span class="c1">#if ( $exclusive_event_callback ):</span>
            <span class="c1">#    &amp;{ $exclusive_event_callback }( @E );</span>
            <span class="c1">#else:</span>
            <span class="c1">#    &amp;{ $event_callback }( @E ) if $event_callback;</span>
                <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">eot</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="c1"># End of the big &quot;Event&quot; while-block</span>

    <span class="k">return</span> <span class="n">events</span>


<span class="c1">###########################################################################</span>
<span class="k">def</span> <span class="nf">_encode</span><span class="p">(</span><span class="n">events_lol</span><span class="p">,</span> <span class="n">unknown_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">never_add_eot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
  <span class="n">no_eot_magic</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">no_running_status</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># encode an event structure, presumably for writing to a file</span>
    <span class="c1"># Calling format:</span>
    <span class="c1">#   $data_r = MIDI::Event::encode( \@event_lol, { options } );</span>
    <span class="c1"># Takes a REFERENCE to an event structure (a LoL)</span>
    <span class="c1"># Returns an (unblessed) REFERENCE to track data.</span>

    <span class="c1"># If you want to use this to encode a /single/ event,</span>
    <span class="c1"># you still have to do it as a reference to an event structure (a LoL)</span>
    <span class="c1"># that just happens to have just one event.  I.e.,</span>
    <span class="c1">#   encode( [ $event ] ) or encode( [ [ &#39;note_on&#39;, 100, 5, 42, 64] ] )</span>
    <span class="c1"># If you&#39;re doing this, consider the never_add_eot track option, as in</span>
    <span class="c1">#   print MIDI ${ encode( [ $event], { &#39;never_add_eot&#39; =&gt; 1} ) };</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># what I&#39;ll store the chunks of byte-data in</span>

    <span class="c1"># This is so my end_track magic won&#39;t corrupt the original</span>
    <span class="n">events</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">events_lol</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">never_add_eot</span><span class="p">:</span>
        <span class="c1"># One way or another, tack on an &#39;end_track&#39;</span>
        <span class="k">if</span> <span class="n">events</span><span class="p">:</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">last</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;end_track&#39;</span><span class="p">):</span>  <span class="c1"># no end_track already</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">last</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;text_event&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">last</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="c1"># 0-length text event at track-end.</span>
                    <span class="k">if</span> <span class="n">no_eot_magic</span><span class="p">:</span>
                        <span class="c1"># Exceptional case: don&#39;t mess with track-final</span>
                        <span class="c1"># 0-length text_events; just peg on an end_track</span>
                        <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;end_track&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># NORMAL CASE: replace with an end_track, leaving DTime</span>
                        <span class="n">last</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;end_track&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># last event was neither 0-length text_event nor end_track</span>
                    <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;end_track&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># an eventless track!</span>
            <span class="n">events</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;end_track&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">],]</span>

    <span class="c1"># maybe_running_status = not no_running_status # unused? 4.7</span>
    <span class="n">last_status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">for</span> <span class="n">event_r</span> <span class="ow">in</span> <span class="p">(</span><span class="n">events</span><span class="p">):</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">event_r</span><span class="p">)</span>
        <span class="c1"># otherwise the shifting&#39;d corrupt the original</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">E</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">event</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="n">dtime</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="c1"># print(&#39;event=&#39;+str(event)+&#39; dtime=&#39;+str(dtime))</span>

        <span class="n">event_data</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="p">(</span>   <span class="c1"># MIDI events -- eligible for running status</span>
             <span class="n">event</span>    <span class="o">==</span> <span class="s1">&#39;note_on&#39;</span>
             <span class="ow">or</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;note_off&#39;</span>
             <span class="ow">or</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;control_change&#39;</span>
             <span class="ow">or</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;key_after_touch&#39;</span>
             <span class="ow">or</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;patch_change&#39;</span>
             <span class="ow">or</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;channel_after_touch&#39;</span>
             <span class="ow">or</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;pitch_wheel_change&#39;</span>  <span class="p">):</span>

            <span class="c1"># This block is where we spend most of the time.  Gotta be tight.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;note_off&#39;</span><span class="p">):</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span>
                <span class="n">parameters</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;BB&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&amp;</span><span class="mh">0x7F</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">&amp;</span><span class="mh">0x7F</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;note_on&#39;</span><span class="p">):</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mh">0x90</span> <span class="o">|</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span>
                <span class="n">parameters</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;BB&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&amp;</span><span class="mh">0x7F</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">&amp;</span><span class="mh">0x7F</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;key_after_touch&#39;</span><span class="p">):</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mh">0xA0</span> <span class="o">|</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span>
                <span class="n">parameters</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;BB&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&amp;</span><span class="mh">0x7F</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">&amp;</span><span class="mh">0x7F</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;control_change&#39;</span><span class="p">):</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mh">0xB0</span> <span class="o">|</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span>
                <span class="n">parameters</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;BB&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&amp;</span><span class="mh">0xFF</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">&amp;</span><span class="mh">0xFF</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;patch_change&#39;</span><span class="p">):</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mh">0xC0</span> <span class="o">|</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span>
                <span class="n">parameters</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;B&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;channel_after_touch&#39;</span><span class="p">):</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mh">0xD0</span> <span class="o">|</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span>
                <span class="n">parameters</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;B&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;pitch_wheel_change&#39;</span><span class="p">):</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mh">0xE0</span> <span class="o">|</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span>
                <span class="n">parameters</span> <span class="o">=</span>  <span class="n">_write_14_bit</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mh">0x2000</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_warn</span><span class="p">(</span><span class="s2">&quot;BADASS FREAKOUT ERROR 31415!&quot;</span><span class="p">)</span>

            <span class="c1"># And now the encoding</span>
            <span class="c1"># w = BER compressed integer (not ASN.1 BER, see perlpacktut for</span>
            <span class="c1"># details).  Its bytes represent an unsigned integer in base 128,</span>
            <span class="c1"># most significant digit first, with as few digits as possible.</span>
            <span class="c1"># Bit eight (the high bit) is set on each byte except the last.</span>

            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_ber_compressed_int</span><span class="p">(</span><span class="n">dtime</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">last_status</span><span class="p">)</span> <span class="ow">or</span> <span class="n">no_running_status</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;B&#39;</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
 
            <span class="n">last_status</span> <span class="o">=</span> <span class="n">status</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Not a MIDI event.</span>
            <span class="c1"># All the code in this block could be more efficient,</span>
            <span class="c1"># but this is not where the code needs to be tight.</span>
            <span class="c1"># print &quot;zaz $event\n&quot;;</span>
            <span class="n">last_status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

            <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;raw_meta_event&#39;</span><span class="p">:</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">_some_text_event</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">E</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;set_sequence_number&#39;</span><span class="p">):</span>  <span class="c1"># 3.9</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xFF\x00\x02</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">_int2twobytes</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1"># Text meta-events...</span>
            <span class="c1"># a case for a dict, I think (pjb) ...</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;text_event&#39;</span><span class="p">):</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">_some_text_event</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;copyright_text_event&#39;</span><span class="p">):</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">_some_text_event</span><span class="p">(</span><span class="mh">0x02</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;track_name&#39;</span><span class="p">):</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">_some_text_event</span><span class="p">(</span><span class="mh">0x03</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;instrument_name&#39;</span><span class="p">):</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">_some_text_event</span><span class="p">(</span><span class="mh">0x04</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;lyric&#39;</span><span class="p">):</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">_some_text_event</span><span class="p">(</span><span class="mh">0x05</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;marker&#39;</span><span class="p">):</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">_some_text_event</span><span class="p">(</span><span class="mh">0x06</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;cue_point&#39;</span><span class="p">):</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">_some_text_event</span><span class="p">(</span><span class="mh">0x07</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;text_event_08&#39;</span><span class="p">):</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">_some_text_event</span><span class="p">(</span><span class="mh">0x08</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;text_event_09&#39;</span><span class="p">):</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">_some_text_event</span><span class="p">(</span><span class="mh">0x09</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;text_event_0a&#39;</span><span class="p">):</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">_some_text_event</span><span class="p">(</span><span class="mh">0x0A</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;text_event_0b&#39;</span><span class="p">):</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">_some_text_event</span><span class="p">(</span><span class="mh">0x0B</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;text_event_0c&#39;</span><span class="p">):</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">_some_text_event</span><span class="p">(</span><span class="mh">0x0C</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;text_event_0d&#39;</span><span class="p">):</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">_some_text_event</span><span class="p">(</span><span class="mh">0x0D</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;text_event_0e&#39;</span><span class="p">):</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">_some_text_event</span><span class="p">(</span><span class="mh">0x0E</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;text_event_0f&#39;</span><span class="p">):</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">_some_text_event</span><span class="p">(</span><span class="mh">0x0F</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># End of text meta-events</span>

            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;end_track&#39;</span><span class="p">):</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xFF\x2F\x00</span><span class="s2">&quot;</span>

            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;set_tempo&#39;</span><span class="p">):</span>
                <span class="c1">#event_data = struct.pack(&quot;&gt;BBwa*&quot;, 0xFF, 0x51, 3,</span>
                <span class="c1">#              substr( struct.pack(&#39;&gt;I&#39;, E[0]), 1, 3))</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xFF\x51\x03</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;I&#39;</span><span class="p">,</span><span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;smpte_offset&#39;</span><span class="p">):</span>
                <span class="c1"># event_data = struct.pack(&quot;&gt;BBwBBBBB&quot;, 0xFF, 0x54, 5, E[0:5] )</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;BBBbBBBB&quot;</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span><span class="mh">0x54</span><span class="p">,</span><span class="mh">0x05</span><span class="p">,</span><span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">E</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">E</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">E</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">E</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;time_signature&#39;</span><span class="p">):</span>
                <span class="c1"># event_data = struct.pack(&quot;&gt;BBwBBBB&quot;,  0xFF, 0x58, 4, E[0:4] )</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;BBBbBBB&quot;</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">E</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">E</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">E</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;key_signature&#39;</span><span class="p">):</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;BBBbB&quot;</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">E</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;sequencer_specific&#39;</span><span class="p">):</span>
                <span class="c1"># event_data = struct.pack(&quot;&gt;BBwa*&quot;, 0xFF,0x7F, len(E[0]), E[0])</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="n">_some_text_event</span><span class="p">(</span><span class="mh">0x7F</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># End of Meta-events</span>

            <span class="c1"># Other Things...</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;sysex_f0&#39;</span><span class="p">):</span>
                 <span class="c1">#event_data = struct.pack(&quot;&gt;Bwa*&quot;, 0xF0, len(E[0]), E[0])</span>
                 <span class="c1">#B=bitstring w=BER-compressed-integer a=null-padded-ascii-str</span>
                 <span class="n">event_data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xF0</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">+</span><span class="n">_ber_compressed_int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">+</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;sysex_f7&#39;</span><span class="p">):</span>
                 <span class="c1">#event_data = struct.pack(&quot;&gt;Bwa*&quot;, 0xF7, len(E[0]), E[0])</span>
                 <span class="n">event_data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xF7</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">+</span><span class="n">_ber_compressed_int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">+</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;song_position&#39;</span><span class="p">):</span>
                 <span class="n">event_data</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xF2</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">_write_14_bit</span><span class="p">(</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;song_select&#39;</span><span class="p">):</span>
                 <span class="n">event_data</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;BB&#39;</span><span class="p">,</span> <span class="mh">0xF3</span><span class="p">,</span> <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;tune_request&#39;</span><span class="p">):</span>
                 <span class="n">event_data</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xF6</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;raw_data&#39;</span><span class="p">):</span>
                <span class="n">_warn</span><span class="p">(</span><span class="s2">&quot;_encode: raw_data event not supported&quot;</span><span class="p">)</span>
                <span class="c1"># event_data = E[0]</span>
                <span class="k">continue</span>
            <span class="c1"># End of Other Stuff</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># The Big Fallthru</span>
                <span class="k">if</span> <span class="n">unknown_callback</span><span class="p">:</span>
                    <span class="c1"># push(@data, &amp;{ $unknown_callback }( @$event_r ))</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_warn</span><span class="p">(</span><span class="s2">&quot;Unknown event: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
                    <span class="c1"># To surpress complaint here, just set</span>
                    <span class="c1">#  &#39;unknown_callback&#39; =&gt; sub { return () }</span>
                <span class="k">continue</span>

            <span class="c1">#print &quot;Event $event encoded part 2\n&quot;</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">event_data</span><span class="p">))</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;&#39;str&#39;&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">event_data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">event_data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;Latin1&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">event_data</span><span class="p">):</span> <span class="c1"># how could $event_data be empty</span>
                <span class="c1"># data.append(struct.pack(&#39;&gt;wa*&#39;, dtime, event_data))</span>
                <span class="c1"># print(&#39; event_data=&#39;+str(event_data))</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_ber_compressed_int</span><span class="p">(</span><span class="n">dtime</span><span class="p">)</span><span class="o">+</span><span class="n">event_data</span><span class="p">)</span>

    <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)]</span>
</pre></div>

  </div>

  </header>

  <section id="section-items">
    <h2 class="section-title" id="header-variables">Module variables</h2>
      <div class="item">
      <p id="tegridymidi.legacy.MIDI.All_events" class="name">var <span class="ident">All_events</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="tegridymidi.legacy.MIDI.Event2channelindex" class="name">var <span class="ident">Event2channelindex</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="tegridymidi.legacy.MIDI.MIDI_events" class="name">var <span class="ident">MIDI_events</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="tegridymidi.legacy.MIDI.Meta_events" class="name">var <span class="ident">Meta_events</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="tegridymidi.legacy.MIDI.Nontext_meta_events" class="name">var <span class="ident">Nontext_meta_events</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="tegridymidi.legacy.MIDI.Notenum2percussion" class="name">var <span class="ident">Notenum2percussion</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="tegridymidi.legacy.MIDI.Number2patch" class="name">var <span class="ident">Number2patch</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="tegridymidi.legacy.MIDI.Text_events" class="name">var <span class="ident">Text_events</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="tegridymidi.legacy.MIDI.Version" class="name">var <span class="ident">Version</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="tegridymidi.legacy.MIDI.VersionDate" class="name">var <span class="ident">VersionDate</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="tegridymidi.legacy.MIDI.copy" class="name">var <span class="ident">copy</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="tegridymidi.legacy.MIDI.struct" class="name">var <span class="ident">struct</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="tegridymidi.legacy.MIDI.sys" class="name">var <span class="ident">sys</span></p>
      
  
  <div class="source_cont">
</div>

      </div>

    <h2 class="section-title" id="header-functions">Functions</h2>
      
  <div class="item">
    <div class="name def" id="tegridymidi.legacy.MIDI.concatenate_scores">
    <p>def <span class="ident">concatenate_scores</span>(</p><p>scores)</p>
    </div>
    

    
  
    <div class="desc"><p>Concatenates a list of scores into one score.
If the scores differ in their "ticks" parameter,
they will all get converted to millisecond-tick format.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-tegridymidi.legacy.MIDI.concatenate_scores', this);">Show source &equiv;</a></p>
  <div id="source-tegridymidi.legacy.MIDI.concatenate_scores" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">concatenate_scores</span><span class="p">(</span><span class="n">scores</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Concatenates a list of scores into one score.</span>
<span class="sd">If the scores differ in their &quot;ticks&quot; parameter,</span>
<span class="sd">they will all get converted to millisecond-tick format.</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="c1"># the deepcopys are needed if the input_score&#39;s are refs to the same obj</span>
    <span class="c1"># e.g. if invoked by midisox&#39;s repeat()</span>
    <span class="n">input_scores</span> <span class="o">=</span> <span class="n">_consistentise_ticks</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>  <span class="c1"># 3.7</span>
    <span class="n">output_score</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">input_scores</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">input_score</span> <span class="ow">in</span> <span class="n">input_scores</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">output_stats</span> <span class="o">=</span> <span class="n">score2stats</span><span class="p">(</span><span class="n">output_score</span><span class="p">)</span>
        <span class="n">delta_ticks</span> <span class="o">=</span> <span class="n">output_stats</span><span class="p">[</span><span class="s1">&#39;nticks&#39;</span><span class="p">]</span>
        <span class="n">itrack</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">itrack</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_score</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">itrack</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_score</span><span class="p">):</span> <span class="c1"># new output track if doesn&#39;t exist</span>
                <span class="n">output_score</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">input_score</span><span class="p">[</span><span class="n">itrack</span><span class="p">]:</span>
                <span class="n">output_score</span><span class="p">[</span><span class="n">itrack</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
                <span class="n">output_score</span><span class="p">[</span><span class="n">itrack</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">delta_ticks</span>
            <span class="n">itrack</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">output_score</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="tegridymidi.legacy.MIDI.event2alsaseq">
    <p>def <span class="ident">event2alsaseq</span>(</p><p>event=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Converts an event into the format needed by the alsaseq module,
http://pp.com.mx/python/alsaseq
The type of track (opus or score) is autodetected.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-tegridymidi.legacy.MIDI.event2alsaseq', this);">Show source &equiv;</a></p>
  <div id="source-tegridymidi.legacy.MIDI.event2alsaseq" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">event2alsaseq</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>   <span class="c1"># 5.5</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Converts an event into the format needed by the alsaseq module,</span>
<span class="sd">http://pp.com.mx/python/alsaseq</span>
<span class="sd">The type of track (opus or score) is autodetected.</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">pass</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="tegridymidi.legacy.MIDI.grep">
    <p>def <span class="ident">grep</span>(</p><p>score=None, channels=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Returns a "score" containing only the channels specified</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-tegridymidi.legacy.MIDI.grep', this);">Show source &equiv;</a></p>
  <div id="source-tegridymidi.legacy.MIDI.grep" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">grep</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Returns a &quot;score&quot; containing only the channels specified</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">score</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,[],]</span>
    <span class="n">ticks</span> <span class="o">=</span> <span class="n">score</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">new_score</span> <span class="o">=</span> <span class="p">[</span><span class="n">ticks</span><span class="p">,]</span>
    <span class="k">if</span> <span class="n">channels</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">new_score</span>
    <span class="n">channels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
    <span class="k">global</span> <span class="n">Event2channelindex</span>
    <span class="n">itrack</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">itrack</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">):</span>
        <span class="n">new_score</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">score</span><span class="p">[</span><span class="n">itrack</span><span class="p">]:</span>
            <span class="n">channel_index</span> <span class="o">=</span> <span class="n">Event2channelindex</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">channel_index</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="n">channel_index</span><span class="p">]</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
                    <span class="n">new_score</span><span class="p">[</span><span class="n">itrack</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_score</span><span class="p">[</span><span class="n">itrack</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">itrack</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">new_score</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="tegridymidi.legacy.MIDI.merge_scores">
    <p>def <span class="ident">merge_scores</span>(</p><p>scores)</p>
    </div>
    

    
  
    <div class="desc"><p>Merges a list of scores into one score.  A merged score comprises
all of the tracks from all of the input scores; un-merging is possible
by selecting just some of the tracks.  If the scores differ in their
"ticks" parameter, they will all get converted to millisecond-tick
format.  merge_scores attempts to resolve channel-conflicts,
but there are of course only 15 available channels&hellip;</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-tegridymidi.legacy.MIDI.merge_scores', this);">Show source &equiv;</a></p>
  <div id="source-tegridymidi.legacy.MIDI.merge_scores" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">merge_scores</span><span class="p">(</span><span class="n">scores</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Merges a list of scores into one score.  A merged score comprises</span>
<span class="sd">all of the tracks from all of the input scores; un-merging is possible</span>
<span class="sd">by selecting just some of the tracks.  If the scores differ in their</span>
<span class="sd">&quot;ticks&quot; parameter, they will all get converted to millisecond-tick</span>
<span class="sd">format.  merge_scores attempts to resolve channel-conflicts,</span>
<span class="sd">but there are of course only 15 available channels...</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="n">input_scores</span> <span class="o">=</span> <span class="n">_consistentise_ticks</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>  <span class="c1"># 3.6</span>
    <span class="n">output_score</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span><span class="p">]</span>
    <span class="n">channels_so_far</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">all_channels</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">}</span>
    <span class="k">global</span> <span class="n">Event2channelindex</span>
    <span class="k">for</span> <span class="n">input_score</span> <span class="ow">in</span> <span class="n">input_scores</span><span class="p">:</span>
        <span class="n">new_channels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">score2stats</span><span class="p">(</span><span class="n">input_score</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;channels_total&#39;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">new_channels</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>  <span class="c1"># 2.8 cha9 must remain cha9 (in GM)</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channels_so_far</span> <span class="o">&amp;</span> <span class="n">new_channels</span><span class="p">:</span>
            <span class="c1"># consistently choose lowest avaiable, to ease testing</span>
            <span class="n">free_channels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">all_channels</span> <span class="o">-</span> <span class="p">(</span><span class="n">channels_so_far</span><span class="o">|</span><span class="n">new_channels</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">free_channels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">free_channels</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="n">free_channel</span> <span class="o">=</span> <span class="n">free_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">free_channel</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">break</span>
            <span class="n">itrack</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="n">itrack</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_score</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">input_event</span> <span class="ow">in</span> <span class="n">input_score</span><span class="p">[</span><span class="n">itrack</span><span class="p">]:</span>
                    <span class="n">channel_index</span><span class="o">=</span><span class="n">Event2channelindex</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">input_event</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">channel_index</span> <span class="ow">and</span> <span class="n">input_event</span><span class="p">[</span><span class="n">channel_index</span><span class="p">]</span><span class="o">==</span><span class="n">channel</span><span class="p">:</span>
                        <span class="n">input_event</span><span class="p">[</span><span class="n">channel_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">free_channel</span>
                <span class="n">itrack</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">channels_so_far</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">free_channel</span><span class="p">)</span>

        <span class="n">channels_so_far</span> <span class="o">|=</span> <span class="n">new_channels</span>
        <span class="n">output_score</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">input_score</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">return</span> <span class="n">output_score</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="tegridymidi.legacy.MIDI.midi2ms_score">
    <p>def <span class="ident">midi2ms_score</span>(</p><p>midi=b&#39;&#39;)</p>
    </div>
    

    
  
    <div class="desc"><p>Translates MIDI into a "score" with one beat per second and one
tick per millisecond, using midi2opus() then to_millisecs()
then opus2score()</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-tegridymidi.legacy.MIDI.midi2ms_score', this);">Show source &equiv;</a></p>
  <div id="source-tegridymidi.legacy.MIDI.midi2ms_score" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">midi2ms_score</span><span class="p">(</span><span class="n">midi</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Translates MIDI into a &quot;score&quot; with one beat per second and one</span>
<span class="sd">tick per millisecond, using midi2opus() then to_millisecs()</span>
<span class="sd">then opus2score()</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">opus2score</span><span class="p">(</span><span class="n">to_millisecs</span><span class="p">(</span><span class="n">midi2opus</span><span class="p">(</span><span class="n">midi</span><span class="p">)))</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="tegridymidi.legacy.MIDI.midi2opus">
    <p>def <span class="ident">midi2opus</span>(</p><p>midi=b&#39;&#39;)</p>
    </div>
    

    
  
    <div class="desc"><p>Translates MIDI into a "opus".  For a description of the
"opus" format, see opus2midi()</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-tegridymidi.legacy.MIDI.midi2opus', this);">Show source &equiv;</a></p>
  <div id="source-tegridymidi.legacy.MIDI.midi2opus" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">midi2opus</span><span class="p">(</span><span class="n">midi</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Translates MIDI into a &quot;opus&quot;.  For a description of the</span>
<span class="sd">&quot;opus&quot; format, see opus2midi()</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="n">my_midi</span><span class="o">=</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">midi</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">my_midi</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">_clean_up_warnings</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,[],]</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">my_midi</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">id</span> <span class="o">!=</span> <span class="sa">b</span><span class="s1">&#39;MThd&#39;</span><span class="p">:</span>
        <span class="n">_warn</span><span class="p">(</span><span class="s2">&quot;midi2opus: midi starts with &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; instead of &#39;MThd&#39;&quot;</span><span class="p">)</span>
        <span class="n">_clean_up_warnings</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,[],]</span>
    <span class="p">[</span><span class="n">length</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="n">tracks_expected</span><span class="p">,</span> <span class="n">ticks</span><span class="p">]</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span>
     <span class="s1">&#39;&gt;IHHH&#39;</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">my_midi</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">14</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">length</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">:</span>
        <span class="n">_warn</span><span class="p">(</span><span class="s2">&quot;midi2opus: midi header length was &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">length</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; instead of 6&quot;</span><span class="p">)</span>
        <span class="n">_clean_up_warnings</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,[],]</span>
    <span class="n">my_opus</span> <span class="o">=</span> <span class="p">[</span><span class="n">ticks</span><span class="p">,]</span>
    <span class="n">my_midi</span> <span class="o">=</span> <span class="n">my_midi</span><span class="p">[</span><span class="mi">14</span><span class="p">:]</span>
    <span class="n">track_num</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># 5.1</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">my_midi</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">track_type</span>   <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">my_midi</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">track_type</span> <span class="o">!=</span> <span class="sa">b</span><span class="s1">&#39;MTrk&#39;</span><span class="p">:</span>
            <span class="n">_warn</span><span class="p">(</span><span class="s1">&#39;midi2opus: Warning: track #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">track_num</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; type is &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">track_type</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; instead of b&#39;MTrk&#39;&quot;</span><span class="p">)</span>
        <span class="p">[</span><span class="n">track_length</span><span class="p">]</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&gt;I&#39;</span><span class="p">,</span> <span class="n">my_midi</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span>
        <span class="n">my_midi</span> <span class="o">=</span> <span class="n">my_midi</span><span class="p">[</span><span class="mi">8</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">track_length</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">my_midi</span><span class="p">):</span>
            <span class="n">_warn</span><span class="p">(</span><span class="s1">&#39;midi2opus: track #&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">track_num</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; length &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">track_length</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; is too large&#39;</span><span class="p">)</span>
            <span class="n">_clean_up_warnings</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">my_opus</span>   <span class="c1"># 5.0</span>
        <span class="n">my_midi_track</span> <span class="o">=</span> <span class="n">my_midi</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">track_length</span><span class="p">]</span>
        <span class="n">my_track</span> <span class="o">=</span> <span class="n">_decode</span><span class="p">(</span><span class="n">my_midi_track</span><span class="p">)</span>
        <span class="n">my_opus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">my_track</span><span class="p">)</span>
        <span class="n">my_midi</span> <span class="o">=</span> <span class="n">my_midi</span><span class="p">[</span><span class="n">track_length</span><span class="p">:]</span>
        <span class="n">track_num</span> <span class="o">+=</span> <span class="mi">1</span>   <span class="c1"># 5.1</span>
    <span class="n">_clean_up_warnings</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">my_opus</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="tegridymidi.legacy.MIDI.midi2score">
    <p>def <span class="ident">midi2score</span>(</p><p>midi=b&#39;&#39;)</p>
    </div>
    

    
  
    <div class="desc"><p>Translates MIDI into a "score", using midi2opus() then opus2score()</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-tegridymidi.legacy.MIDI.midi2score', this);">Show source &equiv;</a></p>
  <div id="source-tegridymidi.legacy.MIDI.midi2score" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">midi2score</span><span class="p">(</span><span class="n">midi</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Translates MIDI into a &quot;score&quot;, using midi2opus() then opus2score()</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">opus2score</span><span class="p">(</span><span class="n">midi2opus</span><span class="p">(</span><span class="n">midi</span><span class="p">))</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="tegridymidi.legacy.MIDI.mix_opus_tracks">
    <p>def <span class="ident">mix_opus_tracks</span>(</p><p>input_tracks)</p>
    </div>
    

    
  
    <div class="desc"><p>Mixes an array of tracks into one track.  A mixed track
cannot be un-mixed.  It is assumed that the tracks share the same
ticks parameter and the same tempo.
Mixing score-tracks is trivial (just insert all events into one array).
Mixing opus-tracks is only slightly harder, but it's common enough
that a dedicated function is useful.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-tegridymidi.legacy.MIDI.mix_opus_tracks', this);">Show source &equiv;</a></p>
  <div id="source-tegridymidi.legacy.MIDI.mix_opus_tracks" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">mix_opus_tracks</span><span class="p">(</span><span class="n">input_tracks</span><span class="p">):</span>   <span class="c1"># 5.5</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Mixes an array of tracks into one track.  A mixed track</span>
<span class="sd">cannot be un-mixed.  It is assumed that the tracks share the same</span>
<span class="sd">ticks parameter and the same tempo.</span>
<span class="sd">Mixing score-tracks is trivial (just insert all events into one array).</span>
<span class="sd">Mixing opus-tracks is only slightly harder, but it&#39;s common enough</span>
<span class="sd">that a dedicated function is useful.</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="n">output_score</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="p">[]]</span>
    <span class="k">for</span> <span class="n">input_track</span> <span class="ow">in</span> <span class="n">input_tracks</span><span class="p">:</span>   <span class="c1"># 5.8</span>
        <span class="n">input_score</span> <span class="o">=</span> <span class="n">opus2score</span><span class="p">([</span><span class="mi">1000</span><span class="p">,</span> <span class="n">input_track</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">input_score</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">output_score</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="n">output_score</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">_ticks</span><span class="p">)</span> 
    <span class="n">output_opus</span> <span class="o">=</span> <span class="n">score2opus</span><span class="p">(</span><span class="n">output_score</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_opus</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="tegridymidi.legacy.MIDI.mix_scores">
    <p>def <span class="ident">mix_scores</span>(</p><p>scores)</p>
    </div>
    

    
  
    <div class="desc"><p>Mixes a list of scores into one one-track score.
A mixed score cannot be un-mixed.  Hopefully the scores
have no undesirable channel-conflicts between them.
If the scores differ in their "ticks" parameter,
they will all get converted to millisecond-tick format.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-tegridymidi.legacy.MIDI.mix_scores', this);">Show source &equiv;</a></p>
  <div id="source-tegridymidi.legacy.MIDI.mix_scores" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">mix_scores</span><span class="p">(</span><span class="n">scores</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Mixes a list of scores into one one-track score.</span>
<span class="sd">A mixed score cannot be un-mixed.  Hopefully the scores</span>
<span class="sd">have no undesirable channel-conflicts between them.</span>
<span class="sd">If the scores differ in their &quot;ticks&quot; parameter,</span>
<span class="sd">they will all get converted to millisecond-tick format.</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="n">input_scores</span> <span class="o">=</span> <span class="n">_consistentise_ticks</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>  <span class="c1"># 3.6</span>
    <span class="n">output_score</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="p">[]]</span>
    <span class="k">for</span> <span class="n">input_score</span> <span class="ow">in</span> <span class="n">input_scores</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">input_track</span> <span class="ow">in</span> <span class="n">input_score</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">output_score</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">input_track</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_score</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="tegridymidi.legacy.MIDI.opus2midi">
    <p>def <span class="ident">opus2midi</span>(</p><p>opus=[])</p>
    </div>
    

    
  
    <div class="desc"><p>The argument is a list: the first item in the list is the "ticks"
parameter, the others are the tracks. Each track is a list
of midi-events, and each event is itself a list; see above.
opus2midi() returns a bytestring of the MIDI, which can then be
written either to a file opened in binary mode (mode='wb'),
or to stdout by means of:   sys.stdout.buffer.write()</p>
<p>my_opus = [
    96, 
    [   # track 0:
        ['patch_change', 0, 1, 8],   # and these are the events&hellip;
        ['note_on',   5, 1, 25, 96],
        ['note_off', 96, 1, 25, 0],
        ['note_on',   0, 1, 29, 96],
        ['note_off', 96, 1, 29, 0],
    ],   # end of track 0
]
my_midi = opus2midi(my_opus)
sys.stdout.buffer.write(my_midi)</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-tegridymidi.legacy.MIDI.opus2midi', this);">Show source &equiv;</a></p>
  <div id="source-tegridymidi.legacy.MIDI.opus2midi" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">opus2midi</span><span class="p">(</span><span class="n">opus</span><span class="o">=</span><span class="p">[]):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;The argument is a list: the first item in the list is the &quot;ticks&quot;</span>
<span class="sd">parameter, the others are the tracks. Each track is a list</span>
<span class="sd">of midi-events, and each event is itself a list; see above.</span>
<span class="sd">opus2midi() returns a bytestring of the MIDI, which can then be</span>
<span class="sd">written either to a file opened in binary mode (mode=&#39;wb&#39;),</span>
<span class="sd">or to stdout by means of:   sys.stdout.buffer.write()</span>

<span class="sd">my_opus = [</span>
<span class="sd">    96, </span>
<span class="sd">    [   # track 0:</span>
<span class="sd">        [&#39;patch_change&#39;, 0, 1, 8],   # and these are the events...</span>
<span class="sd">        [&#39;note_on&#39;,   5, 1, 25, 96],</span>
<span class="sd">        [&#39;note_off&#39;, 96, 1, 25, 0],</span>
<span class="sd">        [&#39;note_on&#39;,   0, 1, 29, 96],</span>
<span class="sd">        [&#39;note_off&#39;, 96, 1, 29, 0],</span>
<span class="sd">    ],   # end of track 0</span>
<span class="sd">]</span>
<span class="sd">my_midi = opus2midi(my_opus)</span>
<span class="sd">sys.stdout.buffer.write(my_midi)</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">opus</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">opus</span><span class="o">=</span><span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="p">[],]</span>
    <span class="n">tracks</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">opus</span><span class="p">)</span>
    <span class="n">ticks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tracks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">ntracks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tracks</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ntracks</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">format</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">format</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">my_midi</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;MThd</span><span class="se">\x00\x00\x00\x06</span><span class="s2">&quot;</span><span class="o">+</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;HHH&#39;</span><span class="p">,</span><span class="nb">format</span><span class="p">,</span><span class="n">ntracks</span><span class="p">,</span><span class="n">ticks</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">tracks</span><span class="p">:</span>
        <span class="n">events</span> <span class="o">=</span> <span class="n">_encode</span><span class="p">(</span><span class="n">track</span><span class="p">)</span>
        <span class="n">my_midi</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;MTrk&#39;</span> <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;I&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">))</span> <span class="o">+</span> <span class="n">events</span>
    <span class="n">_clean_up_warnings</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">my_midi</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="tegridymidi.legacy.MIDI.opus2score">
    <p>def <span class="ident">opus2score</span>(</p><p>opus=[])</p>
    </div>
    

    
  
    <div class="desc"><p>For a description of the "opus" and "score" formats,
see opus2midi() and score2opus().</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-tegridymidi.legacy.MIDI.opus2score', this);">Show source &equiv;</a></p>
  <div id="source-tegridymidi.legacy.MIDI.opus2score" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">opus2score</span><span class="p">(</span><span class="n">opus</span><span class="o">=</span><span class="p">[]):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;For a description of the &quot;opus&quot; and &quot;score&quot; formats,</span>
<span class="sd">see opus2midi() and score2opus().</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">opus</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">_clean_up_warnings</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,[],]</span>
    <span class="n">tracks</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">opus</span><span class="p">)</span>  <span class="c1"># couple of slices probably quicker...</span>
    <span class="n">ticks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tracks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">score</span> <span class="o">=</span> <span class="p">[</span><span class="n">ticks</span><span class="p">,]</span>
    <span class="k">for</span> <span class="n">opus_track</span> <span class="ow">in</span> <span class="n">tracks</span><span class="p">:</span>
        <span class="n">ticks_so_far</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">score_track</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">chapitch2note_on_events</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([])</span>   <span class="c1"># 4.0</span>
        <span class="k">for</span> <span class="n">opus_event</span> <span class="ow">in</span> <span class="n">opus_track</span><span class="p">:</span>
            <span class="n">ticks_so_far</span> <span class="o">+=</span> <span class="n">opus_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">opus_event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note_off&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">opus_event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note_on&#39;</span> <span class="ow">and</span> <span class="n">opus_event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>  <span class="c1"># 4.8</span>
                <span class="n">cha</span> <span class="o">=</span> <span class="n">opus_event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">pitch</span> <span class="o">=</span> <span class="n">opus_event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">cha</span><span class="o">*</span><span class="mi">128</span> <span class="o">+</span> <span class="n">pitch</span>
                <span class="k">if</span> <span class="n">chapitch2note_on_events</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                    <span class="n">new_event</span> <span class="o">=</span> <span class="n">chapitch2note_on_events</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">new_event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ticks_so_far</span> <span class="o">-</span> <span class="n">new_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">score_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_event</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">pitch</span> <span class="o">&gt;</span> <span class="mi">127</span><span class="p">:</span>
                    <span class="k">pass</span> <span class="c1">#_warn(&#39;opus2score: note_off with no note_on, bad pitch=&#39;+str(pitch))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span> <span class="c1">#_warn(&#39;opus2score: note_off with no note_on cha=&#39;+str(cha)+&#39; pitch=&#39;+str(pitch))</span>
            <span class="k">elif</span> <span class="n">opus_event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note_on&#39;</span><span class="p">:</span>
                <span class="n">cha</span> <span class="o">=</span> <span class="n">opus_event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">pitch</span> <span class="o">=</span> <span class="n">opus_event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">cha</span><span class="o">*</span><span class="mi">128</span> <span class="o">+</span> <span class="n">pitch</span>
                <span class="n">new_event</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;note&#39;</span><span class="p">,</span><span class="n">ticks_so_far</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cha</span><span class="p">,</span><span class="n">pitch</span><span class="p">,</span> <span class="n">opus_event</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">chapitch2note_on_events</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                    <span class="n">chapitch2note_on_events</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_event</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">chapitch2note_on_events</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_event</span><span class="p">,]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">opus_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ticks_so_far</span>
                <span class="n">score_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opus_event</span><span class="p">)</span>
        <span class="c1"># check for unterminated notes (Oisn) -- 5.2</span>
        <span class="k">for</span> <span class="n">chapitch</span> <span class="ow">in</span> <span class="n">chapitch2note_on_events</span><span class="p">:</span>
            <span class="n">note_on_events</span> <span class="o">=</span> <span class="n">chapitch2note_on_events</span><span class="p">[</span><span class="n">chapitch</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">new_e</span> <span class="ow">in</span> <span class="n">note_on_events</span><span class="p">:</span>
                <span class="n">new_e</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ticks_so_far</span> <span class="o">-</span> <span class="n">new_e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">score_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_e</span><span class="p">)</span>
                <span class="k">pass</span> <span class="c1">#_warn(&quot;opus2score: note_on with no note_off cha=&quot;+str(new_e[3])+&#39; pitch=&#39;+str(new_e[4])+&#39;; adding note_off at end&#39;)</span>
        <span class="n">score</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score_track</span><span class="p">)</span>
    <span class="n">_clean_up_warnings</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">score</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="tegridymidi.legacy.MIDI.play_score">
    <p>def <span class="ident">play_score</span>(</p><p>score=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Converts the "score" to midi, and feeds it into 'aplaymidi -'</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-tegridymidi.legacy.MIDI.play_score', this);">Show source &equiv;</a></p>
  <div id="source-tegridymidi.legacy.MIDI.play_score" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">play_score</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Converts the &quot;score&quot; to midi, and feeds it into &#39;aplaymidi -&#39;</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">score</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="kn">import</span> <span class="nn">subprocess</span>
    <span class="n">pipe</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;aplaymidi&#39;</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">],</span> <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">score_type</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;opus&#39;</span><span class="p">:</span>
        <span class="n">pipe</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">opus2midi</span><span class="p">(</span><span class="n">score</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pipe</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">score2midi</span><span class="p">(</span><span class="n">score</span><span class="p">))</span>
    <span class="n">pipe</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="tegridymidi.legacy.MIDI.score2midi">
    <p>def <span class="ident">score2midi</span>(</p><p>score=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Translates a "score" into MIDI, using score2opus() then opus2midi()</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-tegridymidi.legacy.MIDI.score2midi', this);">Show source &equiv;</a></p>
  <div id="source-tegridymidi.legacy.MIDI.score2midi" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">score2midi</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Translates a &quot;score&quot; into MIDI, using score2opus() then opus2midi()</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">opus2midi</span><span class="p">(</span><span class="n">score2opus</span><span class="p">(</span><span class="n">score</span><span class="p">))</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="tegridymidi.legacy.MIDI.score2opus">
    <p>def <span class="ident">score2opus</span>(</p><p>score=None)</p>
    </div>
    

    
  
    <div class="desc"><p>The argument is a list: the first item in the list is the "ticks"
parameter, the others are the tracks. Each track is a list
of score-events, and each event is itself a list.  A score-event
is similar to an opus-event (see above), except that in a score:
 1) the times are expressed as an absolute number of ticks
    from the track's start time
 2) the pairs of 'note_on' and 'note_off' events in an "opus"
    are abstracted into a single 'note' event in a "score":
    ['note', start_time, duration, channel, pitch, velocity]
score2opus() returns a list specifying the equivalent "opus".</p>
<p>my_score = [
    96,
    [   # track 0:
        ['patch_change', 0, 1, 8],
        ['note', 5, 96, 1, 25, 96],
        ['note', 101, 96, 1, 29, 96]
    ],   # end of track 0
]
my_opus = score2opus(my_score)</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-tegridymidi.legacy.MIDI.score2opus', this);">Show source &equiv;</a></p>
  <div id="source-tegridymidi.legacy.MIDI.score2opus" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">score2opus</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">The argument is a list: the first item in the list is the &quot;ticks&quot;</span>
<span class="sd">parameter, the others are the tracks. Each track is a list</span>
<span class="sd">of score-events, and each event is itself a list.  A score-event</span>
<span class="sd">is similar to an opus-event (see above), except that in a score:</span>
<span class="sd"> 1) the times are expressed as an absolute number of ticks</span>
<span class="sd">    from the track&#39;s start time</span>
<span class="sd"> 2) the pairs of &#39;note_on&#39; and &#39;note_off&#39; events in an &quot;opus&quot;</span>
<span class="sd">    are abstracted into a single &#39;note&#39; event in a &quot;score&quot;:</span>
<span class="sd">    [&#39;note&#39;, start_time, duration, channel, pitch, velocity]</span>
<span class="sd">score2opus() returns a list specifying the equivalent &quot;opus&quot;.</span>

<span class="sd">my_score = [</span>
<span class="sd">    96,</span>
<span class="sd">    [   # track 0:</span>
<span class="sd">        [&#39;patch_change&#39;, 0, 1, 8],</span>
<span class="sd">        [&#39;note&#39;, 5, 96, 1, 25, 96],</span>
<span class="sd">        [&#39;note&#39;, 101, 96, 1, 29, 96]</span>
<span class="sd">    ],   # end of track 0</span>
<span class="sd">]</span>
<span class="sd">my_opus = score2opus(my_score)</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">score</span><span class="o">=</span><span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="p">[],]</span>
    <span class="n">tracks</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
    <span class="n">ticks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tracks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">opus_tracks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">scoretrack</span> <span class="ow">in</span> <span class="n">tracks</span><span class="p">:</span>
        <span class="n">time2events</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">scoreevent</span> <span class="ow">in</span> <span class="n">scoretrack</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scoreevent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note&#39;</span><span class="p">:</span>
                <span class="n">note_on_event</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;note_on&#39;</span><span class="p">,</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                 <span class="n">scoreevent</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span>
                <span class="n">note_off_event</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;note_off&#39;</span><span class="p">,</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                 <span class="n">scoreevent</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">time2events</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">note_on_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                   <span class="n">time2events</span><span class="p">[</span><span class="n">note_on_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">note_on_event</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                   <span class="n">time2events</span><span class="p">[</span><span class="n">note_on_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">note_on_event</span><span class="p">,]</span>
                <span class="k">if</span> <span class="n">time2events</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">note_off_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                   <span class="n">time2events</span><span class="p">[</span><span class="n">note_off_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">note_off_event</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                   <span class="n">time2events</span><span class="p">[</span><span class="n">note_off_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">note_off_event</span><span class="p">,]</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">time2events</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
               <span class="n">time2events</span><span class="p">[</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scoreevent</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
               <span class="n">time2events</span><span class="p">[</span><span class="n">scoreevent</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">scoreevent</span><span class="p">,]</span>

        <span class="n">sorted_times</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of keys</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">time2events</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">sorted_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">sorted_times</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="n">sorted_events</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># once-flattened list of values sorted by key</span>
        <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">sorted_times</span><span class="p">:</span>
            <span class="n">sorted_events</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">time2events</span><span class="p">[</span><span class="n">time</span><span class="p">])</span>

        <span class="n">abs_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">sorted_events</span><span class="p">:</span>  <span class="c1"># convert abs times =&gt; delta times</span>
            <span class="n">delta_time</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">abs_time</span>
            <span class="n">abs_time</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">delta_time</span>
        <span class="n">opus_tracks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sorted_events</span><span class="p">)</span>
    <span class="n">opus_tracks</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ticks</span><span class="p">)</span>
    <span class="n">_clean_up_warnings</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">opus_tracks</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="tegridymidi.legacy.MIDI.score2stats">
    <p>def <span class="ident">score2stats</span>(</p><p>opus_or_score=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Returns a dict of some basic stats about the score, like
bank_select (list of tuples (msb,lsb)),
channels_by_track (list of lists), channels_total (set),
general_midi_mode (list),
ntracks, nticks, patch_changes_by_track (list of dicts),
num_notes_by_channel (list of numbers),
patch_changes_total (set),
percussion (dict histogram of channel 9 events),
pitches (dict histogram of pitches on channels other than 9),
pitch_range_by_track (list, by track, of two-member-tuples),
pitch_range_sum (sum over tracks of the pitch_ranges),</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-tegridymidi.legacy.MIDI.score2stats', this);">Show source &equiv;</a></p>
  <div id="source-tegridymidi.legacy.MIDI.score2stats" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">score2stats</span><span class="p">(</span><span class="n">opus_or_score</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Returns a dict of some basic stats about the score, like</span>
<span class="sd">bank_select (list of tuples (msb,lsb)),</span>
<span class="sd">channels_by_track (list of lists), channels_total (set),</span>
<span class="sd">general_midi_mode (list),</span>
<span class="sd">ntracks, nticks, patch_changes_by_track (list of dicts),</span>
<span class="sd">num_notes_by_channel (list of numbers),</span>
<span class="sd">patch_changes_total (set),</span>
<span class="sd">percussion (dict histogram of channel 9 events),</span>
<span class="sd">pitches (dict histogram of pitches on channels other than 9),</span>
<span class="sd">pitch_range_by_track (list, by track, of two-member-tuples),</span>
<span class="sd">pitch_range_sum (sum over tracks of the pitch_ranges),</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="n">bank_select_msb</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">bank_select_lsb</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">bank_select</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">channels_by_track</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">channels_total</span>    <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
    <span class="n">general_midi_mode</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">num_notes_by_channel</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([])</span>
    <span class="n">patches_used_by_track</span>  <span class="o">=</span> <span class="p">[]</span>
    <span class="n">patches_used_total</span>     <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
    <span class="n">patch_changes_by_track</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">patch_changes_total</span>    <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
    <span class="n">percussion</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([])</span> <span class="c1"># histogram of channel 9 &quot;pitches&quot;</span>
    <span class="n">pitches</span>    <span class="o">=</span> <span class="nb">dict</span><span class="p">([])</span> <span class="c1"># histogram of pitch-occurrences channels 0-8,10-15</span>
    <span class="n">pitch_range_sum</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># u pitch-ranges of each track</span>
    <span class="n">pitch_range_by_track</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">is_a_score</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">opus_or_score</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;bank_select&#39;</span><span class="p">:[],</span> <span class="s1">&#39;channels_by_track&#39;</span><span class="p">:[],</span> <span class="s1">&#39;channels_total&#39;</span><span class="p">:[],</span>
         <span class="s1">&#39;general_midi_mode&#39;</span><span class="p">:[],</span> <span class="s1">&#39;ntracks&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;nticks&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
         <span class="s1">&#39;num_notes_by_channel&#39;</span><span class="p">:</span><span class="nb">dict</span><span class="p">([]),</span>
         <span class="s1">&#39;patch_changes_by_track&#39;</span><span class="p">:[],</span> <span class="s1">&#39;patch_changes_total&#39;</span><span class="p">:[],</span>
         <span class="s1">&#39;percussion&#39;</span><span class="p">:{},</span> <span class="s1">&#39;pitches&#39;</span><span class="p">:{},</span> <span class="s1">&#39;pitch_range_by_track&#39;</span><span class="p">:[],</span>
         <span class="s1">&#39;ticks_per_quarter&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;pitch_range_sum&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
    <span class="n">ticks_per_quarter</span> <span class="o">=</span> <span class="n">opus_or_score</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># ignore first element, which is ticks</span>
    <span class="n">nticks</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">opus_or_score</span><span class="p">):</span>
        <span class="n">highest_pitch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">lowest_pitch</span> <span class="o">=</span> <span class="mi">128</span>
        <span class="n">channels_this_track</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="n">patch_changes_this_track</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({})</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">opus_or_score</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note&#39;</span><span class="p">:</span>
                <span class="n">num_notes_by_channel</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="n">num_notes_by_channel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
                    <span class="n">percussion</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span> <span class="o">=</span> <span class="n">percussion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pitches</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span>    <span class="o">=</span> <span class="n">pitches</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">highest_pitch</span><span class="p">:</span>
                        <span class="n">highest_pitch</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lowest_pitch</span><span class="p">:</span>
                        <span class="n">lowest_pitch</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">channels_this_track</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">channels_total</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">finish_time</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">finish_time</span> <span class="o">&gt;</span> <span class="n">nticks</span><span class="p">:</span>
                    <span class="n">nticks</span> <span class="o">=</span> <span class="n">finish_time</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note_off&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note_on&#39;</span> <span class="ow">and</span> <span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>  <span class="c1"># 4.8</span>
                <span class="n">finish_time</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">finish_time</span> <span class="o">&gt;</span> <span class="n">nticks</span><span class="p">:</span>
                    <span class="n">nticks</span> <span class="o">=</span> <span class="n">finish_time</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note_on&#39;</span><span class="p">:</span>
                <span class="n">is_a_score</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">num_notes_by_channel</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">num_notes_by_channel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
                    <span class="n">percussion</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="n">percussion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pitches</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>    <span class="o">=</span> <span class="n">pitches</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">highest_pitch</span><span class="p">:</span>
                        <span class="n">highest_pitch</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lowest_pitch</span><span class="p">:</span>
                        <span class="n">lowest_pitch</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">channels_this_track</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">channels_total</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;patch_change&#39;</span><span class="p">:</span>
                <span class="n">patch_changes_this_track</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">patch_changes_total</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control_change&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># bank select MSB</span>
                    <span class="n">bank_select_msb</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">32</span><span class="p">:</span>  <span class="c1"># bank select LSB</span>
                    <span class="n">bank_select_lsb</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">bank_select_msb</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">bank_select_lsb</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">bank_select</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">bank_select_msb</span><span class="p">,</span><span class="n">bank_select_lsb</span><span class="p">))</span>
                    <span class="n">bank_select_msb</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">bank_select_lsb</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;sysex_f0&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_sysex2midimode</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">general_midi_mode</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_sysex2midimode</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">is_a_score</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">nticks</span><span class="p">:</span>
                    <span class="n">nticks</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nticks</span> <span class="o">+=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">lowest_pitch</span> <span class="o">==</span> <span class="mi">128</span><span class="p">:</span>
            <span class="n">lowest_pitch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">channels_by_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">channels_this_track</span><span class="p">)</span>
        <span class="n">patch_changes_by_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">patch_changes_this_track</span><span class="p">)</span>
        <span class="n">pitch_range_by_track</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">lowest_pitch</span><span class="p">,</span><span class="n">highest_pitch</span><span class="p">))</span>
        <span class="n">pitch_range_sum</span> <span class="o">+=</span> <span class="p">(</span><span class="n">highest_pitch</span><span class="o">-</span><span class="n">lowest_pitch</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;bank_select&#39;</span><span class="p">:</span><span class="n">bank_select</span><span class="p">,</span>
            <span class="s1">&#39;channels_by_track&#39;</span><span class="p">:</span><span class="n">channels_by_track</span><span class="p">,</span>
            <span class="s1">&#39;channels_total&#39;</span><span class="p">:</span><span class="n">channels_total</span><span class="p">,</span>
            <span class="s1">&#39;general_midi_mode&#39;</span><span class="p">:</span><span class="n">general_midi_mode</span><span class="p">,</span>
            <span class="s1">&#39;ntracks&#39;</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">opus_or_score</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;nticks&#39;</span><span class="p">:</span><span class="n">nticks</span><span class="p">,</span>
            <span class="s1">&#39;num_notes_by_channel&#39;</span><span class="p">:</span><span class="n">num_notes_by_channel</span><span class="p">,</span>
            <span class="s1">&#39;patch_changes_by_track&#39;</span><span class="p">:</span><span class="n">patch_changes_by_track</span><span class="p">,</span>
            <span class="s1">&#39;patch_changes_total&#39;</span><span class="p">:</span><span class="n">patch_changes_total</span><span class="p">,</span>
            <span class="s1">&#39;percussion&#39;</span><span class="p">:</span><span class="n">percussion</span><span class="p">,</span>
            <span class="s1">&#39;pitches&#39;</span><span class="p">:</span><span class="n">pitches</span><span class="p">,</span>
            <span class="s1">&#39;pitch_range_by_track&#39;</span><span class="p">:</span><span class="n">pitch_range_by_track</span><span class="p">,</span>
            <span class="s1">&#39;pitch_range_sum&#39;</span><span class="p">:</span><span class="n">pitch_range_sum</span><span class="p">,</span>
            <span class="s1">&#39;ticks_per_quarter&#39;</span><span class="p">:</span><span class="n">ticks_per_quarter</span><span class="p">}</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="tegridymidi.legacy.MIDI.score_type">
    <p>def <span class="ident">score_type</span>(</p><p>opus_or_score=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Returns a string, either 'opus' or 'score' or ''</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-tegridymidi.legacy.MIDI.score_type', this);">Show source &equiv;</a></p>
  <div id="source-tegridymidi.legacy.MIDI.score_type" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">score_type</span><span class="p">(</span><span class="n">opus_or_score</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Returns a string, either &#39;opus&#39; or &#39;score&#39; or &#39;&#39;</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">opus_or_score</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">opus_or_score</span><span class="p">))</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">opus_or_score</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># ignore first element</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">opus_or_score</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">opus_or_score</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;score&#39;</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note_on&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;opus&#39;</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="tegridymidi.legacy.MIDI.segment">
    <p>def <span class="ident">segment</span>(</p><p>score=None, start_time=None, end_time=None, start=0, end=100000000, tracks={0, 1, 2, 3, 4, 5, 6, 7, 8, 10, 11, 12, 13, 14, 15})</p>
    </div>
    

    
  
    <div class="desc"><p>Returns a "score" which is a segment of the one supplied
as the argument, beginning at "start_time" ticks and ending
at "end_time" ticks (or at the end if "end_time" is not supplied).
If the set "tracks" is specified, only those tracks will
be returned.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-tegridymidi.legacy.MIDI.segment', this);">Show source &equiv;</a></p>
  <div id="source-tegridymidi.legacy.MIDI.segment" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">segment</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="mi">100000000</span><span class="p">,</span>
 <span class="n">tracks</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">}):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Returns a &quot;score&quot; which is a segment of the one supplied</span>
<span class="sd">as the argument, beginning at &quot;start_time&quot; ticks and ending</span>
<span class="sd">at &quot;end_time&quot; ticks (or at the end if &quot;end_time&quot; is not supplied).</span>
<span class="sd">If the set &quot;tracks&quot; is specified, only those tracks will</span>
<span class="sd">be returned.</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">score</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="p">[],]</span>
    <span class="k">if</span> <span class="n">start_time</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># as of 4.2 start_time is recommended</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">start</span>  <span class="c1"># start is legacy usage</span>
    <span class="k">if</span> <span class="n">end_time</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>    <span class="c1"># likewise</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">end</span>
    <span class="n">new_score</span> <span class="o">=</span> <span class="p">[</span><span class="n">score</span><span class="p">[</span><span class="mi">0</span><span class="p">],]</span>
    <span class="n">my_type</span> <span class="o">=</span> <span class="n">score_type</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">my_type</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">new_score</span>
    <span class="k">if</span> <span class="n">my_type</span> <span class="o">==</span> <span class="s1">&#39;opus&#39;</span><span class="p">:</span>
        <span class="c1"># more difficult (disconnecting note_on&#39;s from their note_off&#39;s)...</span>
        <span class="n">_warn</span><span class="p">(</span><span class="s2">&quot;segment: opus format is not supported</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">_clean_up_warnings</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">new_score</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># ignore first element (ticks); we count in ticks anyway</span>
    <span class="n">tracks</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">tracks</span><span class="p">)</span>  <span class="c1"># defend against tuples and lists</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tracks</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tracks</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="n">new_track</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">channel2cc_num</span>  <span class="o">=</span> <span class="p">{}</span>     <span class="c1"># most recent controller change before start</span>
        <span class="n">channel2cc_val</span>  <span class="o">=</span> <span class="p">{}</span>
        <span class="n">channel2cc_time</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">channel2patch_num</span>  <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># keep most recent patch change before start</span>
        <span class="n">channel2patch_time</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">set_tempo_num</span>  <span class="o">=</span> <span class="mi">500000</span> <span class="c1"># most recent tempo change before start 6.3</span>
        <span class="n">set_tempo_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">earliest_note_time</span> <span class="o">=</span> <span class="n">end_time</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;control_change&#39;</span><span class="p">:</span>  <span class="c1"># 6.5</span>
                <span class="n">cc_time</span> <span class="o">=</span> <span class="n">channel2cc_time</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">start_time</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">cc_time</span><span class="p">):</span>
                    <span class="n">channel2cc_num</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>  <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">channel2cc_val</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>  <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                    <span class="n">channel2cc_time</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;patch_change&#39;</span><span class="p">:</span>
                <span class="n">patch_time</span> <span class="o">=</span> <span class="n">channel2patch_time</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">start_time</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">patch_time</span><span class="p">):</span>  <span class="c1"># 2.0</span>
                    <span class="n">channel2patch_num</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>  <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">channel2patch_time</span><span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;set_tempo&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">start_time</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">set_tempo_time</span><span class="p">):</span> <span class="c1">#6.4</span>
                    <span class="n">set_tempo_num</span>  <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">set_tempo_time</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">start_time</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">end_time</span><span class="p">):</span>
                <span class="n">new_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">earliest_note_time</span><span class="p">):</span>
                    <span class="n">earliest_note_time</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_track</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">new_track</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;set_tempo&#39;</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">set_tempo_num</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">channel2patch_num</span><span class="p">:</span>
                <span class="n">new_track</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;patch_change&#39;</span><span class="p">,</span><span class="n">start_time</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">channel2patch_num</span><span class="p">[</span><span class="n">c</span><span class="p">]],)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">channel2cc_num</span><span class="p">:</span>   <span class="c1"># 6.5</span>
                <span class="n">new_track</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;control_change&#39;</span><span class="p">,</span><span class="n">start_time</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">channel2cc_num</span><span class="p">[</span><span class="n">c</span><span class="p">],</span><span class="n">channel2cc_val</span><span class="p">[</span><span class="n">c</span><span class="p">]])</span>
            <span class="n">new_score</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_track</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">_clean_up_warnings</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">new_score</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="tegridymidi.legacy.MIDI.timeshift">
    <p>def <span class="ident">timeshift</span>(</p><p>score=None, shift=None, start_time=None, from_time=0, tracks={0, 1, 2, 3, 4, 5, 6, 7, 8, 10, 12, 13, 14, 15})</p>
    </div>
    

    
  
    <div class="desc"><p>Returns a "score" shifted in time by "shift" ticks, or shifted
so that the first event starts at "start_time" ticks.</p>
<p>If "from_time" is specified, only those events in the score
that begin after it are shifted. If "start_time" is less than
"from_time" (or "shift" is negative), then the intermediate
notes are deleted, though patch-change events are preserved.</p>
<p>If "tracks" are specified, then only those tracks get shifted.
"tracks" can be a list, tuple or set; it gets converted to set
internally.</p>
<p>It is deprecated to specify both "shift" and "start_time".
If this does happen, timeshift() will print a warning to
stderr and ignore the "shift" argument.</p>
<p>If "shift" is negative and sufficiently large that it would
leave some event with a negative tick-value, then the score
is shifted so that the first event occurs at time 0. This
also occurs if "start_time" is negative, and is also the
default if neither "shift" nor "start_time" are specified.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-tegridymidi.legacy.MIDI.timeshift', this);">Show source &equiv;</a></p>
  <div id="source-tegridymidi.legacy.MIDI.timeshift" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">timeshift</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">from_time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tracks</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">}):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Returns a &quot;score&quot; shifted in time by &quot;shift&quot; ticks, or shifted</span>
<span class="sd">so that the first event starts at &quot;start_time&quot; ticks.</span>

<span class="sd">If &quot;from_time&quot; is specified, only those events in the score</span>
<span class="sd">that begin after it are shifted. If &quot;start_time&quot; is less than</span>
<span class="sd">&quot;from_time&quot; (or &quot;shift&quot; is negative), then the intermediate</span>
<span class="sd">notes are deleted, though patch-change events are preserved.</span>

<span class="sd">If &quot;tracks&quot; are specified, then only those tracks get shifted.</span>
<span class="sd">&quot;tracks&quot; can be a list, tuple or set; it gets converted to set</span>
<span class="sd">internally.</span>

<span class="sd">It is deprecated to specify both &quot;shift&quot; and &quot;start_time&quot;.</span>
<span class="sd">If this does happen, timeshift() will print a warning to</span>
<span class="sd">stderr and ignore the &quot;shift&quot; argument.</span>

<span class="sd">If &quot;shift&quot; is negative and sufficiently large that it would</span>
<span class="sd">leave some event with a negative tick-value, then the score</span>
<span class="sd">is shifted so that the first event occurs at time 0. This</span>
<span class="sd">also occurs if &quot;start_time&quot; is negative, and is also the</span>
<span class="sd">default if neither &quot;shift&quot; nor &quot;start_time&quot; are specified.</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="c1">#_warn(&#39;tracks=&#39;+str(tracks))</span>
    <span class="k">if</span> <span class="n">score</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="p">[],]</span>
    <span class="n">new_score</span> <span class="o">=</span> <span class="p">[</span><span class="n">score</span><span class="p">[</span><span class="mi">0</span><span class="p">],]</span>
    <span class="n">my_type</span> <span class="o">=</span> <span class="n">score_type</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">my_type</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">new_score</span>
    <span class="k">if</span> <span class="n">my_type</span> <span class="o">==</span> <span class="s1">&#39;opus&#39;</span><span class="p">:</span>
        <span class="n">_warn</span><span class="p">(</span><span class="s2">&quot;timeshift: opus format is not supported</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># _clean_up_scores()  6.2; doesn&#39;t exist! what was it supposed to do?</span>
        <span class="k">return</span> <span class="n">new_score</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">shift</span> <span class="o">==</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">start_time</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">_warn</span><span class="p">(</span><span class="s2">&quot;timeshift: shift and start_time specified: ignoring shift</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">shift</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">start_time</span> <span class="o">==</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">start_time</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># shift = start_time - from_time</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># ignore first element (ticks)</span>
    <span class="n">tracks</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">tracks</span><span class="p">)</span>  <span class="c1"># defend against tuples and lists</span>
    <span class="n">earliest</span> <span class="o">=</span> <span class="mi">1000000000</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">start_time</span> <span class="o">==</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">shift</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># first find the earliest event</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tracks</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tracks</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                 <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">from_time</span><span class="p">:</span>
                     <span class="k">continue</span>  <span class="c1"># just inspect the to_be_shifted events</span>
                 <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">earliest</span><span class="p">:</span>
                     <span class="n">earliest</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">earliest</span> <span class="o">&gt;</span> <span class="mi">999999999</span><span class="p">:</span>
        <span class="n">earliest</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">shift</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">start_time</span> <span class="o">-</span> <span class="n">earliest</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">earliest</span> <span class="o">+</span> <span class="n">shift</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">-</span> <span class="n">earliest</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># ignore first element (ticks)</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tracks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tracks</span><span class="p">):</span>  <span class="c1"># 3.8</span>
            <span class="n">new_score</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="n">new_track</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">new_event</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="c1">#if new_event[1] == 0 and shift &gt; 0 and new_event[0] != &#39;note&#39;:</span>
            <span class="c1">#    pass</span>
            <span class="c1">#elif new_event[1] &gt;= from_time:</span>
            <span class="k">if</span> <span class="n">new_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">from_time</span><span class="p">:</span>
                <span class="c1"># 4.1 must not rightshift set_tempo</span>
                <span class="k">if</span> <span class="n">new_event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;set_tempo&#39;</span> <span class="ow">or</span> <span class="n">shift</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">new_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">shift</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">shift</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">new_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">from_time</span><span class="o">+</span><span class="n">shift</span><span class="p">)):</span>
                <span class="k">continue</span>
            <span class="n">new_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_event</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_track</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">new_score</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_track</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">_clean_up_warnings</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">new_score</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="tegridymidi.legacy.MIDI.to_millisecs">
    <p>def <span class="ident">to_millisecs</span>(</p><p>old_opus=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Recallibrates all the times in an "opus" to use one beat
per second and one tick per millisecond.  This makes it
hard to retrieve any information about beats or barlines,
but it does make it easy to mix different scores together.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-tegridymidi.legacy.MIDI.to_millisecs', this);">Show source &equiv;</a></p>
  <div id="source-tegridymidi.legacy.MIDI.to_millisecs" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">to_millisecs</span><span class="p">(</span><span class="n">old_opus</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;Recallibrates all the times in an &quot;opus&quot; to use one beat</span>
<span class="sd">per second and one tick per millisecond.  This makes it</span>
<span class="sd">hard to retrieve any information about beats or barlines,</span>
<span class="sd">but it does make it easy to mix different scores together.</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">old_opus</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,[],]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">old_tpq</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">old_opus</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>   <span class="c1"># 5.0</span>
        <span class="n">_warn</span><span class="p">(</span><span class="s1">&#39;to_millisecs: the opus &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">old_opus</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; has no elements&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,[],]</span>
    <span class="n">new_opus</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,]</span>
    <span class="c1"># 6.7 first go through building a table of set_tempos by absolute-tick</span>
    <span class="n">ticks2tempo</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">itrack</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">itrack</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_opus</span><span class="p">):</span>
        <span class="n">ticks_so_far</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">old_event</span> <span class="ow">in</span> <span class="n">old_opus</span><span class="p">[</span><span class="n">itrack</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">old_event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;note&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;to_millisecs needs an opus, not a score&#39;</span><span class="p">)</span>
            <span class="n">ticks_so_far</span> <span class="o">+=</span> <span class="n">old_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">old_event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;set_tempo&#39;</span><span class="p">:</span>
                <span class="n">ticks2tempo</span><span class="p">[</span><span class="n">ticks_so_far</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">itrack</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1"># then get the sorted-array of their keys</span>
    <span class="n">tempo_ticks</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of keys</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ticks2tempo</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">tempo_ticks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="n">tempo_ticks</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="c1"># then go through converting to millisec, testing if the next</span>
    <span class="c1"># set_tempo lies before the next track-event, and using it if so.</span>
    <span class="n">itrack</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">itrack</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_opus</span><span class="p">):</span>
        <span class="n">ms_per_old_tick</span> <span class="o">=</span> <span class="mf">500.0</span> <span class="o">/</span> <span class="n">old_tpq</span>  <span class="c1"># float: will round later 6.3</span>
        <span class="n">i_tempo_ticks</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ticks_so_far</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ms_so_far</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">previous_ms_so_far</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">new_track</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;set_tempo&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1000000</span><span class="p">],]</span>  <span class="c1"># new &quot;crochet&quot; is 1 sec</span>
        <span class="k">for</span> <span class="n">old_event</span> <span class="ow">in</span> <span class="n">old_opus</span><span class="p">[</span><span class="n">itrack</span><span class="p">]:</span>
            <span class="c1"># detect if ticks2tempo has something before this event</span>
            <span class="c1"># 20160702 if ticks2tempo is at the same time, leave it</span>
            <span class="n">event_delta_ticks</span> <span class="o">=</span> <span class="n">old_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i_tempo_ticks</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tempo_ticks</span><span class="p">)</span> <span class="ow">and</span>
              <span class="n">tempo_ticks</span><span class="p">[</span><span class="n">i_tempo_ticks</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ticks_so_far</span> <span class="o">+</span> <span class="n">old_event</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
                <span class="n">delta_ticks</span> <span class="o">=</span> <span class="n">tempo_ticks</span><span class="p">[</span><span class="n">i_tempo_ticks</span><span class="p">]</span> <span class="o">-</span> <span class="n">ticks_so_far</span>
                <span class="n">ms_so_far</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ms_per_old_tick</span> <span class="o">*</span> <span class="n">delta_ticks</span><span class="p">)</span>
                <span class="n">ticks_so_far</span> <span class="o">=</span> <span class="n">tempo_ticks</span><span class="p">[</span><span class="n">i_tempo_ticks</span><span class="p">]</span>
                <span class="n">ms_per_old_tick</span> <span class="o">=</span> <span class="n">ticks2tempo</span><span class="p">[</span><span class="n">ticks_so_far</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1000.0</span><span class="o">*</span><span class="n">old_tpq</span><span class="p">)</span>
                <span class="n">i_tempo_ticks</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">event_delta_ticks</span> <span class="o">-=</span> <span class="n">delta_ticks</span>
            <span class="n">new_event</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">old_event</span><span class="p">)</span>  <span class="c1"># now handle the new event</span>
            <span class="n">ms_so_far</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ms_per_old_tick</span> <span class="o">*</span> <span class="n">old_event</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">new_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">ms_so_far</span> <span class="o">-</span> <span class="n">previous_ms_so_far</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">old_event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;set_tempo&#39;</span><span class="p">:</span>
                <span class="n">previous_ms_so_far</span> <span class="o">=</span> <span class="n">ms_so_far</span>
                <span class="n">new_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_event</span><span class="p">)</span>
            <span class="n">ticks_so_far</span> <span class="o">+=</span> <span class="n">event_delta_ticks</span>
        <span class="n">new_opus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_track</span><span class="p">)</span>
        <span class="n">itrack</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">_clean_up_warnings</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">new_opus</span>
</pre></div>

  </div>
</div>

  </div>
  


  </section>
</article>
  <div class="clear"> </div>
  <footer id="footer">
    <p>
      Generated by <a href="https://github.com/timothycrosley/pdocs">pdocs 1.2.0</a>
    </p>
  </footer>
</div>
</body>
</html>